
<!DOCTYPE html>
<html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financiero v10.0 PRO - PESIFICADO [COMPLETO]</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // ConfiguraciÃ³n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3sx4Z_E7gaFho1jjPBJy3ShcxY7Rra8U",
            authDomain: "finanzas-48a47.firebaseapp.com",
            projectId: "finanzas-48a47",
            storageBucket: "finanzas-48a47.firebasestorage.app",
            messagingSenderId: "44256211188",
            appId: "1:44256211188:web:b5bd5329e58a92c867aea1"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let firebaseActivo = true;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px; min-height: 100vh; }
        
        /* ============ ESTILOS LOGIN Y USUARIOS ============ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .login-box h2 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            border: none;
            display: block;
        }
        .login-box .logo {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        .login-box input {
            margin: 10px 0;
            padding: 15px;
            font-size: 16px;
        }
        .login-box .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-top: 15px;
        }
        .login-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        .user-badge {
            position: absolute;
            top: 15px;
            right: 70px;
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        .user-badge:hover {
            background: #5a6fd6;
        }
        .permiso-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
        }
        .permiso-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.3);
        }
        .permiso-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }
        .usuario-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .usuario-card.admin {
            border-left-color: #ffc107;
        }
        .usuario-card h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .usuario-card .rol-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #667eea;
            color: white;
        }
        .usuario-card .rol-badge.admin {
            background: #ffc107;
            color: #333;
        }
        .permisos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        body.dark { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark .section, body.dark .tab-content, body.dark .header { background: #0f3460; color: #e0e0e0; }
        body.dark th { background: #144272; }
        body.dark input, body.dark select { background: #144272; color: white; border-color: #2e5c8a; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); position: relative; }
        .header h1 { background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem; }
        .dolar-badge { position: absolute; top: 15px; left: 20px; background: #28a745; color: white; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .dark-toggle { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; }
        .tabs { display: flex; background: white; border-radius: 15px; margin-bottom: 15px; overflow-x: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .tab { flex: 1; min-width: 70px; background: #f8f9fa; border: none; padding: 10px 6px; cursor: pointer; font-size: 10px; transition: all 0.3s; text-align: center; font-weight: 500; }
        .tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .tab:hover { background: #e9ecef; }
        .tab.active:hover { background: linear-gradient(135deg, #667eea, #764ba2); }
        .tab-content { display: none; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 10px 0; border-left: 4px solid #667eea; }
        h2 { color: #333; margin-bottom: 15px; border-bottom: 3px solid #667eea; padding-bottom: 8px; display: inline-block; font-size: 1.5rem; }
        h3 { color: #555; margin: 10px 0 8px 0; font-size: 1.1rem; }
        h4 { color: #666; margin: 8px 0; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        textarea { min-height: 80px; resize: vertical; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 500; transition: all 0.3s; font-size: 13px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #ff9800); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-fijo { background: #6f42c1; color: white; }
        .badge-variable { background: #17a2b8; color: white; }
        .badge-info { background: #17a2b8; color: white; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .grid-5 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card-value { font-size: 1.5rem; font-weight: bold; }
        .card-label { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; background: white; border-radius: 8px; overflow: hidden; font-size: 13px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }
        tr:hover { background: #f8f9fa; }
        .alert { padding: 12px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; font-size: 13px; }
        .alert-success { background: #d4edda; color: #155724; border-color: #28a745; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffc107; }
        .alert-danger { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .chart-container { position: relative; height: 350px; margin: 15px 0; background: white; padding: 15px; border-radius: 12px; }
        .chart-small { height: 250px; }
        .notif { position: fixed; top: 20px; right: 20px; max-width: 350px; z-index: 9999; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .cuenta-item { background: white; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center; }
        .cuenta-item.vencido { border-left-color: #dc3545; background: #fff5f5; }
        .cuenta-item.proximo { border-left-color: #ffc107; background: #fff9e6; }
        .item-card { background: white; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #667eea; }
        .progress-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #28a745, #20c997); transition: width 0.3s; }
        .estado-resultados-row { display: grid; grid-template-columns: 3fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .estado-resultados-row.header { background: #667eea; color: white; border-radius: 8px; padding: 12px; border: none; }
        .estado-resultados-row.total { background: #f8f9fa; font-weight: bold; border-top: 2px solid #667eea; }
        .estado-resultados-row.subtotal { background: #f0f0f0; font-weight: 600; margin-left: 20px; }
        .estado-resultados-row.indent { margin-left: 30px; }
        .rentabilidad-kpi { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .rentabilidad-valor { font-size: 2rem; font-weight: bold; }
        .rentabilidad-label { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
        .rentabilidad-desc { font-size: 0.8rem; margin-top: 5px; line-height: 1.4; }
        
        /* ============ MEJORAS PARA MÃ“VIL ============ */
        
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header { padding: 15px 10px; border-radius: 10px; }
            .header h1 { font-size: 1.2rem; margin-top: 35px; }
            .header p { font-size: 11px; }
            .dolar-badge { top: 10px; left: 10px; padding: 6px 10px; font-size: 11px; }
            .dark-toggle { top: 10px; right: 10px; font-size: 20px; }
            
            /* Tabs en scroll horizontal */
            .tabs { 
                display: flex !important; 
                flex-wrap: nowrap !important; 
                overflow-x: auto !important; 
                -webkit-overflow-scrolling: touch;
                padding: 5px;
            }
            .tab { 
                min-width: auto !important;
                white-space: nowrap;
                font-size: 11px; 
                padding: 10px 8px;
            }
            
            /* Grids en mÃ³vil */
            .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; gap: 10px; }
            
            /* Cards mÃ¡s grandes */
            .card { padding: 18px; border-radius: 10px; }
            .card-value { font-size: 1.4rem; }
            .card-label { font-size: 0.9rem; }
            
            /* Inputs y botones tÃ¡ctiles */
            input, select, textarea { padding: 14px; font-size: 16px; border-radius: 10px; margin: 8px 0; }
            .btn { padding: 14px 20px; font-size: 15px; border-radius: 10px; margin: 6px 3px; }
            .btn-sm { padding: 12px 16px; font-size: 14px; }
            
            /* Tablas responsive */
            table { font-size: 12px; display: block; overflow-x: auto; white-space: nowrap; }
            th, td { padding: 12px 8px; }
            
            /* Secciones */
            .section { padding: 12px; border-radius: 10px; margin: 8px 0; }
            .tab-content { padding: 12px; border-radius: 10px; max-height: none; }
            
            /* Alertas */
            .alert { padding: 14px; font-size: 14px; border-radius: 10px; }
            
            /* TÃ­tulos */
            h2 { font-size: 1.3rem; }
            h3 { font-size: 1.05rem; }
            
            /* Chart containers */
            .chart-container { height: 280px; padding: 10px; }
            
            /* Notificaciones */
            .notif { max-width: 90%; right: 5%; left: 5%; }
            
            /* Badge perÃ­odo */
            .badge { padding: 6px 12px; font-size: 12px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1rem; }
            .card-value { font-size: 1.2rem; }
            .btn { width: 100%; margin: 5px 0; }
            .grid-4 button, .grid-3 button { width: 100%; }
        }
  </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginOverlay" class="login-overlay" style="display: none;">
        <div class="login-box">
            <div class="logo">ğŸ’°</div>
            <h2>Sistema Financiero v10.0</h2>
            <p style="color: #666; margin-bottom: 20px;">Ingresa tus credenciales para continuar</p>
            <input type="text" id="loginUsuario" placeholder="ğŸ‘¤ Usuario" onkeypress="if(event.key===&#39;Enter&#39;)intentarLogin()">
            <input type="password" id="loginPassword" placeholder="ğŸ”’ ContraseÃ±a" onkeypress="if(event.key===&#39;Enter&#39;)intentarLogin()">
            <button class="btn" onclick="intentarLogin()">ğŸ”“ Iniciar SesiÃ³n</button>
            <p id="loginError" class="login-error" style="display: none;">Usuario o contraseÃ±a incorrectos</p>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: block;">
        <div class="header">
            <div class="dolar-badge" id="dolarBadge" onclick="cambiarTab(&#39;configuracion&#39;)" style="cursor:pointer;" title="Click para actualizar">ğŸ’µ USD $<span id="tipoCambio">1.455</span></div>
            <div style="position: absolute; top: 15px; right: 60px; background: #17a2b8; color: white; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: bold;">â˜ï¸ Firebase</div>
            <div class="user-badge" id="userBadge" onclick="mostrarMenuUsuario()">ğŸ‘¤ <span id="nombreUsuarioActual">Administrador</span></div>
            <h1>ğŸ’° Sistema Financiero v10.0 PRO - COMPLETO</h1>
            <p style="color: #666; margin-top: 8px; font-size: 13px;">Todos los valores en Pesos Argentinos (ARS) - Sincronizado en la nube â˜ï¸</p>
            <div class="dark-toggle" onclick="toggleDark()" title="Modo Oscuro">ğŸŒ™</div>
        </div>
        <div id="notifs"></div>
        
        <div class="tabs" id="tabs"><button class="tab">ğŸ“ Carga</button><button class="tab">ğŸ“Š Dashboard</button><button class="tab">ğŸ’° Ingresos</button><button class="tab">ğŸ“ˆ Gastos</button><button class="tab">ğŸ“‹ Detalle</button><button class="tab">ğŸ›’ Compras</button><button class="tab">ğŸ‘¥ Clientes</button><button class="tab">ğŸ­ Proveed</button><button class="tab">âš–ï¸ P.Equilib</button><button class="tab">ğŸ¦ Cajas</button><button class="tab">ğŸ’± Movim</button><button class="tab">ğŸ”” Alertas</button><button class="tab">ğŸ“‰ GrÃ¡ficos</button><button class="tab">ğŸ”® Proyecc</button><button class="tab">ğŸ’¹ Cash Flow</button><button class="tab">ğŸ· Ahorros/IOL</button><button class="tab">ğŸ¤– IA</button><button class="tab">ğŸ‘” Personal</button><button class="tab">ğŸ“… Record</button><button class="tab">ğŸ“Š Est.Result</button><button class="tab">ğŸ’¹ Cash Flow</button><button class="tab">ğŸ“ˆ Rentabilidad</button><button class="tab">ğŸ“Š Comparativo</button><button class="tab">ğŸ’¾ Backup</button><button class="tab">ğŸ‘¥ Usuarios</button><button class="tab">âš™ï¸ Config</button></div>
        <div id="content">
                <div id="carga" class="tab-content">
                    <h2>ğŸ“ Carga de Datos</h2>
                    
                    <div class="section" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">
                        <h3 style="color: white; border-bottom: 3px solid white;">ğŸ“Š Estado Actual de Datos Cargados</h3>
                        <div id="estadoDatos" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ’° Registrar Ingreso Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="ingMonto" placeholder="Monto Bruto (USD)" step="0.01">
                            <input type="number" id="ingRetencion" placeholder="Retenciones (USD)" step="0.01" value="0">
                            <input type="date" id="ingFecha">
                            <input type="text" id="ingDesc" placeholder="DescripciÃ³n">
                            <select id="ingMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                            <select id="ingCategoria">
                                <option value="Ventas">Ventas</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Cobros">Cobros</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <button class="btn btn-success" onclick="registrarIngreso()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Ingresos desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con INGRESOS (montos en ARS)</b></p>
                        <div class="alert alert-info" style="margin-bottom:10px;">
                            <b>Columnas necesarias (en orden):</b><br>
                            â€¢ Columna A: <b>Fecha</b><br>
                            â€¢ Columna B: <b>Razon Social</b><br>
                            â€¢ Columna C: <b>Nombre Concepto</b><br>
                            â€¢ Columna D: <b>Total</b> (monto en ARS - se convertirÃ¡ a USD automÃ¡ticamente)
                        </div>
                        <input type="file" id="archivoIngresos" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-success" onclick="procesarArchivoIngresos()">ğŸ“¥ Cargar Ingresos</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploIngresos()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¤ Registrar Gasto Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="gastMonto" placeholder="Monto (USD)" step="0.01">
                            <input type="date" id="gastFecha">
                            <input type="text" id="gastDesc" placeholder="DescripciÃ³n">
                            <select id="gastMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                            <select id="gastCategoria">
                                <option value="Alquiler">Alquiler</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Sueldos">Sueldos</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <select id="gastTipo">
                                <option value="false">Gasto Fijo</option>
                                <option value="true">Gasto Variable</option>
                            </select>
                            <button class="btn btn-warning" onclick="registrarGasto()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Gastos desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con GASTOS (montos en ARS)</b></p>
                        <input type="file" id="archivoGastos" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-warning" onclick="procesarArchivoGastos()">ğŸ“¥ Cargar Gastos</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploGastos()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>

                    <div class="section">
                        <h3>ğŸ›’ Registrar Compra Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="compMonto" placeholder="Monto (USD)" step="0.01">
                            <input type="date" id="compFecha">
                            <input type="text" id="compDesc" placeholder="DescripciÃ³n">
                            <input type="text" id="compProv" placeholder="Proveedor">
                            <select id="compMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Cuenta Corriente">Cuenta Corriente</option>
                            </select>
                            <select id="compCategoria">
                                <option value="MercaderÃ­a">MercaderÃ­a</option>
                                <option value="Insumos">Insumos</option>
                                <option value="Materias Primas">Materias Primas</option>
                                <option value="Equipamiento">Equipamiento</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <button class="btn btn-info" onclick="registrarCompra()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Compras desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con COMPRAS (montos en ARS)</b></p>
                        <input type="file" id="archivoCompras" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-info" onclick="procesarArchivoCompras()">ğŸ“¥ Cargar Compras</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploCompras()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ“¤ Importar desde Excel/CSV (Carga Masiva Mixta)</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo con <b>INGRESOS, GASTOS y COMPRAS mezclados (montos en ARS)</b></p>
                        <input type="file" id="archivo" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-success" onclick="procesarArchivo()">ğŸ“¥ Procesar Archivo Mixto</button>
                        <button class="btn btn-info" onclick="descargarEjemplo()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo Excel</button>
                    </div>
                </div>

                <div id="dash" class="tab-content">
                    <h2>ğŸ“Š Dashboard Principal</h2>
                    <div id="panelDash">
                <div class="section">
                    <h3>ğŸ” Filtros por PerÃ­odo</h3>
                    
                    <div class="alert alert-info">
                        <b>ğŸ” Filtro activo:</b> 11/2025  
                        <button class="btn btn-sm btn-warning" onclick="limpiarFiltros()" style="margin-left: 10px;">âœ– Limpiar Filtro</button>
                    </div>
                
                    <div class="grid-4" style="margin-bottom: 15px;">
                        <div>
                            <label>AÃ±o:</label>
                            <select id="filtroAÃ±o">
                                <option value="">Seleccionar</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected="">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div>
                            <label>Mes:</label>
                            <select id="filtroMes">
                                <option value="">Todos</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label>Trimestre:</label>
                            <select id="filtroTrimestre">
                                <option value="">Todos</option>
                                <option value="1">Q1 (Ene-Mar)</option>
                                <option value="2">Q2 (Abr-Jun)</option>
                                <option value="3">Q3 (Jul-Sep)</option>
                                <option value="4">Q4 (Oct-Dic)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-info" onclick="aplicarFiltroRapido()" style="width: 100%;">ğŸ” Aplicar</button>
                        </div>
                    </div>
                </div>

                <div class="grid-4">
                    <div class="card"><div class="card-value">$19.063.832 ARS</div><div class="card-label">ğŸ’° Ingresos (Filtrados)</div></div>
                    <div class="card"><div class="card-value">$3.506.409 ARS</div><div class="card-label">ğŸ“¤ Gastos (Filtrados)</div></div>
                    <div class="card"><div class="card-value">$5.553.549 ARS</div><div class="card-label">ğŸ›’ Compras (Filtradas)</div></div>
                    <div class="card" style="background: linear-gradient(135deg, #28a745, #20c997);"><div class="card-value">$10.003.875 ARS</div><div class="card-label">ğŸ“Š Balance (Filtrado)</div></div>
                    <div class="card" style="background: linear-gradient(135deg, #17a2b8, #138496);"><div class="card-value">$8.634.902 ARS</div><div class="card-label">ğŸ¦ Total en Cajas</div></div>
                    <div class="card"><div class="card-value">$9.059.957 ARS</div><div class="card-label">ğŸ’¸ Egresos Totales</div></div>
                    <div class="card"><div class="card-value">$0 ARS</div><div class="card-label">ğŸ“¥ Por Cobrar</div></div>
                    <div class="card"><div class="card-value">$0 ARS</div><div class="card-label">ğŸ“¤ Por Pagar</div></div>
                </div>
            </div>
                </div>

                <div id="ingresos" class="tab-content">
                    <h2>ğŸ’° GestiÃ³n de Ingresos</h2>
                    <div id="listaIngresos"></div>
                </div>

                <div id="gastosFijos" class="tab-content">
                    <h2>ğŸ“ˆ Gastos Fijos y Variables</h2>
                    <div id="listaGastos"></div>
                </div>

                <div id="gastosDetalle" class="tab-content">
                    <h2>ğŸ“‹ Detalle de Gastos por Concepto</h2>
                    <div id="gastosDetalle"></div>
                </div>

                <div id="comprasView" class="tab-content">
                    <h2>ğŸ›’ GestiÃ³n de Compras</h2>
                    <div id="listaCompras"></div>
                </div>

                <div id="clientes" class="tab-content">
                    <h2>ğŸ‘¥ GestiÃ³n de Clientes</h2>
                    
                    <div class="section">
                        <h3>â• Agregar Cliente</h3>
                        <div class="alert alert-info">Ingresa la deuda inicial (si existe) en <b>Pesos Argentinos (ARS)</b></div>
                        <div class="grid-4">
                            <input type="text" id="cliNombre" placeholder="Nombre">
                            <input type="text" id="cliContacto" placeholder="TelÃ©fono">
                            <input type="text" id="cliEmail" placeholder="Email">
                            <input type="number" id="cliDeuda" placeholder="Deuda Inicial (ARS)" step="1000">
                            <button class="btn btn-success" onclick="agregarCliente()">âœ… Agregar</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ‘¥ Lista de Clientes</h3>
                        <div id="listaClientes"></div>
                    </div>
                </div>

                <div id="proveedores" class="tab-content">
                    <h2>ğŸ­ GestiÃ³n de Proveedores</h2>
                    
                    <div class="section">
                        <h3>â• Agregar Proveedor</h3>
                        <div class="alert alert-info">Ingresa la deuda inicial (si existe) en <b>Pesos Argentinos (ARS)</b></div>
                        <div class="grid-4">
                            <input type="text" id="provNombre" placeholder="Nombre">
                            <input type="text" id="provContacto" placeholder="TelÃ©fono">
                            <input type="text" id="provEmail" placeholder="Email">
                            <input type="number" id="provDeuda" placeholder="Deuda Inicial (ARS)" step="1000">
                            <button class="btn btn-success" onclick="agregarProveedor()">âœ… Agregar</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ­ Lista de Proveedores</h3>
                        <div id="listaProveedores"></div>
                    </div>
                </div>

                <div id="inversiones" class="tab-content">
                    <h2>ğŸ’¼ Inversiones IOL - Mi JubilaciÃ³n</h2>
                    <div id="panelInversiones"></div>
                </div>

                <div id="puntoEquilibrio" class="tab-content">
                    <h2>âš–ï¸ Punto de Equilibrio</h2>
                    <div id="panelPuntoEquilibrio"></div>
                </div>

                <div id="movimientos" class="tab-content">
                    <h2>ğŸ’± Movimientos de Fondos</h2>
                    <div id="listaMovimientos"><div class="section"><h3>â• Registrar Movimiento</h3><div class="alert alert-info">Ingresa los valores en <b>Pesos Argentinos (ARS)</b>. Selecciona el tipo de movimiento y las cajas involucradas.</div><div class="grid-4" style="margin-bottom: 15px;"><div>
                    <label style="font-weight: 600; color: #555;">Tipo de Movimiento:</label>
                    <select id="tipoMovimiento" onchange="toggleCajaDestino()">
                        <option value="ingreso">ğŸ“¥ Ingreso (entrada de dinero)</option>
                        <option value="egreso">ğŸ“¤ Egreso (salida de dinero)</option>
                        <option value="transferencia">ğŸ’± Transferencia entre cajas</option>
                    </select>
                </div><div>
                    <label style="font-weight: 600; color: #555;">Caja:</label>
                    <select id="cajaOrigen"><option value="0">COLCHON</option><option value="1">EFECTIVO</option><option value="2">CHEQUES</option><option value="3">ECHEQ</option><option value="4">BANCO NACION</option><option value="5">BANCO SANTANDER</option><option value="6">MP FERRETERIA</option><option value="7">MP MARISOL</option><option value="8">MP MAURI</option></select>
                </div><div id="cajaDestinoContainer" style="display: none;">
                    <label style="font-weight: 600; color: #555;">Caja Destino:</label>
                    <select id="cajaDestino"><option value="0">COLCHON</option><option value="1">EFECTIVO</option><option value="2">CHEQUES</option><option value="3">ECHEQ</option><option value="4">BANCO NACION</option><option value="5">BANCO SANTANDER</option><option value="6">MP FERRETERIA</option><option value="7">MP MARISOL</option><option value="8">MP MAURI</option></select>
                </div><div>
                    <label style="font-weight: 600; color: #555;">Monto (ARS):</label>
                    <input type="number" id="montoMovimiento" placeholder="Monto (ARS)" step="1000">
                </div></div><div class="grid-2" style="margin-bottom: 15px;"><div>
                    <label style="font-weight: 600; color: #555;">DescripciÃ³n (opcional):</label>
                    <input type="text" id="descripcionMovimiento" placeholder="Ej: Pago proveedor, Cobro cliente, etc.">
                </div><div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-success" onclick="agregarMovimientoFondos()" style="width: 100%;">âœ… Registrar Movimiento</button>
                </div></div></div><div class="section"><h3>ğŸ’° Saldos Actuales por Caja</h3><div class="card" style="margin-bottom: 15px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    <div class="card-value">$8.634.902 ARS</div>
                    <div class="card-label">ğŸ’¼ Total en Todas las Cajas</div>
                </div><div class="grid-4"><div class="card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="card-value">$1.050.000 ARS</div>
                        <div class="card-label">COLCHON</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                        <div class="card-value">$699.210 ARS</div>
                        <div class="card-label">EFECTIVO</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #00b4d8, #0096c7);">
                        <div class="card-value">$1.170.000 ARS</div>
                        <div class="card-label">CHEQUES</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                        <div class="card-value">$1.776.012 ARS</div>
                        <div class="card-label">ECHEQ</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #fd7e14, #e85d04);">
                        <div class="card-value">$226.860 ARS</div>
                        <div class="card-label">BANCO NACION</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                        <div class="card-value">$0 ARS</div>
                        <div class="card-label">BANCO SANTANDER</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #009688, #00796b);">
                        <div class="card-value">$811.463 ARS</div>
                        <div class="card-label">MP FERRETERIA</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #795548, #5d4037);">
                        <div class="card-value">$1.732.668 ARS</div>
                        <div class="card-label">MP MARISOL</div>
                    </div><div class="card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="card-value">$1.168.689 ARS</div>
                        <div class="card-label">MP MAURI</div>
                    </div></div></div><div class="section"><h3>ğŸ“‹ Historial de Movimientos</h3><table><tbody><tr><th>Fecha</th><th>Tipo</th><th>Caja</th><th>DescripciÃ³n</th><th>Monto (ARS)</th><th></th></tr><tr>
                        <td>29/11/2025</td>
                        <td><span style="color: #dc3545; font-weight: 600;">ğŸ“¤ ExtracciÃ³n</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td style="font-weight: 600;"><span style="color: #28a745;">+$120.000</span> ARS</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarMovimientoFondos(0)">ğŸ—‘ï¸</button></td>
                    </tr></tbody></table></div></div>
                </div>

                <div id="alertas" class="tab-content">
                    <h2>ğŸ”” Sistema de Alertas</h2>
                    <div id="panelAlertas"></div>
                </div>

                <div id="graficos" class="tab-content">
                    <h2>ğŸ“‰ GrÃ¡ficos y AnÃ¡lisis</h2>
                    <div id="panelGraficos"></div>
                </div>

                <div id="proyecciones" class="tab-content">
                    <h2>ğŸ”® Proyecciones Financieras</h2>
                    <div id="panelProyecciones"></div>
                </div>

                <div id="cashflow" class="tab-content">
                    <h2>ğŸ’¹ Cash Flow Anual</h2>
                    <div id="tablaCashFlow"></div>
                </div>

                <div id="ahorros" class="tab-content">
                    <h2>ğŸ· Plan de Ahorros</h2>
                    <div id="panelAhorros"></div>
                </div>

                <div id="cajas" class="tab-content active">
                    <h2>ğŸ¦ GestiÃ³n de Cajas - ColchÃ³n de Emergencia</h2>
                    <div id="panelCajas"><div style="display: inline-block; background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                ğŸ“… Noviembre 2025
            </div><div class="section"><h3>ğŸ’° GestiÃ³n de Cajas</h3><div class="card"><div class="card-value">$8.412.573 ARS</div><div class="card-label">ğŸ’¼ Total en Cajas</div></div><h4 style="margin-top: 20px;">â• Crear Nueva Caja</h4><div class="grid-4" style="margin-top: 10px;"><input type="text" id="cajaNombre" placeholder="Nombre (ej: Caja ColchÃ³n)"><input type="number" id="cajaMonto" placeholder="Monto inicial (ARS)" step="1"><input type="text" id="cajaDesc" placeholder="DescripciÃ³n (opcional)"><button class="btn btn-success" onclick="agregarCaja()">âœ… Crear Caja</button></div></div><div class="section" style="border-left: 4px solid #17a2b8; background: linear-gradient(135deg, rgba(23,162,184,0.1), rgba(32,201,151,0.1));"><h3>ğŸ”„ Transferir entre Cajas</h3><div class="grid-4" style="margin-top: 10px;"><div><label><b>De (Origen):</b></label><select id="transferenciaOrigen" style="width: 100%;"><option value="0">COLCHON ($1.050.000)</option><option value="1">EFECTIVO ($699.210)</option><option value="2">CHEQUES ($1.170.000)</option><option value="3">ECHEQ ($1.776.012)</option><option value="4">BANCO NACION ($4.531)</option><option value="5">BANCO SANTANDER ($0)</option><option value="6">MP FERRETERIA ($811.463)</option><option value="7">MP MARISOL ($1.732.668)</option><option value="8">MP MAURI ($1.168.689)</option></select></div><div><label><b>A (Destino):</b></label><select id="transferenciaDestino" style="width: 100%;"><option value="0">COLCHON ($1.050.000)</option><option value="1" selected="">EFECTIVO ($699.210)</option><option value="2">CHEQUES ($1.170.000)</option><option value="3">ECHEQ ($1.776.012)</option><option value="4">BANCO NACION ($4.531)</option><option value="5">BANCO SANTANDER ($0)</option><option value="6">MP FERRETERIA ($811.463)</option><option value="7">MP MARISOL ($1.732.668)</option><option value="8">MP MAURI ($1.168.689)</option></select></div><div><label><b>Monto (ARS):</b></label><input type="number" id="transferenciaMonto" placeholder="Monto a transferir" step="1" style="width: 100%;"></div><div><label>&nbsp;</label><button class="btn btn-info" onclick="transferirEntreCajas()" style="width: 100%;">ğŸ”„ Transferir</button></div></div><div style="margin-top: 10px;"><input type="text" id="transferenciaConcepto" placeholder="Concepto/Motivo de la transferencia (opcional)" style="width: 100%;"></div></div><div class="section"><h3>ğŸ“¦ Lista de Cajas</h3><table><tbody><tr><th>Nombre</th><th>Monto (ARS)</th><th>DescripciÃ³n</th><th>Movimientos</th><th>Acciones</th></tr><tr><td><b>COLCHON</b></td><td>$1.050.000</td><td>CAJA</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(0)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(0)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(0)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja0" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja0" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>EFECTIVO</b></td><td>$699.210</td><td>CAJA</td><td><span class="badge badge-info">3</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(1)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(1)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(1)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja1" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja1" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>CHEQUES</b></td><td>$1.170.000</td><td>CAJA</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(2)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(2)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(2)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja2" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja2" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>ECHEQ</b></td><td>$1.776.012</td><td>CAJA</td><td><span class="badge badge-info">2</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(3)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(3)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(3)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja3" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja3" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>BANCO NACION</b></td><td>$4.531</td><td>CAJA</td><td><span class="badge badge-info">2</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(4)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(4)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(4)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja4" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja4" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>BANCO SANTANDER</b></td><td>$0</td><td>caja</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(5)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(5)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(5)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja5" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja5" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>MP FERRETERIA</b></td><td>$811.463</td><td>CAJA</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(6)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(6)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(6)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja6" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja6" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>MP MARISOL</b></td><td>$1.732.668</td><td>CAJA</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(7)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(7)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(7)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja7" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja7" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr><tr><td><b>MP MAURI</b></td><td>$1.168.689</td><td>CAJA</td><td><span class="badge badge-info">1</span></td><td><button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(8)" title="Agregar movimiento">â•</button> <button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(8)" title="Ver movimientos">ğŸ‘ï¸</button> <button class="btn btn-danger btn-sm" onclick="eliminarCaja(8)">ğŸ—‘ï¸</button></td></tr><tr id="detalleMovimientosCaja8" style="display:none;"><td colspan="5"><div id="detalleMovimientosCaja8" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div></td></tr></tbody></table></div><div class="section" style="border-left: 4px solid #ffc107; background: #fff9e6;"><h3>ğŸ›¡ï¸ ColchÃ³n de Emergencia</h3><div class="grid-2"><div class="card" style="background: linear-gradient(135deg, #ffc107, #ff9800);"><div class="card-value">$145.928.428 ARS</div><div class="card-label">ğŸ¯ ColchÃ³n Recomendado (3 meses)</div></div><div class="card" style="background: linear-gradient(135deg, #ffc107, #ff9800);"><div class="card-value">$0 ARS</div><div class="card-label">âš ï¸ ColchÃ³n Actual</div></div></div><div class="alert alert-warning"><b>âš ï¸ ColchÃ³n Incompleto</b><br>Te faltan $145.928.428 ARS para tener 3 meses de gastos fijos guardados.<br>RecomendaciÃ³n: Ahorra $24.321.405 ARS por mes durante 6 meses.</div></div></div>
                </div>

                <div id="asistente" class="tab-content">
                    <h2>ğŸ¤– Asistente IA</h2>
                    <div id="recPanel"></div>
                </div>

                <div id="empleados" class="tab-content">
                    <h2>ğŸ‘” Personal</h2>
                    <div id="listaEmp"></div>
                </div>

                <div id="recordatorios" class="tab-content">
                    <h2>ğŸ“… Recordatorios</h2>
                    <div id="listaRecordatorios"></div>
                </div>

		<div id="estadoResultados" class="tab-content">
                    <h2>ğŸ“Š Estado de Resultados EconÃ³mico</h2>
                    <div id="panelEstadoResultados"></div>
                </div>

                <div id="estadoFinanciero" class="tab-content">
                    <h2>ğŸ’¹ Estado de Flujo de Caja</h2>
                    <div id="panelEstadoFinanciero"></div>
                </div>

                <div id="rentabilidad" class="tab-content">
                    <h2>ğŸ“ˆ Panel de Rentabilidad</h2>
                    <div id="panelRentabilidad"></div>
                </div>

                <div id="comparativo" class="tab-content">
                    <h2>ğŸ“Š AnÃ¡lisis Comparativo</h2>
                    <div id="panelComparativo"></div>
                </div>

                <div id="backup" class="tab-content">
                    <h2>ğŸ’¾ Backup y RestauraciÃ³n</h2>
                    <div id="panelBackup"></div>
                </div>

                <div id="usuarios" class="tab-content">
                    <h2>ğŸ‘¥ AdministraciÃ³n de Usuarios</h2>
                    <div id="panelUsuarios"></div>
                </div>

                <div id="configuracion" class="tab-content">
                    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
                    <div id="panelConfiguracion"></div>
                </div>
            </div>
    </div>

    <script>
        let datos = {
            ingresos: [], gastos: [], compras: [], empleados: [], adelantos: [], movimientos: [], recordatorios: [],
            clientes: [], proveedores: [], cuentas: [], alertasConfig: [], cajas: [],
            saldos: { efectivo: 0, banco: 0, mp: 0, cheques: 0, echeq: 0, porCobrar: 0, porPagar: 0 },
            ahorros: { meta: 0, actual: 0, historl: [] },
            inversiones: { 
                cartola: [],
                metaJubilacion: 0, 
                totalInvertido: 0,
                alertasInversion: [],
                perfilRiesgo: 'moderado',
                billeteras: {
                    brubank: 0,
                    prex: 0,
                    binance: 0,
                    galeriaGalicia: 0,
                    naranjaX: 0,
                    balanz: 0
                }
            },
            config: { dark: false, notificaciones: true, tipoCambioBNA: 1400 },
            filtros: { 
                activo: false,
                tipoFiltro: 'todo',
                aÃ±o: new Date().getFullYear(),
                mes: new Date().getMonth() + 1,
                trimestre: Math.ceil((new Date().getMonth() + 1) / 3),
                fechaDesde: '', 
                fechaHasta: '' 
            }
        };
        let graficos = {};

        // ============ UTILIDADES PESIFICADAS ============
        function fmt(valorDolares) { 
            const pesos = (valorDolares || 0) * datos.config.tipoCambioBNA;
            return '$' + Math.round(pesos).toLocaleString('es-AR') + ' ARS';
        }
        
        function actualizarTipoCambio() {
            const nuevo = parseFloat(prompt('Ingrese el nuevo tipo de cambio del DÃ³lar BNA:', datos.config.tipoCambioBNA));
            if (nuevo && nuevo > 0) {
                datos.config.tipoCambioBNA = nuevo;
                document.getElementById('tipoCambio').textContent = nuevo.toLocaleString('es-AR');
                guardarDatos();
                notif('âœ… Tipo de cambio actualizado a $' + nuevo, 'success');
                actualizarDash();
            }
        }
        
        function notif(txt, tipo) {
            const c = document.getElementById('notifs');
            const a = document.createElement('div');
            a.className = 'alert alert-' + tipo + ' notif';
            a.innerHTML = txt;
            c.appendChild(a);
            setTimeout(() => { a.style.opacity = '0'; setTimeout(() => a.remove(), 300); }, 3000);
        }

        function parseFecha(v) {
            if (!v) return null;
            
            if (v instanceof Date && !isNaN(v.getTime())) { 
                const d = new Date(v); 
                d.setHours(0,0,0,0); 
                return d; 
            }
            
            if (typeof v === 'number') {
                const d = new Date((v - 25569) * 86400 * 1000);
                d.setHours(0,0,0,0);
                return d;
            }
            
            let t = String(v).trim();
            
            if (t.match(/^\d{4}-\d{1,2}-\d{1,2}/)) {
                const partes = t.split(' ')[0].split('-');
                if (partes.length === 3) {
                    const aÃ±o = parseInt(partes[0]);
                    const mes = parseInt(partes[1]) - 1;
                    const dia = parseInt(partes[2]);
                    
                    if (!isNaN(aÃ±o) && !isNaN(mes) && !isNaN(dia)) {
                        const d = new Date(aÃ±o, mes, dia);
                        d.setHours(0,0,0,0);
                        return d;
                    }
                }
            }
            
            if (t.includes('/')) {
                let p = t.split('/');
                if (p.length === 3) {
                    let dia, mes, aÃ±o;
                    
                    if (p[2].length === 4) {
                        dia = parseInt(p[0]);
                        mes = parseInt(p[1]) - 1;
                        aÃ±o = parseInt(p[2]);
                    } 
                    else if (p[0].length === 4) {
                        aÃ±o = parseInt(p[0]);
                        mes = parseInt(p[1]) - 1;
                        dia = parseInt(p[2]);
                    } 
                    else {
                        dia = parseInt(p[0]);
                        mes = parseInt(p[1]) - 1;
                        aÃ±o = parseInt(p[2]);
                        if (aÃ±o < 100) aÃ±o += 2000;
                    }
                    
                    if (!isNaN(aÃ±o) && !isNaN(mes) && !isNaN(dia)) {
                        const d = new Date(aÃ±o, mes, dia);
                        d.setHours(0,0,0,0);
                        return d;
                    }
                }
            }
            
            const d = new Date(t);
            if (!isNaN(d.getTime())) {
                d.setHours(0,0,0,0);
                return d;
            }
            
            return null;
        }

        function fmtFecha(v) {
            const d = parseFecha(v);
            if (!d) return '-';
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const aÃ±o = d.getFullYear();
            return dia + '/' + mes + '/' + aÃ±o;
        }

        // ============ BADGE DE PERÃODO ACTUAL ============
        function obtenerBadgePeriodo() {
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            let textoPeriodo = 'ğŸ“… Todo el perÃ­odo';
            let colorBadge = '#667eea';
            
            if (datos.filtros && datos.filtros.activo) {
                switch(datos.filtros.tipoFiltro) {
                    case 'mes':
                        textoPeriodo = 'ğŸ“… ' + mesesNombres[datos.filtros.mes - 1] + ' ' + datos.filtros.aÃ±o;
                        colorBadge = '#28a745';
                        break;
                    case 'trimestre':
                        const trimestres = ['1er Trimestre', '2do Trimestre', '3er Trimestre', '4to Trimestre'];
                        textoPeriodo = 'ğŸ“… ' + trimestres[datos.filtros.trimestre - 1] + ' ' + datos.filtros.aÃ±o;
                        colorBadge = '#17a2b8';
                        break;
                    case 'aÃ±o':
                        textoPeriodo = 'ğŸ“… AÃ±o ' + datos.filtros.aÃ±o;
                        colorBadge = '#ffc107';
                        break;
                    case 'personalizado':
                        textoPeriodo = 'ğŸ“… ' + fmtFecha(datos.filtros.fechaDesde) + ' al ' + fmtFecha(datos.filtros.fechaHasta);
                        colorBadge = '#6f42c1';
                        break;
                }
            }
            
            return `<div style="display: inline-block; background: ${colorBadge}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                ${textoPeriodo}
            </div>`;
        }

        function diasDif(f1, f2) {
            const d1 = parseFecha(f1);
            const d2 = parseFecha(f2);
            if (!d1 || !d2) return 0;
            return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        // ============ SISTEMA DE FILTROS POR FECHA ============
        function aplicarFiltros(array) {
            if (!datos.filtros.activo) return array;
            
            return array.filter(item => {
                const fecha = parseFecha(item.fecha);
                if (!fecha) return false;
                
                const aÃ±o = fecha.getFullYear();
                const mes = fecha.getMonth() + 1;
                
                switch(datos.filtros.tipoFiltro) {
                    case 'mes':
                        return aÃ±o === datos.filtros.aÃ±o && mes === datos.filtros.mes;
                    
                    case 'trimestre':
                        const trimestreItem = Math.ceil(mes / 3);
                        return aÃ±o === datos.filtros.aÃ±o && trimestreItem === datos.filtros.trimestre;
                    
                    case 'aÃ±o':
                        return aÃ±o === datos.filtros.aÃ±o;
                    
                    case 'personalizado':
                        if (!datos.filtros.fechaDesde || !datos.filtros.fechaHasta) return true;
                        const desde = parseFecha(datos.filtros.fechaDesde);
                        const hasta = parseFecha(datos.filtros.fechaHasta);
                        return fecha >= desde && fecha <= hasta;
                    
                    default:
                        return true;
                }
            });
        }

        function activarFiltroMes(aÃ±o, mes) {
            datos.filtros.activo = true;
            datos.filtros.tipoFiltro = 'mes';
            datos.filtros.aÃ±o = aÃ±o;
            datos.filtros.mes = mes;
            guardarDatos();
            actualizarDash();
            notif(`ğŸ“… Filtro aplicado: ${mes}/${aÃ±o}`, 'info');
        }

        function activarFiltroTrimestre(aÃ±o, trimestre) {
            datos.filtros.activo = true;
            datos.filtros.tipoFiltro = 'trimestre';
            datos.filtros.aÃ±o = aÃ±o;
            datos.filtros.trimestre = trimestre;
            guardarDatos();
            actualizarDash();
            notif(`ğŸ“… Filtro aplicado: Q${trimestre} ${aÃ±o}`, 'info');
        }

        function activarFiltroAÃ±o(aÃ±o) {
            datos.filtros.activo = true;
            datos.filtros.tipoFiltro = 'aÃ±o';
            datos.filtros.aÃ±o = aÃ±o;
            guardarDatos();
            actualizarDash();
            notif(`ğŸ“… Filtro aplicado: AÃ±o ${aÃ±o}`, 'info');
        }

        function activarFiltroPersonalizado() {
            const desde = document.getElementById('filtroDesde').value;
            const hasta = document.getElementById('filtroHasta').value;
            
            if (!desde || !hasta) {
                notif('âš ï¸ Selecciona ambas fechas', 'warning');
                return;
            }
            
            datos.filtros.activo = true;
            datos.filtros.tipoFiltro = 'personalizado';
            datos.filtros.fechaDesde = desde;
            datos.filtros.fechaHasta = hasta;
            guardarDatos();
            actualizarDash();
            notif(`ğŸ“… Filtro aplicado: ${fmtFecha(desde)} - ${fmtFecha(hasta)}`, 'info');
        }

        function limpiarFiltros() {
            datos.filtros.activo = false;
            datos.filtros.tipoFiltro = 'todo';
            guardarDatos();
            actualizarDash();
            notif('âœ… Filtros eliminados - Mostrando todos los datos', 'success');
        }

        // ============ CÃLCULO DE PUNTO DE EQUILIBRIO ============
        function calcularPuntoEquilibrio() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);
            
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            
            const gastosFijos = gastosFiltrados.filter(g => !g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const gastosVariables = gastosFiltrados.filter(g => g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            
            const costosTotales = totalGastos + totalCompras;
            const costosVariablesTotales = gastosVariables + totalCompras;
            
            const margenContribucion = totalIngresos - costosVariablesTotales;
            const margenContribucionPorcentaje = totalIngresos > 0 ? (margenContribucion / totalIngresos) * 100 : 0;
            
            const puntoEquilibrioUSD = margenContribucionPorcentaje > 0 ? 
                gastosFijos / (margenContribucionPorcentaje / 100) : 0;
            
            const balanceActual = totalIngresos - costosTotales;
            
            const equilibrioAlcanzado = totalIngresos >= (gastosFijos + costosVariablesTotales);
            
            const faltaParaEquilibrio = equilibrioAlcanzado ? 0 : puntoEquilibrioUSD - totalIngresos;
            
            return {
                totalIngresos,
                gastosFijos,
                gastosVariables,
                totalCompras,
                costosTotales,
                costosVariablesTotales,
                margenContribucion,
                margenContribucionPorcentaje,
                puntoEquilibrioUSD,
                balanceActual,
                equilibrioAlcanzado,
                faltaParaEquilibrio
            };
        }

        function mostrarPuntoEquilibrio() {
            const pe = calcularPuntoEquilibrio();
            
            let diasEnPeriodo = 365;
            let mesesEnPeriodo = 12;
            let etiquetaPeriodo = 'Anual';
            
            if (datos.filtros.activo) {
                if (datos.filtros.tipoFiltro === 'mes') {
                    diasEnPeriodo = 30;
                    mesesEnPeriodo = 1;
                    etiquetaPeriodo = 'Mensual';
                } else if (datos.filtros.tipoFiltro === 'trimestre') {
                    diasEnPeriodo = 90;
                    mesesEnPeriodo = 3;
                    etiquetaPeriodo = 'Trimestral';
                } else if (datos.filtros.tipoFiltro === 'aÃ±o') {
                    diasEnPeriodo = 365;
                    mesesEnPeriodo = 12;
                    etiquetaPeriodo = 'Anual';
                }
            }
            
            const peAnual = pe.puntoEquilibrioUSD * (365 / diasEnPeriodo);
            const peMensual = pe.puntoEquilibrioUSD / mesesEnPeriodo;
            const peDiario = peMensual / 30;
            
            let html = obtenerBadgePeriodo();
            html += `
                <div class="alert ${pe.equilibrioAlcanzado ? 'alert-success' : 'alert-warning'}">
                    <h3 style="margin: 0 0 10px 0;">
                        ${pe.equilibrioAlcanzado ? 'âœ… Â¡Punto de Equilibrio ALCANZADO!' : 'âš ï¸ AÃºn no se alcanzÃ³ el Punto de Equilibrio'}
                    </h3>
                    <p style="margin: 0; font-size: 14px;">
                        ${pe.equilibrioAlcanzado ? 
                            `EstÃ¡s generando utilidades. Balance actual: <b>${fmt(pe.balanceActual)}</b>` : 
                            `Te faltan <b>${fmt(pe.faltaParaEquilibrio)}</b> en ingresos para cubrir todos los costos.`
                        }
                    </p>
                </div>

                <div class="grid-4">
                    <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <div class="card-value">${fmt(peAnual)}</div>
                        <div class="card-label">ğŸ“Š Punto Equilibrio Anual</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="card-value">${fmt(peMensual)}</div>
                        <div class="card-label">ğŸ“… Punto Equilibrio Mensual</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <div class="card-value">${fmt(peDiario)}</div>
                        <div class="card-label">ğŸŒ Punto Equilibrio Diario</div>
                    </div>
                    <div class="card" style="background: ${pe.equilibrioAlcanzado ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #ffc107, #ff9800)'};">
                        <div class="card-value">${pe.margenContribucionPorcentaje.toFixed(1)}%</div>
                        <div class="card-label">ğŸ’° Margen de ContribuciÃ³n</div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ“Š AnÃ¡lisis Financiero (${etiquetaPeriodo})</h3>
                    <table>
                        <tr>
                            <th>Concepto</th>
                            <th>Monto (ARS)</th>
                            <th>% sobre Ingresos</th>
                        </tr>
                        <tr>
                            <td><b>ğŸ’° Ingresos Totales</b></td>
                            <td>${fmt(pe.totalIngresos)}</td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td>ğŸ“Œ Gastos Fijos</td>
                            <td>${fmt(pe.gastosFijos)}</td>
                            <td>${pe.totalIngresos > 0 ? ((pe.gastosFijos / pe.totalIngresos) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr>
                            <td>ğŸ“Š Gastos Variables</td>
                            <td>${fmt(pe.gastosVariables)}</td>
                            <td>${pe.totalIngresos > 0 ? ((pe.gastosVariables / pe.totalIngresos) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr>
                            <td>ğŸ›’ Compras</td>
                            <td>${fmt(pe.totalCompras)}</td>
                            <td>${pe.totalIngresos > 0 ? ((pe.totalCompras / pe.totalIngresos) * 100).toFixed(1) : 0}%</td>
                        </tr>
                        <tr style="border-top: 2px solid #667eea;">
                            <td><b>ğŸ’¸ Costos Totales</b></td>
                            <td><b>${fmt(pe.costosTotales)}</b></td>
                            <td><b>${pe.totalIngresos > 0 ? ((pe.costosTotales / pe.totalIngresos) * 100).toFixed(1) : 0}%</b></td>
                        </tr>
                        <tr style="background: ${pe.balanceActual >= 0 ? '#d4edda' : '#f8d7da'};">
                            <td><b>${pe.balanceActual >= 0 ? 'âœ…' : 'âŒ'} Balance (Utilidad/PÃ©rdida)</b></td>
                            <td><b>${fmt(pe.balanceActual)}</b></td>
                            <td><b>${pe.totalIngresos > 0 ? ((pe.balanceActual / pe.totalIngresos) * 100).toFixed(1) : 0}%</b></td>
                        </tr>
                    </table>
                </div>

                <div class="section">
                    <h3>ğŸ’¡ Â¿QuÃ© es el Punto de Equilibrio?</h3>
                    <p style="line-height: 1.8; font-size: 14px;">
                        El <b>Punto de Equilibrio</b> es el nivel de ingresos necesario para cubrir TODOS los costos (fijos y variables). 
                        En este punto, no hay ni ganancias ni pÃ©rdidas.
                    </p>
                    <ul style="padding-left: 20px; line-height: 1.8; font-size: 14px;">
                        <li><b>Gastos Fijos:</b> No cambian con el volumen de ventas (alquiler, sueldos, servicios bÃ¡sicos)</li>
                        <li><b>Gastos Variables:</b> Cambian segÃºn el volumen de actividad (comisiones, materias primas)</li>
                        <li><b>Margen de ContribuciÃ³n:</b> Lo que queda despuÃ©s de cubrir costos variables</li>
                        <li><b>Punto de Equilibrio:</b> Gastos Fijos Ã· (Margen de ContribuciÃ³n %)</li>
                    </ul>
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <b>ğŸ’¡ Consejo:</b> Para mejorar tu punto de equilibrio, puedes: 
                        (1) Aumentar precios/ingresos, (2) Reducir gastos fijos, o (3) Mejorar la eficiencia para reducir costos variables.
                    </div>
                </div>
            `;
            
            document.getElementById('panelPuntoEquilibrio').innerHTML = html;
        }

        let ignorarSnapshot = false;
        
        function guardarDatos() {
            // Guardar en localStorage (backup local)
            localStorage.setItem('datosFinancieros', JSON.stringify(datos));
            
            // Guardar en Firebase - dividido en documentos separados
            if (firebaseActivo && db) {
                ignorarSnapshot = true;
                
                const batch = db.batch();
                
                // Dividir datos en documentos separados
                batch.set(db.collection('sistema').doc('ingresos'), { items: datos.ingresos || [] });
                batch.set(db.collection('sistema').doc('gastos'), { items: datos.gastos || [] });
                batch.set(db.collection('sistema').doc('compras'), { items: datos.compras || [] });
                batch.set(db.collection('sistema').doc('config'), { 
                    config: datos.config || {},
                    filtros: datos.filtros || {},
                    saldos: datos.saldos || {},
                    ahorros: datos.ahorros || {},
                    inversiones: datos.inversiones || {}
                });
                batch.set(db.collection('sistema').doc('otros'), { 
                    empleados: datos.empleados || [],
                    adelantos: datos.adelantos || [],
                    movimientos: datos.movimientos || [],
                    recordatorios: datos.recordatorios || [],
                    clientes: datos.clientes || [],
                    proveedores: datos.proveedores || [],
                    cuentas: datos.cuentas || [],
                    alertasConfig: datos.alertasConfig || [],
                    cajas: datos.cajas || []
                });
                
                batch.commit()
                    .then(function() {
                        console.log('âœ… Datos sincronizados con Firebase');
                        setTimeout(function() { ignorarSnapshot = false; }, 1000);
                    })
                    .catch(function(error) {
                        console.error('âŒ Error al guardar en Firebase:', error);
                        ignorarSnapshot = false;
                    });
            }
        }

        let listenersActivos = false;

        function cargarDatos() {
            // Primero intentar cargar de Firebase
            if (firebaseActivo && db) {
                Promise.all([
                    db.collection('sistema').doc('ingresos').get(),
                    db.collection('sistema').doc('gastos').get(),
                    db.collection('sistema').doc('compras').get(),
                    db.collection('sistema').doc('config').get(),
                    db.collection('sistema').doc('otros').get()
                ]).then(function(docs) {
                    let tieneData = false;
                    
                    if (docs[0].exists) {
                        datos.ingresos = docs[0].data().items || [];
                        tieneData = true;
                    }
                    if (docs[1].exists) {
                        datos.gastos = docs[1].data().items || [];
                        tieneData = true;
                    }
                    if (docs[2].exists) {
                        datos.compras = docs[2].data().items || [];
                        tieneData = true;
                    }
                    if (docs[3].exists) {
                        const configData = docs[3].data();
                        datos.config = configData.config || datos.config;
                        datos.filtros = configData.filtros || datos.filtros;
                        datos.saldos = configData.saldos || datos.saldos;
                        datos.ahorros = configData.ahorros || datos.ahorros;
                        datos.inversiones = configData.inversiones || datos.inversiones;
                        tieneData = true;
                    }
                    if (docs[4].exists) {
                        const otrosData = docs[4].data();
                        datos.empleados = otrosData.empleados || [];
                        datos.adelantos = otrosData.adelantos || [];
                        datos.movimientos = otrosData.movimientos || [];
                        datos.recordatorios = otrosData.recordatorios || [];
                        datos.clientes = otrosData.clientes || [];
                        datos.proveedores = otrosData.proveedores || [];
                        datos.cuentas = otrosData.cuentas || [];
                        datos.alertasConfig = otrosData.alertasConfig || [];
                        datos.cajas = otrosData.cajas || [];
                        tieneData = true;
                    }
                    
                    if (tieneData) {
                        aplicarDatosCargados();
                        notif('â˜ï¸ Datos cargados desde la nube', 'success');
                        console.log('âœ… Datos cargados desde Firebase');
                    } else {
                        cargarDatosLocal();
                    }
                    
                    // Activar listeners en tiempo real despuÃ©s de cargar
                    if (!listenersActivos) {
                        activarSincronizacionTiempoReal();
                        listenersActivos = true;
                    }
                    
                }).catch(function(error) {
                    console.error('Error al cargar de Firebase:', error);
                    cargarDatosLocal();
                });
            } else {
                cargarDatosLocal();
            }
        }
        
        // ============ SINCRONIZACIÃ“N EN TIEMPO REAL ============
        function activarSincronizacionTiempoReal() {
            if (!firebaseActivo || !db) return;
            
            // Listener para INGRESOS
            db.collection('sistema').doc('ingresos').onSnapshot(function(doc) {
                if (doc.exists && !ignorarSnapshot) {
                    datos.ingresos = doc.data().items || [];
                    actualizarVistaActual();
                    console.log('ğŸ”„ Ingresos sincronizados');
                }
            });
            
            // Listener para GASTOS
            db.collection('sistema').doc('gastos').onSnapshot(function(doc) {
                if (doc.exists && !ignorarSnapshot) {
                    datos.gastos = doc.data().items || [];
                    actualizarVistaActual();
                    console.log('ğŸ”„ Gastos sincronizados');
                }
            });
            
            // Listener para COMPRAS
            db.collection('sistema').doc('compras').onSnapshot(function(doc) {
                if (doc.exists && !ignorarSnapshot) {
                    datos.compras = doc.data().items || [];
                    actualizarVistaActual();
                    console.log('ğŸ”„ Compras sincronizadas');
                }
            });
            
            // Listener para CONFIG (saldos, cajas, etc.)
            db.collection('sistema').doc('config').onSnapshot(function(doc) {
                if (doc.exists && !ignorarSnapshot) {
                    const configData = doc.data();
                    datos.config = configData.config || datos.config;
                    datos.filtros = configData.filtros || datos.filtros;
                    datos.saldos = configData.saldos || datos.saldos;
                    datos.ahorros = configData.ahorros || datos.ahorros;
                    datos.inversiones = configData.inversiones || datos.inversiones;
                    actualizarVistaActual();
                    console.log('ğŸ”„ Config sincronizada');
                }
            });
            
            // Listener para OTROS (movimientos, empleados, cajas, clientes, etc.)
            db.collection('sistema').doc('otros').onSnapshot(function(doc) {
                if (doc.exists && !ignorarSnapshot) {
                    const otrosData = doc.data();
                    datos.empleados = otrosData.empleados || [];
                    datos.adelantos = otrosData.adelantos || [];
                    datos.movimientos = otrosData.movimientos || [];
                    datos.recordatorios = otrosData.recordatorios || [];
                    datos.clientes = otrosData.clientes || [];
                    datos.proveedores = otrosData.proveedores || [];
                    datos.cuentas = otrosData.cuentas || [];
                    datos.alertasConfig = otrosData.alertasConfig || [];
                    datos.cajas = otrosData.cajas || [];
                    actualizarVistaActual();
                    console.log('ğŸ”„ Otros datos sincronizados (movimientos, cajas, etc.)');
                }
            });
            
            console.log('âœ… SincronizaciÃ³n en tiempo real ACTIVADA');
            notif('ğŸ”„ SincronizaciÃ³n en tiempo real activada', 'info');
        }
        
        // Actualizar la vista actual sin recargar todo
        function actualizarVistaActual() {
            const tabActual = document.querySelector('.tab-content.active');
            if (tabActual) {
                const id = tabActual.id;
                if (id === 'dashboard') actualizarDash();
                else if (id === 'ingresos') mostrarIngresos();
                else if (id === 'gastos') mostrarGastos();
                else if (id === 'compras') mostrarCompras();
                else if (id === 'cajas') mostrarCajas();
                else if (id === 'movimientos') mostrarMovimientos();
                else if (id === 'graficos') mostrarGraficos();
                else if (id === 'personal') mostrarEmpleados();
                else if (id === 'clientes') mostrarClientes();
                else if (id === 'proveedores') mostrarProveedores();
            }
        }
        
        function cargarDatosLocal() {
            const guardados = localStorage.getItem('datosFinancieros');
            if (guardados) {
                try {
                    const cargados = JSON.parse(guardados);
                    datos = { ...datos, ...cargados };
                    aplicarDatosCargados();
                } catch (e) {
                    console.error('Error al cargar datos:', e);
                }
            }
        }
        
        function aplicarDatosCargados() {
            if (!datos.config.tipoCambioBNA) datos.config.tipoCambioBNA = 1400;
            if (!datos.cajas) datos.cajas = [];
            document.getElementById('tipoCambio').textContent = datos.config.tipoCambioBNA.toLocaleString('es-AR');
            if (datos.config.dark) document.body.classList.add('dark');
        }

        function toggleDark() {
            datos.config.dark = !datos.config.dark;
            document.body.classList.toggle('dark');
            guardarDatos();
        }

        // ============ NAVEGACIÃ“N ============
        function toggleMenu() {
            const tabs = document.getElementById('tabs');
            tabs.classList.toggle('abierto');
        }
        
        function cambiarTab(id) {
            // Cerrar menÃº en mÃ³vil
            document.getElementById('tabs').classList.remove('abierto');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabButton = Array.from(document.querySelectorAll('.tab')).find(t => {
                return t.getAttribute('onclick') && t.getAttribute('onclick').includes(`'${id}'`);
            });
            if (tabButton) tabButton.classList.add('active');
            
            const tabContent = document.getElementById(id);
            if (tabContent) tabContent.classList.add('active');
            
            if (id === 'carga') actualizarEstadoDatos();
            else if (id === 'dash') actualizarDash();
            else if (id === 'ingresos') mostrarIngresos();
            else if (id === 'gastosFijos') mostrarGastos();
            else if (id === 'gastosDetalle') mostrarGastosDetalle();
            else if (id === 'comprasView') mostrarComprasView();
            else if (id === 'clientes') mostrarClientes();
            else if (id === 'proveedores') mostrarProveedores();
            else if (id === 'inversiones') { mostrarInversiones(); mostrarAlertasInversion(); }
            else if (id === 'puntoEquilibrio') mostrarPuntoEquilibrio();
	    else if (id === 'estadoResultados') mostrarEstadoResultados();
            else if (id === 'estadoFinanciero') mostrarEstadoFinanciero();
            else if (id === 'rentabilidad') mostrarRentabilidad();
            else if (id === 'comparativo') mostrarAnalisisComparativo();
            else if (id === 'movimientos') mostrarMovimientos();
            else if (id === 'alertas') mostrarAlertas();
            else if (id === 'graficos') mostrarGraficos();
            else if (id === 'proyecciones') mostrarProyecciones();
            else if (id === 'cashflow') mostrarCashFlow();
            else if (id === 'ahorros') mostrarAhorros();
            else if (id === 'cajas') mostrarCajas();
            else if (id === 'asistente') mostrarAsistente();
            else if (id === 'empleados') mostrarEmpleados();
            else if (id === 'recordatorios') mostrarRecordatorios();
            else if (id === 'backup') mostrarBackup();
            else if (id === 'usuarios') mostrarPanelUsuarios();
            else if (id === 'configuracion') mostrarConfiguracion();
        }

        // ============ ESTADO DE DATOS CARGADOS ============
        function actualizarEstadoDatos() {
            let ultimaFechaIngreso = null;
            let ultimaFechaGasto = null;
            let ultimaFechaCompra = null;

            const totalIngresosUSD = datos.ingresos.reduce((sum, i) => sum + (parseFloat(i.monto) || 0), 0);
            const totalGastosUSD = datos.gastos.reduce((sum, g) => sum + (parseFloat(g.monto) || 0), 0);
            const totalComprasUSD = datos.compras.reduce((sum, c) => sum + (parseFloat(c.monto) || 0), 0);

            if (datos.ingresos.length > 0) {
                const fechasIng = datos.ingresos.map(i => parseFecha(i.fecha)).filter(f => f !== null);
                if (fechasIng.length > 0) {
                    ultimaFechaIngreso = new Date(Math.max(...fechasIng));
                }
            }

            if (datos.gastos.length > 0) {
                const fechasGast = datos.gastos.map(g => parseFecha(g.fecha)).filter(f => f !== null);
                if (fechasGast.length > 0) {
                    ultimaFechaGasto = new Date(Math.max(...fechasGast));
                }
            }

            if (datos.compras.length > 0) {
                const fechasComp = datos.compras.map(c => parseFecha(c.fecha)).filter(f => f !== null);
                if (fechasComp.length > 0) {
                    ultimaFechaCompra = new Date(Math.max(...fechasComp));
                }
            }

            const html = `
                <div class="grid-3" style="gap: 15px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">ğŸ’° Ingresos</h4>
                        <div style="font-size: 1.3rem; font-weight: bold; margin: 5px 0; color: #4ade80;">${fmt(totalIngresosUSD)}</div>
                        <div style="font-size: 1.1rem; margin: 5px 0;">${datos.ingresos.length} registros</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            ${ultimaFechaIngreso ? 
                                'ğŸ“… Ãšltima: <b>' + fmtFecha(ultimaFechaIngreso) + '</b>' : 
                                'âš ï¸ Sin registros'}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">ğŸ“¤ Gastos</h4>
                        <div style="font-size: 1.3rem; font-weight: bold; margin: 5px 0; color: #f87171;">${fmt(totalGastosUSD)}</div>
                        <div style="font-size: 1.1rem; margin: 5px 0;">${datos.gastos.length} registros</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            ${ultimaFechaGasto ? 
                                'ğŸ“… Ãšltima: <b>' + fmtFecha(ultimaFechaGasto) + '</b>' : 
                                'âš ï¸ Sin registros'}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <h4 style="color: white; margin: 0 0 10px 0; font-size: 1rem;">ğŸ›’ Compras</h4>
                        <div style="font-size: 1.3rem; font-weight: bold; margin: 5px 0; color: #fb923c;">${fmt(totalComprasUSD)}</div>
                        <div style="font-size: 1.1rem; margin: 5px 0;">${datos.compras.length} registros</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            ${ultimaFechaCompra ? 
                                'ğŸ“… Ãšltima: <b>' + fmtFecha(ultimaFechaCompra) + '</b>' : 
                                'âš ï¸ Sin registros'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; font-size: 0.9rem;">
                    <b>ğŸ’¡ Tip:</b> Los importes se muestran en <b>PESOS ARGENTINOS (ARS)</b> convertidos al tipo de cambio BNA actual ($${datos.config.tipoCambioBNA.toLocaleString('es-AR')}).
                    ${(ultimaFechaIngreso || ultimaFechaGasto || ultimaFechaCompra) ? 
                        ' VerificÃ¡ las Ãºltimas fechas para evitar duplicados al cargar nuevos datos.' : 
                        ''}
                </div>
            `;

            document.getElementById('estadoDatos').innerHTML = html;
        }

        // ============ REGISTRO INDIVIDUAL DE INGRESOS ============
        function registrarIngreso() {
            const montoBruto = parseFloat(document.getElementById('ingMonto').value);
            const retencion = parseFloat(document.getElementById('ingRetencion').value) || 0;
            const fecha = document.getElementById('ingFecha').value;
            const desc = document.getElementById('ingDesc').value;
            const metodo = document.getElementById('ingMetodo').value;
            const cat = document.getElementById('ingCategoria').value;
            
            if (!montoBruto || montoBruto <= 0) { 
                notif('âš ï¸ Ingrese un monto vÃ¡lido', 'warning'); 
                return; 
            }
            if (!fecha) { 
                notif('âš ï¸ Ingrese una fecha', 'warning'); 
                return; 
            }
            if (!desc) { 
                notif('âš ï¸ Ingrese una descripciÃ³n', 'warning'); 
                return; 
            }
            
            const montoNeto = montoBruto - retencion;
            
            datos.ingresos.push({ 
                monto: montoNeto, 
                montoBruto: montoBruto,
                retencion: retencion,
                fecha: fecha, 
                desc: desc, 
                metodo: metodo, 
                cat: cat 
            });
            
            guardarDatos();
            actualizarDash();
            actualizarEstadoDatos();
            notif('âœ… Ingreso registrado - Neto: ' + fmt(montoNeto) + ' (Bruto: ' + fmt(montoBruto) + ' - Ret: ' + fmt(retencion) + ')', 'success');
            
            document.getElementById('ingMonto').value = '';
            document.getElementById('ingRetencion').value = '0';
            document.getElementById('ingFecha').value = '';
            document.getElementById('ingDesc').value = '';
        }

        // ============ REGISTRO INDIVIDUAL DE GASTOS ============
        function registrarGasto() {
            const monto = parseFloat(document.getElementById('gastMonto').value);
            const fecha = document.getElementById('gastFecha').value;
            const desc = document.getElementById('gastDesc').value;
            const metodo = document.getElementById('gastMetodo').value;
            const cat = document.getElementById('gastCategoria').value;
            const esVariable = document.getElementById('gastTipo').value === 'true';

            if (!monto || monto <= 0) {
                notif('âš ï¸ Ingrese un monto vÃ¡lido', 'warning');
                return;
            }
            if (!fecha) {
                notif('âš ï¸ Ingrese una fecha', 'warning');
                return;
            }
            if (!desc) {
                notif('âš ï¸ Ingrese una descripciÃ³n', 'warning');
                return;
            }

            datos.gastos.push({
                monto: monto,
                fecha: fecha,
                desc: desc,
                metodo: metodo,
                cat: cat,
                esVariable: esVariable
            });

            guardarDatos();
            actualizarDash();
            actualizarEstadoDatos();
            mostrarGastos();
            notif('âœ… Gasto registrado: ' + fmt(monto), 'success');

            document.getElementById('gastMonto').value = '';
            document.getElementById('gastFecha').value = '';
            document.getElementById('gastDesc').value = '';
        }

        // ============ REGISTRO INDIVIDUAL DE COMPRAS ============
        function registrarCompra() {
            const monto = parseFloat(document.getElementById('compMonto').value);
            const fecha = document.getElementById('compFecha').value;
            const desc = document.getElementById('compDesc').value;
            const prov = document.getElementById('compProv').value;
            const metodo = document.getElementById('compMetodo').value;
            const cat = document.getElementById('compCategoria').value;

            if (!monto || monto <= 0) {
                notif('âš ï¸ Ingrese un monto vÃ¡lido', 'warning');
                return;
            }
            if (!fecha) {
                notif('âš ï¸ Ingrese una fecha', 'warning');
                return;
            }
            if (!desc) {
                notif('âš ï¸ Ingrese una descripciÃ³n', 'warning');
                return;
            }

            datos.compras.push({
                monto: monto,
                fecha: fecha,
                desc: desc,
                prov: prov || 'Sin proveedor',
                metodo: metodo,
                cat: cat
            });

            guardarDatos();
            actualizarDash();
            actualizarEstadoDatos();
            notif('âœ… Compra registrada: ' + fmt(monto), 'success');

            document.getElementById('compMonto').value = '';
            document.getElementById('compFecha').value = '';
            document.getElementById('compDesc').value = '';
            document.getElementById('compProv').value = '';
        }

        // ============ FUNCIONES DE CAJAS - CORRECTAS ============
function agregarCaja() {
    const nombre = document.getElementById('cajaNombre').value;
    const montoARS = parseFloat(document.getElementById('cajaMonto').value);
    const descripcion = document.getElementById('cajaDesc').value;

    if (!nombre) {
        notif('âš ï¸ IngresÃ¡ un nombre para la caja', 'warning');
        return;
    }
    if (!montoARS || montoARS <= 0) {
        notif('âš ï¸ IngresÃ¡ un monto vÃ¡lido en ARS', 'warning');
        return;
    }

    const montoUSD = montoARS / datos.config.tipoCambioBNA;
    if (!datos.cajas) datos.cajas = [];

    datos.cajas.push({
        nombre: nombre,
        monto: montoUSD,
        descripcion: descripcion || 'Caja sin descripciÃ³n',
        fecha: new Date().toISOString().split('T')[0],
        movimientos: []
    });

    guardarDatos();
    mostrarCajas();
    notif('âœ… Caja creada: ' + nombre + ' con $' + Math.round(montoARS).toLocaleString('es-AR') + ' ARS', 'success');

    document.getElementById('cajaNombre').value = '';
    document.getElementById('cajaMonto').value = '';
    document.getElementById('cajaDesc').value = '';
}

function eliminarCaja(i) {
    if (confirm('Â¿Eliminar esta caja?')) {
        if (!datos.cajas) return;
        datos.cajas.splice(i, 1);
        guardarDatos();
        mostrarCajas();
        notif('âœ… Caja eliminada', 'success');
    }
}

function agregarMovimientoCaja(i) {
    if (!datos.cajas || !datos.cajas[i]) return;

    const caja = datos.cajas[i];
    const tipo = prompt('Â¿Es entrada (+) o salida (-)?\nEscribÃ­: entrada o salida', 'entrada');
    
    if (!tipo || (tipo.toLowerCase() !== 'entrada' && tipo.toLowerCase() !== 'salida')) {
        notif('âš ï¸ Debes escribir "entrada" o "salida"', 'warning');
        return;
    }

    const montoARS = parseFloat(prompt('Â¿CuÃ¡nto dinero? (en ARS)'));
    if (!montoARS || montoARS <= 0) {
        notif('âš ï¸ Monto invÃ¡lido', 'warning');
        return;
    }

    const motivo = prompt('Motivo del movimiento (opcional)', '');
    const montoUSD = montoARS / datos.config.tipoCambioBNA;

    if (tipo.toLowerCase() === 'entrada') {
        datos.cajas[i].monto += montoUSD;
    } else {
        datos.cajas[i].monto = Math.max(0, datos.cajas[i].monto - montoUSD);
    }

    datos.cajas[i].movimientos.push({
        fecha: new Date().toISOString().split('T')[0],
        tipo: tipo.toLowerCase(),
        monto: montoUSD,
        motivo: motivo || 'Sin motivo'
    });

    guardarDatos();
    mostrarCajas();
    notif('âœ… Movimiento registrado en ' + caja.nombre, 'success');
}

function verMovimientosCaja(i) {
    if (!datos.cajas || !datos.cajas[i]) return;

    const caja = datos.cajas[i];
    let html = '<h4>ğŸ“‹ Movimientos de ' + caja.nombre + '</h4>';

    if (!caja.movimientos || caja.movimientos.length === 0) {
        html += '<div class="alert alert-info">Sin movimientos registrados</div>';
    } else {
        html += '<table><tr><th>Fecha</th><th>Tipo</th><th>Monto (ARS)</th><th>Motivo</th></tr>';
        caja.movimientos.forEach(mov => {
            const montoARS = Math.round(mov.monto * datos.config.tipoCambioBNA);
            const esEntrada = mov.tipo === 'entrada' || mov.tipo === 'ingreso';
            html += '<tr style="background: ' + (esEntrada ? '#d4edda' : '#f8d7da') + ';">';
            html += '<td>' + fmtFecha(mov.fecha) + '</td>';
            html += '<td>' + (esEntrada ? 'ğŸ“¥ Entrada' : 'ğŸ“¤ Salida') + '</td>';
            html += '<td><b>$' + montoARS.toLocaleString('es-AR') + '</b></td>';
            html += '<td>' + (mov.motivo || mov.concepto || 'Sin motivo') + '</td>';
            html += '</tr>';
        });
        html += '</table>';
    }

    document.getElementById('detalleMovimientosCaja' + i).innerHTML = html;
    const elemento = document.getElementById('detalleMovimientosCaja' + i);
    elemento.style.display = elemento.style.display === 'none' ? 'block' : 'none';
}

function mostrarCajas() {
    if (!datos.cajas) datos.cajas = [];

    const totalCajas = datos.cajas.reduce((sum, caja) => sum + caja.monto, 0);
    const totalCajasARS = Math.round(totalCajas * datos.config.tipoCambioBNA);

    let html = obtenerBadgePeriodo();
    html += '<div class="section">';
    html += '<h3>ğŸ’° GestiÃ³n de Cajas</h3>';
    html += '<div class="card"><div class="card-value">$' + totalCajasARS.toLocaleString('es-AR') + ' ARS</div><div class="card-label">ğŸ’¼ Total en Cajas</div></div>';

    html += '<h4 style="margin-top: 20px;">â• Crear Nueva Caja</h4>';
    html += '<div class="grid-4" style="margin-top: 10px;">';
    html += '<input type="text" id="cajaNombre" placeholder="Nombre (ej: Caja ColchÃ³n)">';
    html += '<input type="number" id="cajaMonto" placeholder="Monto inicial (ARS)" step="1">';
    html += '<input type="text" id="cajaDesc" placeholder="DescripciÃ³n (opcional)">';
    html += '<button class="btn btn-success" onclick="agregarCaja()">âœ… Crear Caja</button>';
    html += '</div>';
    html += '</div>';

    // SECCIÃ“N DE TRANSFERENCIA ENTRE CAJAS
    if (datos.cajas.length >= 2) {
        html += '<div class="section" style="border-left: 4px solid #17a2b8; background: linear-gradient(135deg, rgba(23,162,184,0.1), rgba(32,201,151,0.1));">';
        html += '<h3>ğŸ”„ Transferir entre Cajas</h3>';
        html += '<div class="grid-4" style="margin-top: 10px;">';
        
        // Selector caja origen
        html += '<div><label><b>De (Origen):</b></label>';
        html += '<select id="transferenciaOrigen" style="width: 100%;">';
        datos.cajas.forEach((caja, i) => {
            const montoARS = Math.round(caja.monto * datos.config.tipoCambioBNA);
            html += '<option value="' + i + '">' + caja.nombre + ' ($' + montoARS.toLocaleString('es-AR') + ')</option>';
        });
        html += '</select></div>';
        
        // Selector caja destino
        html += '<div><label><b>A (Destino):</b></label>';
        html += '<select id="transferenciaDestino" style="width: 100%;">';
        datos.cajas.forEach((caja, i) => {
            const montoARS = Math.round(caja.monto * datos.config.tipoCambioBNA);
            html += '<option value="' + i + '"' + (i === 1 ? ' selected' : '') + '>' + caja.nombre + ' ($' + montoARS.toLocaleString('es-AR') + ')</option>';
        });
        html += '</select></div>';
        
        // Monto
        html += '<div><label><b>Monto (ARS):</b></label>';
        html += '<input type="number" id="transferenciaMonto" placeholder="Monto a transferir" step="1" style="width: 100%;"></div>';
        
        // BotÃ³n
        html += '<div><label>&nbsp;</label>';
        html += '<button class="btn btn-info" onclick="transferirEntreCajas()" style="width: 100%;">ğŸ”„ Transferir</button></div>';
        
        html += '</div>';
        
        // Concepto opcional
        html += '<div style="margin-top: 10px;">';
        html += '<input type="text" id="transferenciaConcepto" placeholder="Concepto/Motivo de la transferencia (opcional)" style="width: 100%;">';
        html += '</div>';
        
        html += '</div>';
    }

    html += '<div class="section"><h3>ğŸ“¦ Lista de Cajas</h3>';

    if (datos.cajas.length === 0) {
        html += '<div class="alert alert-info">No hay cajas creadas. Crea una nueva caja arriba.</div>';
    } else {
        html += '<table><tr><th>Nombre</th><th>Monto (ARS)</th><th>DescripciÃ³n</th><th>Movimientos</th><th>Acciones</th></tr>';

        datos.cajas.forEach((caja, i) => {
            const montoARS = Math.round(caja.monto * datos.config.tipoCambioBNA);
            const cantMovimientos = caja.movimientos ? caja.movimientos.length : 0;

            html += '<tr>';
            html += '<td><b>' + caja.nombre + '</b></td>';
            html += '<td>$' + montoARS.toLocaleString('es-AR') + '</td>';
            html += '<td>' + caja.descripcion + '</td>';
            html += '<td><span class="badge badge-info">' + cantMovimientos + '</span></td>';
            html += '<td>';
            html += '<button class="btn btn-info btn-sm" onclick="agregarMovimientoCaja(' + i + ')" title="Agregar movimiento">â•</button> ';
            html += '<button class="btn btn-warning btn-sm" onclick="verMovimientosCaja(' + i + ')" title="Ver movimientos">ğŸ‘ï¸</button> ';
            html += '<button class="btn btn-danger btn-sm" onclick="eliminarCaja(' + i + ')">ğŸ—‘ï¸</button>';
            html += '</td>';
            html += '</tr>';
            html += '<tr id="detalleMovimientosCaja' + i + '" style="display:none;"><td colspan="5">';
            html += '<div id="detalleMovimientosCaja' + i + '" style="padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>';
            html += '</td></tr>';
        });

        html += '</table>';
    }

    html += '</div>';

    const gastosFijos = datos.gastos.filter(g => !g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
    const colchonRecomendado = gastosFijos * 3;
    const colchonActual = datos.cajas.reduce((sum, caja) => 
        caja.nombre.toLowerCase().includes('colchÃ³n') || 
        caja.nombre.toLowerCase().includes('emergencia') 
        ? sum + caja.monto 
        : sum, 0);

    html += '<div class="section" style="border-left: 4px solid #ffc107; background: #fff9e6;">';
    html += '<h3>ğŸ›¡ï¸ ColchÃ³n de Emergencia</h3>';
    html += '<div class="grid-2">';
    html += '<div class="card" style="background: linear-gradient(135deg, #ffc107, #ff9800);">';
    html += '<div class="card-value">$' + Math.round(colchonRecomendado * datos.config.tipoCambioBNA).toLocaleString('es-AR') + ' ARS</div>';
    html += '<div class="card-label">ğŸ¯ ColchÃ³n Recomendado (3 meses)</div>';
    html += '</div>';
    html += '<div class="card" style="background: ' + (colchonActual >= colchonRecomendado ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #ffc107, #ff9800)') + ';">';
    html += '<div class="card-value">$' + Math.round(colchonActual * datos.config.tipoCambioBNA).toLocaleString('es-AR') + ' ARS</div>';
    html += '<div class="card-label">' + (colchonActual >= colchonRecomendado ? 'âœ…' : 'âš ï¸') + ' ColchÃ³n Actual</div>';
    html += '</div>';
    html += '</div>';

    const faltaColchon = colchonRecomendado - colchonActual;
    if (faltaColchon > 0) {
        html += '<div class="alert alert-warning">';
        html += '<b>âš ï¸ ColchÃ³n Incompleto</b><br>';
        html += 'Te faltan $' + Math.round(faltaColchon * datos.config.tipoCambioBNA).toLocaleString('es-AR') + ' ARS para tener 3 meses de gastos fijos guardados.<br>';
        html += 'RecomendaciÃ³n: Ahorra $' + Math.round((faltaColchon / 6) * datos.config.tipoCambioBNA).toLocaleString('es-AR') + ' ARS por mes durante 6 meses.';
        html += '</div>';
    } else if (gastosFijos > 0) {
        html += '<div class="alert alert-success">';
        html += '<b>âœ… Â¡ColchÃ³n Completo!</b><br>';
        html += 'TenÃ©s ' + Math.round(colchonActual / gastosFijos) + ' meses de gastos fijos guardados. EstÃ¡s protegido ante imprevistos.';
        html += '</div>';
    }

    html += '</div>';

    document.getElementById('panelCajas').innerHTML = html;
}

function transferirEntreCajas() {
    const origenIdx = parseInt(document.getElementById('transferenciaOrigen').value);
    const destinoIdx = parseInt(document.getElementById('transferenciaDestino').value);
    const montoARS = parseFloat(document.getElementById('transferenciaMonto').value) || 0;
    const concepto = document.getElementById('transferenciaConcepto').value.trim() || 'Transferencia entre cajas';
    
    // Validaciones
    if (origenIdx === destinoIdx) {
        notif('âš ï¸ La caja origen y destino no pueden ser la misma', 'warning');
        return;
    }
    
    if (montoARS <= 0) {
        notif('âš ï¸ IngresÃ¡ un monto vÃ¡lido', 'warning');
        return;
    }
    
    const montoUSD = montoARS / datos.config.tipoCambioBNA;
    const cajaOrigen = datos.cajas[origenIdx];
    const cajaDestino = datos.cajas[destinoIdx];
    
    if (cajaOrigen.monto < montoUSD) {
        notif('âš ï¸ Saldo insuficiente en ' + cajaOrigen.nombre + '. Disponible: $' + Math.round(cajaOrigen.monto * datos.config.tipoCambioBNA).toLocaleString('es-AR') + ' ARS', 'warning');
        return;
    }
    
    // Realizar transferencia
    // Restar de origen
    datos.cajas[origenIdx].monto -= montoUSD;
    if (!datos.cajas[origenIdx].movimientos) datos.cajas[origenIdx].movimientos = [];
    datos.cajas[origenIdx].movimientos.push({
        fecha: new Date().toISOString().split('T')[0],
        tipo: 'salida',
        monto: montoUSD,
        motivo: 'ğŸ”„ Transferencia a ' + cajaDestino.nombre + ' - ' + concepto
    });
    
    // Sumar a destino
    datos.cajas[destinoIdx].monto += montoUSD;
    if (!datos.cajas[destinoIdx].movimientos) datos.cajas[destinoIdx].movimientos = [];
    datos.cajas[destinoIdx].movimientos.push({
        fecha: new Date().toISOString().split('T')[0],
        tipo: 'entrada',
        monto: montoUSD,
        motivo: 'ğŸ”„ Transferencia desde ' + cajaOrigen.nombre + ' - ' + concepto
    });
    
    guardarDatos();
    mostrarCajas();
    
    notif('âœ… Transferencia exitosa: $' + Math.round(montoARS).toLocaleString('es-AR') + ' ARS de ' + cajaOrigen.nombre + ' a ' + cajaDestino.nombre, 'success');
    
    // Limpiar campos
    document.getElementById('transferenciaMonto').value = '';
    document.getElementById('transferenciaConcepto').value = '';
}

        // ============ CARGA MASIVA ============
        function procesarArchivo() {
            const arch = document.getElementById('archivo').files[0];
            if (!arch) { 
                notif('âš ï¸ Selecciona un archivo', 'warning'); 
                return; 
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const filas = XLSX.utils.sheet_to_json(ws, { raw: false, defval: '' });

                    if (!filas || filas.length === 0) {
                        notif('âš ï¸ El archivo estÃ¡ vacÃ­o', 'warning');
                        return;
                    }

                    let cont = 0;
                    let errores = 0;
                    
                    filas.forEach((f, index) => {
                        try {
                            const tipo = String(f.Tipo || f.tipo || f.TIPO || '').trim().toUpperCase();
                            
                            const montoStr = f.Monto || f.monto || f.MONTO || f.Importe || f.importe || f.IMPORTE || '0';
                            let montoARS = 0;
                            
                            if (typeof montoStr === 'string') {
                                montoARS = parseFloat(montoStr.replace(/[$,\s]/g, '').replace(',', '.'));
                            } else {
                                montoARS = parseFloat(montoStr);
                            }
                            
                            if (!tipo || isNaN(montoARS) || montoARS <= 0) {
                                errores++;
                                return;
                            }

                            const montoUSD = montoARS / datos.config.tipoCambioBNA;

                            const item = {
                                fecha: f.Fecha || f.fecha || f.FECHA || new Date().toISOString().split('T')[0],
                                monto: montoUSD,
                                desc: f.Descripcion || f.descripcion || f.Concepto || f.concepto || f.Detalle || f.detalle || 'Sin descripciÃ³n',
                                metodo: f.Metodo || f.MÃ©todo || f.metodo || f['MÃ©todo de Pago'] || f['Forma de Pago'] || f.MetodoPago || 'Efectivo',
                                cat: f.Categoria || f.CategorÃ­a || f.categoria || f.Rubro || f.rubro || 'General'
                            };

                            if (tipo.includes('INGRESO')) {
                                datos.ingresos.push(item);
                                cont++;
                            } else if (tipo.includes('GASTO')) {
                                const tipoGasto = String(f.Tipo_Gasto || f.TipoGasto || f.tipo_gasto || '').toLowerCase();
                                item.esVariable = tipoGasto.includes('variable');
                                datos.gastos.push(item);
                                cont++;
                            } else if (tipo.includes('COMPRA')) {
                                item.prov = f.Proveedor || f.proveedor || 'Sin proveedor';
                                datos.compras.push(item);
                                cont++;
                            }
                        } catch (err) {
                            console.error('Error procesando fila ' + (index + 1) + ':', err);
                            errores++;
                        }
                    });

                    if (cont > 0) {
                        guardarDatos();
                        actualizarDash();
                        actualizarEstadoDatos();
                        const mensaje = 'âœ… ' + cont + ' registros importados correctamente';
                        if (errores > 0) {
                            notif(mensaje + ' (' + errores + ' filas con errores ignoradas)', 'success');
                        } else {
                            notif(mensaje, 'success');
                        }
                        document.getElementById('archivo').value = '';
                    } else {
                        notif('âŒ No se pudieron importar datos. Verifica el formato del archivo.<br>Columnas requeridas: Tipo (INGRESO/GASTO/COMPRA), Monto', 'danger');
                    }
                } catch (error) {
                    console.error('Error al procesar archivo:', error);
                    notif('âŒ Error al procesar el archivo: ' + error.message + '<br>Verifica que sea un archivo Excel vÃ¡lido (.xlsx, .xls, .csv)', 'danger');
                }
            };
            lector.readAsArrayBuffer(arch);
        }

        function procesarArchivoIngresos() {
            const arch = document.getElementById('archivoIngresos').files[0];
            if (!arch) { 
                notif('âš ï¸ Selecciona un archivo de ingresos', 'warning'); 
                return; 
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: false });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    const filas = [];
                    
                    for (let R = 2; R <= range.e.r; R++) {
                        const fila = {};
                        
                        const cellFecha = ws[XLSX.utils.encode_cell({r: R, c: 0})];
                        if (cellFecha) {
                            if (cellFecha.t === 'n') {
                                fila.Fecha = XLSX.SSF.parse_date_code(cellFecha.v);
                            } else {
                                fila.Fecha = cellFecha.v;
                            }
                        }
                        
                        const cellRazon = ws[XLSX.utils.encode_cell({r: R, c: 1})];
                        fila['Razon Social'] = cellRazon ? cellRazon.v : '';
                        
                        const cellConcepto = ws[XLSX.utils.encode_cell({r: R, c: 2})];
                        fila['Nombre Concepto'] = cellConcepto ? cellConcepto.v : '';
                        
                        const cellTotal = ws[XLSX.utils.encode_cell({r: R, c: 3})];
                        fila.Total = cellTotal ? cellTotal.v : 0;
                        
                        const cellRetencion = ws[XLSX.utils.encode_cell({r: R, c: 4})];
                        fila.Retencion = cellRetencion ? cellRetencion.v : 0;
                        
                        filas.push(fila);
                    }

                    if (!filas || filas.length === 0) {
                        notif('âš ï¸ El archivo estÃ¡ vacÃ­o', 'warning');
                        return;
                    }

                    let cont = 0;
                    let errores = 0;
                    
                    filas.forEach((f, index) => {
                        try {
                            const fechaRaw = f.Fecha;
                            const razonSocial = f['Razon Social'] || '';
                            const nombreConcepto = f['Nombre Concepto'] || '';
                            const totalStr = f.Total;
                            
                            if (!fechaRaw) return;
                            
                            let fechaObj;
                            if (fechaRaw.y && fechaRaw.m && fechaRaw.d) {
                                fechaObj = new Date(fechaRaw.y, fechaRaw.m - 1, fechaRaw.d);
                                fechaObj.setHours(0,0,0,0);
                            } else {
                                fechaObj = parseFecha(fechaRaw);
                            }
                            
                            if (!fechaObj || isNaN(fechaObj.getTime())) {
                                errores++;
                                return;
                            }
                            
                            const aÃ±o = fechaObj.getFullYear();
                            const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                            const dia = String(fechaObj.getDate()).padStart(2, '0');
                            const fechaISO = `${aÃ±o}-${mes}-${dia}`;
                            
                            let montoARS = 0;
                            if (typeof totalStr === 'string') {
                                montoARS = parseFloat(totalStr.replace(/[$\s]/g, '').replace(',', '.'));
                            } else {
                                montoARS = parseFloat(totalStr);
                            }
                            
                            if (isNaN(montoARS) || montoARS <= 0) {
                                errores++;
                                return;
                            }

                            const montoUSD = montoARS / datos.config.tipoCambioBNA;

                            let retencionARS = 0;
                            if (f.Retencion) {
                                if (typeof f.Retencion === 'string') {
                                    retencionARS = parseFloat(f.Retencion.replace(/[$\s]/g, '').replace(',', '.'));
                                } else {
                                    retencionARS = parseFloat(f.Retencion);
                                }
                            }
                            const retencionUSD = retencionARS / datos.config.tipoCambioBNA;
                            const montoNetoUSD = montoUSD - retencionUSD;

                            const item = {
                                fecha: fechaISO,
                                monto: montoNetoUSD,
                                montoBruto: montoUSD,
                                retencion: retencionUSD,
                                desc: nombreConcepto || 'Sin concepto',
                                metodo: razonSocial || 'Sin especificar',
                                cat: 'Ingresos'
                            };

                            datos.ingresos.push(item);
                            cont++;
                        } catch (err) {
                            console.error('Error en fila ' + (index + 3) + ':', err);
                            errores++;
                        }
                    });

                    if (cont > 0) {
                        guardarDatos();
                        actualizarDash();
                        actualizarEstadoDatos();
                        const mensaje = 'âœ… ' + cont + ' ingresos importados correctamente';
                        if (errores > 0) {
                            notif(mensaje + ' (' + errores + ' filas con errores)', 'success');
                        } else {
                            notif(mensaje, 'success');
                        }
                        document.getElementById('archivoIngresos').value = '';
                    } else {
                        notif('âŒ No se pudieron importar ingresos. Verifica el formato del archivo.', 'danger');
                    }
                } catch (error) {
                    console.error('Error al procesar archivo:', error);
                    notif('âŒ Error al procesar archivo: ' + error.message, 'danger');
                }
            };
            lector.readAsArrayBuffer(arch);
        }

        function procesarArchivoGastos() {
            const arch = document.getElementById('archivoGastos').files[0];
            if (!arch) { 
                notif('âš ï¸ Selecciona un archivo de gastos', 'warning'); 
                return; 
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: false });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    const filas = [];
                    
                    for (let R = 2; R <= range.e.r; R++) {
                        const fila = {};
                        
                        const cellFecha = ws[XLSX.utils.encode_cell({r: R, c: 0})];
                        if (cellFecha) {
                            if (cellFecha.t === 'n') {
                                fila.Fecha = XLSX.SSF.parse_date_code(cellFecha.v);
                            } else {
                                fila.Fecha = cellFecha.v;
                            }
                        }
                        
                        const cellPersona = ws[XLSX.utils.encode_cell({r: R, c: 1})];
                        fila.Persona = cellPersona ? cellPersona.v : '';
                        
                        const cellFormaPago = ws[XLSX.utils.encode_cell({r: R, c: 2})];
                        fila['Forma Pago'] = cellFormaPago ? cellFormaPago.v : '';
                        
                        const cellTotal = ws[XLSX.utils.encode_cell({r: R, c: 3})];
                        fila.TOTAL = cellTotal ? cellTotal.v : 0;
                        
                        const cellItem = ws[XLSX.utils.encode_cell({r: R, c: 4})];
                        fila.Item = cellItem ? cellItem.v : '';
                        
                        filas.push(fila);
                    }

                    if (!filas || filas.length === 0) {
                        notif('âš ï¸ El archivo estÃ¡ vacÃ­o', 'warning');
                        return;
                    }

                    let cont = 0;
                    let errores = 0;
                    let empleadosDetectados = 0;
                    
                    filas.forEach((f, index) => {
                        try {
                            const fechaRaw = f.Fecha;
                            const persona = String(f.Persona || '').toUpperCase();
                            const formaPago = f['Forma Pago'] || 'Efectivo';
                            const totalStr = f.TOTAL;
                            const item = f.Item || 'General';
                            
                            if (!fechaRaw) return;
                            
                            let fechaObj;
                            if (fechaRaw.y && fechaRaw.m && fechaRaw.d) {
                                fechaObj = new Date(fechaRaw.y, fechaRaw.m - 1, fechaRaw.d);
                                fechaObj.setHours(0,0,0,0);
                            } else {
                                fechaObj = parseFecha(fechaRaw);
                            }
                            
                            if (!fechaObj || isNaN(fechaObj.getTime())) {
                                errores++;
                                return;
                            }
                            
                            const aÃ±o = fechaObj.getFullYear();
                            const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                            const dia = String(fechaObj.getDate()).padStart(2, '0');
                            const fechaISO = `${aÃ±o}-${mes}-${dia}`;
                            
                            let montoARS = 0;
                            if (typeof totalStr === 'string') {
                                let limpio = totalStr.replace(/[$\s]/g, '').replace(',', '.').replace('-', '');
                                montoARS = parseFloat(limpio);
                            } else {
                                montoARS = Math.abs(parseFloat(totalStr));
                            }
                            
                            if (isNaN(montoARS) || montoARS <= 0) {
                                errores++;
                                return;
                            }

                            const montoUSD = montoARS / datos.config.tipoCambioBNA;

                            const itemUpper = item.toUpperCase();
                            const esSueldo = itemUpper.includes('SUELDO') || itemUpper.includes('SALARIO');
                            
                            if (esSueldo) {
                                let nombreEmpleado = item
                                    .replace(/SUELDO/gi, '')
                                    .replace(/SALARIO/gi, '')
                                    .replace(/DE /gi, '')
                                    .replace(/^\s*-\s*/gi, '')
                                    .trim();
                                
                                if (nombreEmpleado) {
                                    const empleadoExiste = datos.empleados.find(e => 
                                        e.nombre.toUpperCase() === nombreEmpleado.toUpperCase()
                                    );
                                    
                                    if (!empleadoExiste) {
                                        datos.empleados.push({
                                            nombre: nombreEmpleado,
                                            puesto: 'Personal',
                                            sueldo: montoUSD
                                        });
                                        empleadosDetectados++;
                                    } else {
                                        if (empleadoExiste.sueldo !== montoUSD) {
                                            empleadoExiste.sueldo = montoUSD;
                                        }
                                    }
                                }
                            }

                            const esVariable = persona.includes('VARIABLE');
                            
                            const itemGasto = {
                                fecha: fechaISO,
                                monto: montoUSD,
                                desc: item,
                                metodo: formaPago,
                                cat: item,
                                esVariable: esVariable
                            };

                            datos.gastos.push(itemGasto);
                            cont++;
                        } catch (err) {
                            console.error('Error en fila ' + (index + 1) + ':', err);
                            errores++;
                        }
                    });

                    if (cont > 0) {
                        guardarDatos();
                        actualizarDash();
                        actualizarEstadoDatos();
                        mostrarGastos();
                        
                        let mensaje = 'âœ… ' + cont + ' gastos importados correctamente';
                        if (empleadosDetectados > 0) {
                            mensaje += '<br>ğŸ‘” ' + empleadosDetectados + ' empleados detectados y agregados automÃ¡ticamente';
                        }
                        if (errores > 0) {
                            mensaje += ' (' + errores + ' filas con errores)';
                        }
                        notif(mensaje, 'success');
                        
                        document.getElementById('archivoGastos').value = '';
                    } else {
                        notif('âŒ No se pudieron importar gastos. Verifica el formato del archivo.', 'danger');
                    }
                } catch (error) {
                    console.error('Error al procesar archivo:', error);
                    notif('âŒ Error al procesar archivo: ' + error.message, 'danger');
                }
            };
            lector.readAsArrayBuffer(arch);
        }

        function procesarArchivoCompras() {
            const arch = document.getElementById('archivoCompras').files[0];
            if (!arch) { 
                notif('âš ï¸ Selecciona un archivo de compras', 'warning'); 
                return; 
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: false });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    const filas = [];
                    
                    for (let R = 2; R <= range.e.r; R++) {
                        const fila = {};
                        
                        const cellFecha = ws[XLSX.utils.encode_cell({r: R, c: 0})];
                        if (cellFecha) {
                            if (cellFecha.t === 'n') {
                                fila.Fecha = XLSX.SSF.parse_date_code(cellFecha.v);
                            } else {
                                fila.Fecha = cellFecha.v;
                            }
                        }
                        
                        const cellPersona = ws[XLSX.utils.encode_cell({r: R, c: 1})];
                        fila.Persona = cellPersona ? cellPersona.v : '';
                        
                        const cellFormaPago = ws[XLSX.utils.encode_cell({r: R, c: 2})];
                        fila['Forma Pago'] = cellFormaPago ? cellFormaPago.v : '';
                        
                        const cellTotal = ws[XLSX.utils.encode_cell({r: R, c: 3})];
                        fila.TOTAL = cellTotal ? cellTotal.v : 0;
                        
                        const cellItem = ws[XLSX.utils.encode_cell({r: R, c: 4})];
                        fila.Item = cellItem ? cellItem.v : '';
                        
                        filas.push(fila);
                    }

                    if (!filas || filas.length === 0) {
                        notif('âš ï¸ El archivo estÃ¡ vacÃ­o', 'warning');
                        return;
                    }

                    let cont = 0;
                    let errores = 0;
                    
                    filas.forEach((f, index) => {
                        try {
                            const fechaRaw = f.Fecha;
                            const persona = f.Persona || 'Sin proveedor';
                            const formaPago = f['Forma Pago'] || 'Efectivo';
                            const totalStr = f.TOTAL;
                            const item = f.Item || 'Compras';
                            
                            if (!fechaRaw) return;
                            
                            let fechaObj;
                            if (fechaRaw.y && fechaRaw.m && fechaRaw.d) {
                                fechaObj = new Date(fechaRaw.y, fechaRaw.m - 1, fechaRaw.d);
                                fechaObj.setHours(0,0,0,0);
                            } else {
                                fechaObj = parseFecha(fechaRaw);
                            }
                            
                            if (!fechaObj || isNaN(fechaObj.getTime())) {
                                errores++;
                                return;
                            }
                            
                            const aÃ±o = fechaObj.getFullYear();
                            const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                            const dia = String(fechaObj.getDate()).padStart(2, '0');
                            const fechaISO = `${aÃ±o}-${mes}-${dia}`;
                            
                            let montoARS = 0;
                            if (typeof totalStr === 'string') {
                                montoARS = parseFloat(totalStr.replace(/[$\s]/g, '').replace(',', '.'));
                            } else {
                                montoARS = parseFloat(totalStr);
                            }
                            
                            if (isNaN(montoARS) || montoARS <= 0) {
                                errores++;
                                return;
                            }

                            const montoUSD = montoARS / datos.config.tipoCambioBNA;

                            const itemCompra = {
                                fecha: fechaISO,
                                monto: montoUSD,
                                desc: item,
                                metodo: formaPago,
                                cat: item,
                                prov: persona
                            };

                            datos.compras.push(itemCompra);
                            cont++;
                        } catch (err) {
                            console.error('Error en fila ' + (index + 1) + ':', err);
                            errores++;
                        }
                    });

                    if (cont > 0) {
                        guardarDatos();
                        actualizarDash();
                        actualizarEstadoDatos();
                        const mensaje = 'âœ… ' + cont + ' compras importadas correctamente';
                        if (errores > 0) {
                            notif(mensaje + ' (' + errores + ' filas con errores)', 'success');
                        } else {
                            notif(mensaje, 'success');
                        }
                        document.getElementById('archivoCompras').value = '';
                    } else {
                        notif('âŒ No se pudieron importar compras. Verifica el formato del archivo.', 'danger');
                    }
                } catch (error) {
                    console.error('Error al procesar archivo:', error);
                    notif('âŒ Error al procesar archivo: ' + error.message, 'danger');
                }
            };
            lector.readAsArrayBuffer(arch);
        }

        function descargarEjemplo() {
            const datosEjemplo = [
                ['Tipo', 'Monto', 'Fecha', 'Descripcion', 'Metodo', 'Categoria', 'Proveedor', 'Tipo_Gasto'],
                ['INGRESO', 2100000, '01/10/2025', 'Venta de productos', 'Efectivo', 'Ventas', '', ''],
                ['INGRESO', 3220000, '02/10/2025', 'Cobro de servicios', 'Banco', 'Servicios', '', ''],
                ['GASTO', 560000, '01/10/2025', 'Alquiler del local', 'Banco', 'Alquiler', '', 'Fijo'],
                ['GASTO', 112000, '04/10/2025', 'Combustible', 'Efectivo', 'Transporte', '', 'Variable'],
                ['COMPRA', 840000, '02/10/2025', 'MercaderÃ­a para reventa', 'Banco', 'Compras', 'Proveedor ABC', ''],
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosEjemplo);
            ws['!cols'] = [{wch: 12}, {wch: 10}, {wch: 12}, {wch: 30}, {wch: 15}, {wch: 18}, {wch: 20}, {wch: 12}];
            XLSX.utils.book_append_sheet(wb, ws, 'Datos Financieros');
            XLSX.writeFile(wb, 'ejemplo-carga-datos.xlsx');
            notif('âœ… Archivo de ejemplo descargado', 'success');
        }

        function descargarEjemploIngresos() {
            const datosEjemplo = [
                ['Fecha', 'Razon Social', 'Nombre Concepto', 'Total', 'Retencion'],
                ['01/10/2025', 'Cliente SA', 'Venta de productos al contado', 2100000, 0],
                ['02/10/2025', 'Empresa ABC', 'Cobro de servicios prestados', 3220000, 322000],
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosEjemplo);
            ws['!cols'] = [{wch: 14}, {wch: 25}, {wch: 40}, {wch: 12}, {wch: 12}];
            XLSX.utils.book_append_sheet(wb, ws, 'Ingresos');
            XLSX.writeFile(wb, 'ejemplo-ingresos.xlsx');
            notif('âœ… Ejemplo de ingresos descargado', 'success');
        }

        function descargarEjemploGastos() {
            const datosEjemplo = [
                ['Fecha', 'Persona', 'Forma Pago', 'TOTAL', 'Item'],
                ['01/10/2025', 'GASTOS FIJOS', 'Banco', 560000, 'Alquiler'],
                ['04/10/2025', 'GASTOS VARIABLES', 'Efectivo', 112000, 'Combustible'],
                ['10/10/2025', 'GASTOS FIJOS', 'Banco', 2520000, 'SUELDO JUAN PEREZ'],
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosEjemplo);
            ws['!cols'] = [{wch: 14}, {wch: 18}, {wch: 18}, {wch: 12}, {wch: 25}];
            XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
            XLSX.writeFile(wb, 'ejemplo-gastos.xlsx');
            notif('âœ… Ejemplo de gastos descargado', 'success');
        }

        function descargarEjemploCompras() {
            const datosEjemplo = [
                ['Fecha', 'Persona', 'Forma Pago', 'TOTAL', 'Item'],
                ['02/10/2025', 'Proveedor ABC SA', 'Banco', 840000, 'MercaderÃ­a'],
                ['05/10/2025', 'Distribuidora XYZ', 'Mercado Pago', 490000, 'Insumos'],
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosEjemplo);
            ws['!cols'] = [{wch: 14}, {wch: 25}, {wch: 18}, {wch: 12}, {wch: 20}];
            XLSX.utils.book_append_sheet(wb, ws, 'Compras');
            XLSX.writeFile(wb, 'ejemplo-compras.xlsx');
            notif('âœ… Ejemplo de compras descargado', 'success');
        }

        function mostrarGastos() {
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const fijos = gastosFiltrados.filter(g => !g.esVariable);
            const variables = gastosFiltrados.filter(g => g.esVariable);
            
            const totalFijos = fijos.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const totalVariables = variables.reduce((s, g) => s + parseFloat(g.monto || 0), 0);

            let html = obtenerBadgePeriodo();
            html += `
                <div class="grid-2">
                    <div class="card">
                        <div class="card-value">${fmt(totalFijos)}</div>
                        <div class="card-label">ğŸ“Œ Gastos Fijos</div>
                    </div>
                    <div class="card">
                        <div class="card-value">${fmt(totalVariables)}</div>
                        <div class="card-label">ğŸ“Š Gastos Variables</div>
                    </div>
                </div>
            `;
            
            if (datos.filtros.activo) {
                html += '<div class="alert alert-info">ğŸ” Mostrando ' + gastosFiltrados.length + ' de ' + datos.gastos.length + ' gastos (filtro activo)</div>';
            }

            html += '<h3>ğŸ“Œ Gastos Fijos</h3>';

            if (fijos.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay gastos fijos ' + (datos.filtros.activo ? 'que coincidan con el filtro.' : 'registrados.') + '</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>DescripciÃ³n</th><th>Monto (ARS)</th><th>MÃ©todo</th><th>CategorÃ­a</th><th></th></tr>';
                fijos.forEach((g) => {
                    const indiceReal = datos.gastos.indexOf(g);
                    html += `<tr>
                        <td>${fmtFecha(g.fecha)}</td>
                        <td>${g.desc}</td>
                        <td>${fmt(g.monto)}</td>
                        <td>${g.metodo}</td>
                        <td>${g.cat}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarGasto(${indiceReal})">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                html += '</table>';
            }

            html += '<h3>ğŸ“Š Gastos Variables</h3>';
            
            if (variables.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay gastos variables ' + (datos.filtros.activo ? 'que coincidan con el filtro.' : 'registrados.') + '</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>DescripciÃ³n</th><th>Monto (ARS)</th><th>MÃ©todo</th><th>CategorÃ­a</th><th></th></tr>';
                variables.forEach((g) => {
                    const indiceReal = datos.gastos.indexOf(g);
                    html += `<tr>
                        <td>${fmtFecha(g.fecha)}</td>
                        <td>${g.desc}</td>
                        <td>${fmt(g.monto)}</td>
                        <td>${g.metodo}</td>
                        <td>${g.cat}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarGasto(${indiceReal})">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                html += '</table>';
            }

            document.getElementById('listaGastos').innerHTML = html;
        }

        function eliminarGasto(i) {
            if (confirm('Â¿Eliminar este gasto?')) {
                datos.gastos.splice(i, 1);
                guardarDatos();
                mostrarGastos();
                actualizarDash();
                notif('âœ… Gasto eliminado', 'success');
            }
        }

        function mostrarGastosDetalle() {
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            
            if (gastosFiltrados.length === 0) {
                let mensaje = obtenerBadgePeriodo() + '<br>ğŸ“‹ No hay gastos ';
                if (datos.filtros.activo && datos.gastos.length > 0) {
                    mensaje += 'que coincidan con el filtro seleccionado.';
                } else if (datos.gastos.length === 0) {
                    mensaje += 'registrados aÃºn. <br><br>Esta ventana muestra automÃ¡ticamente los gastos fijos y variables separados por concepto/nombre, extrayÃ©ndolos del archivo de gastos que cargues.';
                }
                document.getElementById('gastosDetalle').innerHTML = '<div class="alert alert-info">' + mensaje + '</div>';
                return;
            }
            
            const gastFijos = gastosFiltrados.filter(g => !g.esVariable);
            const gastVariables = gastosFiltrados.filter(g => g.esVariable);
            
            const totalFijos = gastFijos.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const totalVariables = gastVariables.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            
            const fijosPorNombre = {};
            gastFijos.forEach(g => {
                const nombre = g.desc || g.cat || 'Sin categorÃ­a';
                if (!fijosPorNombre[nombre]) {
                    fijosPorNombre[nombre] = [];
                }
                fijosPorNombre[nombre].push(g);
            });
            
            const variablesPorNombre = {};
            gastVariables.forEach(g => {
                const nombre = g.desc || g.cat || 'Sin categorÃ­a';
                if (!variablesPorNombre[nombre]) {
                    variablesPorNombre[nombre] = [];
                }
                variablesPorNombre[nombre].push(g);
            });
            
            let html = obtenerBadgePeriodo();
            html += `
                <div class="grid-3">
                    <div class="card" style="background: linear-gradient(135deg, #6f42c1, #9b59b6)">
                        <div class="card-value">${gastFijos.length}</div>
                        <div class="card-label">ğŸ“Œ Gastos Fijos</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #17a2b8, #20c997)">
                        <div class="card-value">${gastVariables.length}</div>
                        <div class="card-label">ğŸ“Š Gastos Variables</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #dc3545, #c82333)">
                        <div class="card-value">${fmt(totalFijos + totalVariables)}</div>
                        <div class="card-label">ğŸ’¸ Total Gastos</div>
                    </div>
                </div>
            `;
            
            if (datos.filtros.activo) {
                html += '<div class="alert alert-info">ğŸ” Mostrando ' + gastosFiltrados.length + ' de ' + datos.gastos.length + ' gastos (filtro activo)</div>';
            }

            html += `
                <div class="section">
                    <h3>ğŸ“Œ Gastos Fijos por Concepto</h3>
                    <table>
                        <tr>
                            <th>Concepto/Nombre</th>
                            <th>Cantidad</th>
                            <th>Total (ARS)</th>
                            <th>Promedio (ARS)</th>
                            <th>Ver Detalle</th>
                        </tr>
            `;
            
            for (const [nombre, gastos] of Object.entries(fijosPorNombre)) {
                const total = gastos.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
                const promedio = total / gastos.length;
                const id = nombre.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                
                html += `
                    <tr>
                        <td><b>${nombre}</b></td>
                        <td>${gastos.length}</td>
                        <td>${fmt(total)}</td>
                        <td>${fmt(promedio)}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="verDetalleGasto('${id}', 'fijo')">ğŸ‘ï¸ Ver</button>
                        </td>
                    </tr>
                    <tr id="${id}_fijo" style="display:none;">
                        <td colspan="5">
                            <div style="padding: 10px; background: #f8f9fa;">
                                <table style="margin: 0;">
                                    <tr><th>Fecha</th><th>Monto (ARS)</th><th>MÃ©todo</th></tr>
                    `;
                
                gastos.forEach(g => {
                    html += `
                        <tr>
                            <td>${fmtFecha(g.fecha)}</td>
                            <td>${fmt(g.monto)}</td>
                            <td>${g.metodo}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </table>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </table>
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <b>ğŸ’¡ Total Gastos Fijos:</b> ${fmt(totalFijos)}
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ“Š Gastos Variables por Concepto</h3>
                    <table>
                        <tr>
                            <th>Concepto/Nombre</th>
                            <th>Cantidad</th>
                            <th>Total (ARS)</th>
                            <th>Promedio (ARS)</th>
                            <th>Ver Detalle</th>
                        </tr>
            `;
            
            for (const [nombre, gastos] of Object.entries(variablesPorNombre)) {
                const total = gastos.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
                const promedio = total / gastos.length;
                const id = nombre.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                
                html += `
                    <tr>
                        <td><b>${nombre}</b></td>
                        <td>${gastos.length}</td>
                        <td>${fmt(total)}</td>
                        <td>${fmt(promedio)}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="verDetalleGasto('${id}', 'variable')">ğŸ‘ï¸ Ver</button>
                        </td>
                    </tr>
                    <tr id="${id}_variable" style="display:none;">
                        <td colspan="5">
                            <div style="padding: 10px; background: #f8f9fa;">
                                <table style="margin: 0;">
                                    <tr><th>Fecha</th><th>Monto (ARS)</th><th>MÃ©todo</th></tr>
                    `;
                
                gastos.forEach(g => {
                    html += `
                        <tr>
                            <td>${fmtFecha(g.fecha)}</td>
                            <td>${fmt(g.monto)}</td>
                            <td>${g.metodo}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </table>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </table>
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <b>ğŸ’¡ Total Gastos Variables:</b> ${fmt(totalVariables)}
                    </div>
                </div>
            `;
            
            document.getElementById('gastosDetalle').innerHTML = html;
        }

        function verDetalleGasto(id, tipo) {
            const elemento = document.getElementById(id + '_' + tipo);
            if (elemento) {
                elemento.style.display = elemento.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function mostrarComprasView() {
            const comprasFiltradas = aplicarFiltros(datos.compras);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            
            let html = obtenerBadgePeriodo();
            html += `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-value">${fmt(totalCompras)}</div>
                    <div class="card-label">ğŸ›’ Total Compras Registradas</div>
                </div>
            `;
            
            if (datos.filtros.activo) {
                html += '<div class="alert alert-info">ğŸ” Mostrando ' + comprasFiltradas.length + ' de ' + datos.compras.length + ' compras (filtro activo)</div>';
            }
            
            html += '<h3>ğŸ“‹ Lista de Compras</h3>';
            
            if (comprasFiltradas.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay compras ' + (datos.filtros.activo ? 'que coincidan con el filtro.' : 'registradas. Ir a la ventana "ğŸ“ Carga" para cargar compras desde Excel o registrarlas manualmente.') + '</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>DescripciÃ³n</th><th>Proveedor</th><th>Monto (ARS)</th><th>MÃ©todo</th><th>CategorÃ­a</th><th></th></tr>';
                comprasFiltradas.forEach((comp) => {
                    const indiceReal = datos.compras.indexOf(comp);
                    html += `<tr>
                        <td>${fmtFecha(comp.fecha)}</td>
                        <td>${comp.desc}</td>
                        <td>${comp.prov}</td>
                        <td>${fmt(comp.monto)}</td>
                        <td>${comp.metodo}</td>
                        <td>${comp.cat}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarCompra(${indiceReal})">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                html += '</table>';
            }

            document.getElementById('listaCompras').innerHTML = html;
        }

        function eliminarCompra(i) {
            if (confirm('Â¿Eliminar esta compra?')) {
                datos.compras.splice(i, 1);
                guardarDatos();
                mostrarComprasView();
                actualizarDash();
                notif('âœ… Compra eliminada', 'success');
            }
        }

        function mostrarIngresos() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalRetenciones = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.retencion || 0), 0);
            const totalBruto = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.montoBruto || i.monto || 0), 0);

            let html = obtenerBadgePeriodo();
            html += `
                <div class="grid-3">
                    <div class="card">
                        <div class="card-value">${fmt(totalBruto)}</div>
                        <div class="card-label">ğŸ“Š Total Bruto</div>
                    </div>
                    <div class="card">
                        <div class="card-value">${fmt(totalRetenciones)}</div>
                        <div class="card-label">ğŸ”´ Retenciones</div>
                    </div>
                    <div class="card">
                        <div class="card-value">${fmt(totalIngresos)}</div>
                        <div class="card-label">ğŸ’° Total Neto</div>
                    </div>
                </div>
            `;

            if (datos.filtros.activo) {
                html += '<div class="alert alert-info">ğŸ” Mostrando ' + ingresosFiltrados.length + ' de ' + datos.ingresos.length + ' ingresos (filtro activo)</div>';
            }

            html += '<h3>ğŸ“‹ Lista de Ingresos</h3>';

            if (ingresosFiltrados.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay ingresos ' + (datos.filtros.activo ? 'que coincidan con el filtro.' : 'registrados. Ve a "ğŸ“ Carga" para cargar ingresos desde Excel o registrarlos manualmente.') + '</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>DescripciÃ³n</th><th>Bruto (ARS)</th><th>Retenciones (ARS)</th><th>Neto (ARS)</th><th>MÃ©todo</th><th>CategorÃ­a</th><th></th></tr>';
                ingresosFiltrados.forEach((ing) => {
                    const indiceReal = datos.ingresos.indexOf(ing);
                    
                    html += `<tr>
                        <td>${fmtFecha(ing.fecha)}</td>
                        <td>${ing.desc}</td>
                        <td>${fmt(ing.montoBruto || ing.monto)}</td>
                        <td style="color: #dc3545;"><b>${fmt(ing.retencion || 0)}</b></td>
                        <td style="color: #28a745;"><b>${fmt(ing.monto)}</b></td>
                        <td>${ing.metodo}</td>
                        <td>${ing.cat}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarIngreso(${indiceReal})">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                html += '</table>';
            }

            document.getElementById('listaIngresos').innerHTML = html;
        }

        function eliminarIngreso(i) {
            if (confirm('Â¿Eliminar este ingreso?')) {
                datos.ingresos.splice(i, 1);
                guardarDatos();
                mostrarIngresos();
                actualizarDash();
                notif('âœ… Ingreso eliminado', 'success');
            }
        }

        // ============ CLIENTES ============
        function mostrarClientes() {
            let html = obtenerBadgePeriodo();
            
            if (datos.clientes.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay clientes registrados. UsÃ¡ el formulario de arriba para agregar tu primer cliente.</div>';
            } else {
                html += '<table><tr><th>Nombre</th><th>Contacto</th><th>Email</th><th>Deuda (ARS)</th><th>Estado</th><th></th></tr>';
                
                datos.clientes.forEach((c, i) => {
                    const deudaARS = (c.deuda || 0) * datos.config.tipoCambioBNA;
                    const estado = deudaARS > 0 ? 'âŒ Debe' : 'âœ… Al dÃ­a';
                    const clase = deudaARS > 0 ? 'vencido' : '';
                    html += `<tr class="${clase}">
                        <td>${c.nombre}</td>
                        <td>${c.contacto || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>$${Math.round(deudaARS).toLocaleString('es-AR')} ARS</td>
                        <td>${estado}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="cobrarCliente(${i})">ğŸ’°</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCliente(${i})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('listaClientes').innerHTML = html;
        }

        function agregarCliente() {
            const nombre = document.getElementById('cliNombre').value;
            const contacto = document.getElementById('cliContacto').value;
            const email = document.getElementById('cliEmail').value;
            const deudaARS = parseFloat(document.getElementById('cliDeuda').value) || 0;
            const deudaUSD = deudaARS / datos.config.tipoCambioBNA;

            if (!nombre) { notif('âš ï¸ Ingresa el nombre', 'warning'); return; }

            datos.clientes.push({ nombre, contacto, email, deuda: deudaUSD, historial: [] });
            guardarDatos();
            mostrarClientes();
            notif('âœ… Cliente agregado', 'success');
            
            document.getElementById('cliNombre').value = '';
            document.getElementById('cliContacto').value = '';
            document.getElementById('cliEmail').value = '';
            document.getElementById('cliDeuda').value = '';
        }

        function cobrarCliente(i) {
            const deudaActualARS = (datos.clientes[i].deuda || 0) * datos.config.tipoCambioBNA;
            const montoARS = parseFloat(prompt('Â¿CuÃ¡nto cobrÃ³? (en ARS)', Math.round(deudaActualARS)));
            if (montoARS && montoARS > 0) {
                const montoUSD = montoARS / datos.config.tipoCambioBNA;
                datos.clientes[i].deuda = Math.max(0, (datos.clientes[i].deuda || 0) - montoUSD);
                datos.clientes[i].historial = datos.clientes[i].historial || [];
                datos.clientes[i].historial.push({
                    fecha: new Date().toISOString().split('T')[0],
                    monto: montoUSD,
                    tipo: 'cobro'
                });
                guardarDatos();
                mostrarClientes();
                notif('âœ… Cobro registrado: $' + Math.round(montoARS).toLocaleString('es-AR') + ' ARS', 'success');
            }
        }

        function eliminarCliente(i) {
            if (confirm('Â¿Eliminar este cliente?')) {
                datos.clientes.splice(i, 1);
                guardarDatos();
                mostrarClientes();
                notif('âœ… Cliente eliminado', 'success');
            }
        }

        // ============ PROVEEDORES ============
        function mostrarProveedores() {
            let html = obtenerBadgePeriodo();
            
            if (datos.proveedores.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay proveedores registrados. UsÃ¡ el formulario de arriba para agregar tu primer proveedor.</div>';
            } else {
                html += '<table><tr><th>Nombre</th><th>Contacto</th><th>Email</th><th>Deuda (ARS)</th><th>Estado</th><th></th></tr>';
                
                datos.proveedores.forEach((p, i) => {
                    const deudaARS = (p.deuda || 0) * datos.config.tipoCambioBNA;
                    const estado = deudaARS > 0 ? 'âŒ Debemos' : 'âœ… Al dÃ­a';
                    const clase = deudaARS > 0 ? 'vencido' : '';
                    html += `<tr class="${clase}">
                        <td>${p.nombre}</td>
                        <td>${p.contacto || '-'}</td>
                        <td>${p.email || '-'}</td>
                        <td>$${Math.round(deudaARS).toLocaleString('es-AR')} ARS</td>
                        <td>${estado}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="pagarProveedor(${i})">ğŸ’¸</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarProveedor(${i})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('listaProveedores').innerHTML = html;
        }

        function agregarProveedor() {
            const nombre = document.getElementById('provNombre').value;
            const contacto = document.getElementById('provContacto').value;
            const email = document.getElementById('provEmail').value;
            const deudaARS = parseFloat(document.getElementById('provDeuda').value) || 0;
            const deudaUSD = deudaARS / datos.config.tipoCambioBNA;

            if (!nombre) { notif('âš ï¸ Ingresa el nombre', 'warning'); return; }

            datos.proveedores.push({ nombre, contacto, email, deuda: deudaUSD, historial: [] });
            guardarDatos();
            mostrarProveedores();
            notif('âœ… Proveedor agregado', 'success');
            
            document.getElementById('provNombre').value = '';
            document.getElementById('provContacto').value = '';
            document.getElementById('provEmail').value = '';
            document.getElementById('provDeuda').value = '';
        }

        function pagarProveedor(i) {
            const deudaActualARS = (datos.proveedores[i].deuda || 0) * datos.config.tipoCambioBNA;
            const montoARS = parseFloat(prompt('Â¿CuÃ¡nto pagÃ³? (en ARS)', Math.round(deudaActualARS)));
            if (montoARS && montoARS > 0) {
                const montoUSD = montoARS / datos.config.tipoCambioBNA;
                datos.proveedores[i].deuda = Math.max(0, (datos.proveedores[i].deuda || 0) - montoUSD);
                datos.proveedores[i].historial = datos.proveedores[i].historial || [];
                datos.proveedores[i].historial.push({
                    fecha: new Date().toISOString().split('T')[0],
                    monto: montoUSD,
                    tipo: 'pago'
                });
                guardarDatos();
                mostrarProveedores();
                notif('âœ… Pago registrado: $' + Math.round(montoARS).toLocaleString('es-AR') + ' ARS', 'success');
            }
        }

        function eliminarProveedor(i) {
            if (confirm('Â¿Eliminar este proveedor?')) {
                datos.proveedores.splice(i, 1);
                guardarDatos();
                mostrarProveedores();
                notif('âœ… Proveedor eliminado', 'success');
            }
        }

        // ============ EMPLEADOS ============
        function mostrarEmpleados() {
            let html = '<div class="section"><h3>â• Agregar Empleado</h3>';
            html += '<div class="alert alert-info">Ingresa el sueldo en <b>Pesos Argentinos (ARS)</b></div>';
            html += '<div class="grid-4"><input type="text" id="empNombre" placeholder="Nombre"><input type="text" id="empPuesto" placeholder="Puesto"><input type="number" id="empSueldo" placeholder="Sueldo (ARS)" step="1000"><button class="btn btn-success" onclick="agregarEmpleado()">âœ… Agregar</button></div></div>';
            
            html += '<div class="section"><h3>ğŸ‘” Lista de Empleados y Adelantos</h3>';
            
            if (datos.empleados.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay empleados registrados</div>';
            } else {
                html += '<table><tr><th>Nombre</th><th>Puesto</th><th>Sueldo Mensual (ARS)</th><th>Adelantos</th><th>Debe Devolver</th><th>Acciones</th></tr>';
                datos.empleados.forEach((e, i) => {
                    const sueldoARS = (e.sueldo || 0) * datos.config.tipoCambioBNA;
                    const totalAdelantos = (e.adelantos || []).reduce((s, a) => s + parseFloat(a.monto || 0), 0) * datos.config.tipoCambioBNA;
                    const cantAdelantos = (e.adelantos || []).length;
                    
                    html += `<tr>
                        <td><b>${e.nombre}</b></td>
                        <td>${e.puesto || '-'}</td>
                        <td>$${Math.round(sueldoARS).toLocaleString('es-AR')} ARS</td>
                        <td><span class="badge badge-info">${cantAdelantos} adelantos</span></td>
                        <td><span class="badge ${totalAdelantos > 0 ? 'badge-fijo' : 'badge-variable'}" style="background: ${totalAdelantos > 0 ? '#ffc107' : '#28a745'};"><b>$${Math.round(totalAdelantos).toLocaleString('es-AR')} ARS</b></span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="abrirModalPagarSueldo(${i})" title="Pagar sueldo">ğŸ’° Pagar</button>
                            <button class="btn btn-info btn-sm" onclick="abrirModalAdelanto(${i})" title="Agregar adelanto">ğŸ’µ Adelanto</button>
                            <button class="btn btn-warning btn-sm" onclick="verAdelantosEmpleado(${i})" title="Ver adelantos">ğŸ‘ï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEmpleado(${i})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                
                const sueldosTotales = datos.empleados.reduce((sum, e) => sum + ((e.sueldo || 0) * datos.config.tipoCambioBNA), 0);
                const adelantosTotales = datos.empleados.reduce((sum, e) => sum + ((e.adelantos || []).reduce((s, a) => s + parseFloat(a.monto || 0), 0) * datos.config.tipoCambioBNA), 0);
                
                html += `<div class="alert alert-success" style="margin-top: 15px;">
                    <b>ğŸ’° Total NÃ³mina Mensual:</b> $${Math.round(sueldosTotales).toLocaleString('es-AR')} ARS<br>
                    <b>ğŸ’µ Total Adelantos Pendientes:</b> $${Math.round(adelantosTotales).toLocaleString('es-AR')} ARS<br>
                    <b>ğŸ“Š NÃ³mina Neta (despuÃ©s de descontar adelantos):</b> $${Math.round(sueldosTotales - adelantosTotales).toLocaleString('es-AR')} ARS
                </div>`;
            }
            
            html += '</div>';

            // Modal para agregar adelanto
            html += `
                <div id="modalAdelanto" style="display:none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0; color: #333;">ğŸ’µ Registrar Adelanto de Sueldo</h3>
                        <p id="modalEmpleadoNombre" style="color: #666; margin-bottom: 20px;"></p>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Monto del Adelanto (ARS)</b></label>
                            <input type="number" id="adelantoMonto" placeholder="Ej: 50000" step="1000">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Concepto/Motivo</b></label>
                            <input type="text" id="adelantoConcepto" placeholder="Ej: Adelanto por urgencia">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Fecha</b></label>
                            <input type="date" id="adelantoFecha" value="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Â¿Es descuento del prÃ³ximo sueldo?</b></label>
                            <select id="adelantoDescuento">
                                <option value="si">SÃ­ - Descontar del sueldo</option>
                                <option value="no">No - Deuda pendiente</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-warning" onclick="cerrarModalAdelanto()">Cancelar</button>
                            <button class="btn btn-success" onclick="guardarAdelanto()">âœ… Registrar Adelanto</button>
                        </div>
                    </div>
                </div>
            `;

            // Modal para pagar sueldo
            html += `
                <div id="modalPagarSueldo" style="display:none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #333;">ğŸ’° Pagar Sueldo</h3>
                        <p id="modalPagarEmpleadoNombre" style="color: #666; margin-bottom: 20px;"></p>
                        
                        <div id="resumenPagoSueldo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <!-- Se llena dinÃ¡micamente -->
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>MÃ©todo de Pago</b></label>
                            <select id="metodoPagoSueldo">
                                <option value="efectivo">ğŸ’µ Efectivo</option>
                                <option value="transferencia">ğŸ¦ Transferencia Bancaria</option>
                                <option value="cheque">ğŸ“„ Cheque</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Fecha de Pago</b></label>
                            <input type="date" id="fechaPagoSueldo" value="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;"><b>Observaciones (opcional)</b></label>
                            <textarea id="obsPagoSueldo" placeholder="Notas adicionales..." style="min-height: 60px;"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-warning" onclick="cerrarModalPagarSueldo()">Cancelar</button>
                            <button class="btn btn-success" onclick="confirmarPagoSueldo()">âœ… Confirmar Pago</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('listaEmp').innerHTML = html;
        }

        function abrirModalAdelanto(i) {
            if (!datos.empleados[i]) return;
            document.getElementById('modalEmpleadoNombre').textContent = 'ğŸ‘¤ Empleado: ' + datos.empleados[i].nombre;
            document.getElementById('adelantoMonto').value = '';
            document.getElementById('adelantoConcepto').value = '';
            document.getElementById('adelantoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('adelantoDescuento').value = 'si';
            
            window.empleadoAdelantoIndex = i;
            document.getElementById('modalAdelanto').style.display = 'flex';
        }

        function cerrarModalAdelanto() {
            document.getElementById('modalAdelanto').style.display = 'none';
        }

        function guardarAdelanto() {
            const i = window.empleadoAdelantoIndex;
            const montoARS = parseFloat(document.getElementById('adelantoMonto').value) || 0;
            const concepto = document.getElementById('adelantoConcepto').value || 'Adelanto de sueldo';
            const fecha = document.getElementById('adelantoFecha').value;
            const esDescuento = document.getElementById('adelantoDescuento').value === 'si';
            
            if (montoARS <= 0) {
                notif('âš ï¸ Ingresa un monto vÃ¡lido', 'warning');
                return;
            }
            
            const montoUSD = montoARS / datos.config.tipoCambioBNA;
            
            if (!datos.empleados[i].adelantos) {
                datos.empleados[i].adelantos = [];
            }
            
            datos.empleados[i].adelantos.push({
                monto: montoUSD,
                concepto: concepto,
                fecha: fecha,
                esDescuento: esDescuento,
                estado: 'pendiente'
            });
            
            guardarDatos();
            mostrarEmpleados();
            cerrarModalAdelanto();
            notif('âœ… Adelanto registrado para ' + datos.empleados[i].nombre + ': $' + Math.round(montoARS).toLocaleString('es-AR') + ' ARS', 'success');
        }

        // ============= FUNCIONES PARA PAGAR SUELDO =============
        function abrirModalPagarSueldo(i) {
            if (!datos.empleados[i]) return;
            
            const empleado = datos.empleados[i];
            const sueldoARS = (empleado.sueldo || 0) * datos.config.tipoCambioBNA;
            const adelantosPendientes = (empleado.adelantos || []).filter(a => a.estado === 'pendiente' && a.esDescuento);
            const totalAdelantosARS = adelantosPendientes.reduce((s, a) => s + parseFloat(a.monto || 0), 0) * datos.config.tipoCambioBNA;
            const sueldoNeto = sueldoARS - totalAdelantosARS;
            
            document.getElementById('modalPagarEmpleadoNombre').textContent = 'ğŸ‘¤ Empleado: ' + empleado.nombre + ' - ' + (empleado.puesto || 'Sin puesto');
            
            let resumenHTML = `
                <div style="border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ğŸ’¼ Sueldo Base:</span>
                        <span style="font-weight: bold;">$${Math.round(sueldoARS).toLocaleString('es-AR')} ARS</span>
                    </div>
            `;
            
            if (adelantosPendientes.length > 0) {
                resumenHTML += `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #856404;">ğŸ“‹ Adelantos a descontar:</div>
                `;
                adelantosPendientes.forEach(a => {
                    const montoARS = parseFloat(a.monto || 0) * datos.config.tipoCambioBNA;
                    resumenHTML += `
                        <div style="display: flex; justify-content: space-between; font-size: 13px; color: #856404; margin: 4px 0;">
                            <span>- ${a.concepto || 'Adelanto'} (${a.fecha || 'S/F'})</span>
                            <span style="color: #dc3545;">-$${Math.round(montoARS).toLocaleString('es-AR')}</span>
                        </div>
                    `;
                });
                resumenHTML += `</div>`;
                
                resumenHTML += `
                    <div style="display: flex; justify-content: space-between; color: #dc3545; margin-bottom: 8px;">
                        <span>â– Total Descuentos:</span>
                        <span style="font-weight: bold;">-$${Math.round(totalAdelantosARS).toLocaleString('es-AR')} ARS</span>
                    </div>
                `;
            }
            
            resumenHTML += `
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; background: ${sueldoNeto >= 0 ? '#d4edda' : '#f8d7da'}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                    <span style="font-weight: bold;">ğŸ’° SUELDO NETO A PAGAR:</span>
                    <span style="font-weight: bold; color: ${sueldoNeto >= 0 ? '#155724' : '#721c24'};">$${Math.round(sueldoNeto).toLocaleString('es-AR')} ARS</span>
                </div>
            `;
            
            document.getElementById('resumenPagoSueldo').innerHTML = resumenHTML;
            document.getElementById('metodoPagoSueldo').value = 'efectivo';
            document.getElementById('fechaPagoSueldo').value = new Date().toISOString().split('T')[0];
            document.getElementById('obsPagoSueldo').value = '';
            
            window.empleadoPagoIndex = i;
            document.getElementById('modalPagarSueldo').style.display = 'flex';
        }

        function cerrarModalPagarSueldo() {
            document.getElementById('modalPagarSueldo').style.display = 'none';
        }

        function confirmarPagoSueldo() {
            const i = window.empleadoPagoIndex;
            if (!datos.empleados[i]) return;
            
            const empleado = datos.empleados[i];
            const sueldoARS = (empleado.sueldo || 0) * datos.config.tipoCambioBNA;
            const adelantosPendientes = (empleado.adelantos || []).filter(a => a.estado === 'pendiente' && a.esDescuento);
            const totalAdelantosARS = adelantosPendientes.reduce((s, a) => s + parseFloat(a.monto || 0), 0) * datos.config.tipoCambioBNA;
            const sueldoNeto = sueldoARS - totalAdelantosARS;
            
            const metodoPago = document.getElementById('metodoPagoSueldo').value;
            const fechaPago = document.getElementById('fechaPagoSueldo').value;
            const observaciones = document.getElementById('obsPagoSueldo').value;
            
            // Marcar adelantos como pagados
            if (empleado.adelantos) {
                empleado.adelantos.forEach(a => {
                    if (a.estado === 'pendiente' && a.esDescuento) {
                        a.estado = 'descontado';
                        a.fechaDescuento = fechaPago;
                    }
                });
            }
            
            // Registrar historial de pago
            if (!empleado.historialPagos) {
                empleado.historialPagos = [];
            }
            empleado.historialPagos.push({
                fecha: fechaPago,
                sueldoBruto: sueldoARS / datos.config.tipoCambioBNA,
                descuentos: totalAdelantosARS / datos.config.tipoCambioBNA,
                sueldoNeto: sueldoNeto / datos.config.tipoCambioBNA,
                metodoPago: metodoPago,
                observaciones: observaciones
            });
            
            // Registrar movimiento en tesorerÃ­a
            const metodosTexto = {
                'efectivo': 'ğŸ’µ Efectivo',
                'transferencia': 'ğŸ¦ Transferencia',
                'cheque': 'ğŸ“„ Cheque'
            };
            
            datos.movimientos.push({
                tipo: 'egreso',
                categoria: 'Sueldos',
                concepto: `Pago sueldo ${empleado.nombre} (${metodosTexto[metodoPago]})`,
                monto: sueldoNeto / datos.config.tipoCambioBNA,
                fecha: fechaPago,
                metodoPago: metodoPago
            });
            
            guardarDatos();
            mostrarEmpleados();
            cerrarModalPagarSueldo();
            
            notif(`âœ… Sueldo pagado a ${empleado.nombre}: $${Math.round(sueldoNeto).toLocaleString('es-AR')} ARS (${metodosTexto[metodoPago]})`, 'success');
        }
        // ============= FIN FUNCIONES PAGAR SUELDO =============

        function verAdelantosEmpleado(i) {
            if (!datos.empleados[i]) return;
            
            const empleado = datos.empleados[i];
            const adelantos = empleado.adelantos || [];
            const totalAdelantos = adelantos.reduce((s, a) => s + parseFloat(a.monto || 0), 0);
            const sueldoARS = (empleado.sueldo || 0) * datos.config.tipoCambioBNA;
            
            let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">ğŸ‘¤ Adelantos de ${empleado.nombre}</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer;">âœ•</button>
                        </div>

                        <div class="grid-3" style="margin-bottom: 20px;">
                            <div class="card">
                                <div class="card-value">$${Math.round(sueldoARS).toLocaleString('es-AR')}</div>
                                <div class="card-label">Sueldo Mensual</div>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <div class="card-value">$${Math.round(totalAdelantos * datos.config.tipoCambioBNA).toLocaleString('es-AR')}</div>
                                <div class="card-label">Total Adelantos</div>
                            </div>
                            <div class="card" style="background: ${(sueldoARS - totalAdelantos * datos.config.tipoCambioBNA) >= 0 ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #dc3545, #c82333)'};">
                                <div class="card-value">$${Math.round(sueldoARS - totalAdelantos * datos.config.tipoCambioBNA).toLocaleString('es-AR')}</div>
                                <div class="card-label">Neto a Pagar</div>
                            </div>
                        </div>

                        ${adelantos.length === 0 ? 
                            '<div class="alert alert-success">âœ… Sin adelantos registrados</div>' : 
                            `<table style="width: 100%; font-size: 13px;">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th style="text-align: right;">Monto (ARS)</th>
                                    <th style="text-align: center;">Tipo</th>
                                    <th style="text-align: center;">Estado</th>
                                    <th style="text-align: center;">AcciÃ³n</th>
                                </tr>
                                ${adelantos.map((a, idx) => {
                                    const montoARS = (a.monto || 0) * datos.config.tipoCambioBNA;
                                    return `<tr>
                                        <td>${new Date(a.fecha).toLocaleDateString('es-AR')}</td>
                                        <td>${a.concepto}</td>
                                        <td style="text-align: right;"><b>$${Math.round(montoARS).toLocaleString('es-AR')}</b></td>
                                        <td style="text-align: center;">${a.esDescuento ? 'ğŸ“‰ Descuento' : 'â³ Deuda'}</td>
                                        <td style="text-align: center;"><span class="badge" style="background: ${a.estado === 'pagado' ? '#28a745' : '#ffc107'}; color: white;">${a.estado === 'pagado' ? 'Pagado' : 'Pendiente'}</span></td>
                                        <td style="text-align: center;">
                                            ${a.estado === 'pendiente' ? `<button class="btn btn-sm btn-success" onclick="marcarAdelantoPagado(${i}, ${idx})" style="padding: 4px 8px; font-size: 11px;">âœ…</button>` : ''}
                                            <button class="btn btn-sm btn-danger" onclick="eliminarAdelanto(${i}, ${idx})" style="padding: 4px 8px; font-size: 11px;">ğŸ—‘ï¸</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </table>`
                        }
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function marcarAdelantoPagado(i, idx) {
            if (datos.empleados[i] && datos.empleados[i].adelantos && datos.empleados[i].adelantos[idx]) {
                datos.empleados[i].adelantos[idx].estado = 'pagado';
                datos.empleados[i].adelantos[idx].fechaPago = new Date().toISOString().split('T')[0];
                guardarDatos();
                verAdelantosEmpleado(i);
                notif('âœ… Adelanto marcado como pagado', 'success');
            }
        }

        function eliminarAdelanto(i, idx) {
            if (confirm('Â¿Eliminar este adelanto?')) {
                if (datos.empleados[i] && datos.empleados[i].adelantos) {
                    datos.empleados[i].adelantos.splice(idx, 1);
                    guardarDatos();
                    verAdelantosEmpleado(i);
                    notif('âœ… Adelanto eliminado', 'success');
                }
            }
        }

        function agregarEmpleado() {
            const nombre = document.getElementById('empNombre').value.trim();
            const puesto = document.getElementById('empPuesto').value.trim();
            const sueldoARS = parseFloat(document.getElementById('empSueldo').value) || 0;
            
            if (!nombre) {
                notif('âš ï¸ Ingresa el nombre del empleado', 'warning');
                return;
            }
            
            if (sueldoARS <= 0) {
                notif('âš ï¸ Ingresa un sueldo vÃ¡lido', 'warning');
                return;
            }
            
            // Convertir sueldo ARS a USD para almacenar internamente
            const sueldoUSD = sueldoARS / datos.config.tipoCambioBNA;
            
            datos.empleados.push({
                nombre: nombre,
                puesto: puesto || 'Sin especificar',
                sueldo: sueldoUSD,
                adelantos: [],
                fechaIngreso: new Date().toISOString().split('T')[0]
            });
            
            guardarDatos();
            mostrarEmpleados();
            
            // Limpiar campos
            document.getElementById('empNombre').value = '';
            document.getElementById('empPuesto').value = '';
            document.getElementById('empSueldo').value = '';
            
            notif('âœ… Empleado ' + nombre + ' agregado correctamente', 'success');
        }

        function eliminarEmpleado(i) {
            if (!datos.empleados[i]) return;
            
            const nombre = datos.empleados[i].nombre;
            
            if (confirm('Â¿Eliminar al empleado "' + nombre + '"? Esta acciÃ³n no se puede deshacer.')) {
                datos.empleados.splice(i, 1);
                guardarDatos();
                mostrarEmpleados();
                notif('âœ… Empleado ' + nombre + ' eliminado', 'success');
            }
        }

        // ============ AHORROS ============
        function mostrarAhorros() {
            const tipoCambio = datos.config.tipoCambioBNA;
            const monedaMeta = datos.ahorros.monedaMeta || 'ARS';
            const monedaActual = datos.ahorros.monedaActual || 'ARS';
            
            // Inicializar cuentas personalizadas si no existen
            if (!datos.ahorros.cuentas) {
                datos.ahorros.cuentas = [];
                // Migrar billeteras de inversiones si existen
                if (datos.inversiones && datos.inversiones.billeteras) {
                    const iconos = { brubank: 'ğŸ¦', prex: 'ğŸ’³', binance: 'ğŸª™', galeriaGalicia: 'ğŸ›ï¸', naranjaX: 'ğŸŸ ', balanz: 'âš–ï¸' };
                    const nombres = { brubank: 'Brubank', prex: 'Prex', binance: 'Binance', galeriaGalicia: 'Banco Galicia', naranjaX: 'Naranja X', balanz: 'Balanz' };
                    for (let key in datos.inversiones.billeteras) {
                        if (datos.inversiones.billeteras[key] > 0) {
                            datos.ahorros.cuentas.push({
                                nombre: nombres[key] || key,
                                icono: iconos[key] || 'ğŸ’°',
                                monto: datos.inversiones.billeteras[key],
                                moneda: 'ARS'
                            });
                        }
                    }
                }
                // Migrar cuentas de inversiones si existen
                if (datos.inversiones && datos.inversiones.cuentas) {
                    datos.inversiones.cuentas.forEach(c => {
                        datos.ahorros.cuentas.push({...c});
                    });
                }
            }
            
            // Calcular totales de cuentas
            let totalCuentasARS = 0;
            let totalCuentasUSD = 0;
            datos.ahorros.cuentas.forEach(c => {
                if (c.moneda === 'USD') {
                    totalCuentasUSD += c.monto || 0;
                    totalCuentasARS += (c.monto || 0) * tipoCambio;
                } else {
                    totalCuentasARS += c.monto || 0;
                }
            });
            
            // Convertir meta para mostrar
            const metaARS = monedaMeta === 'USD' ? (datos.ahorros.meta || 0) * tipoCambio : (datos.ahorros.meta || 0);
            const progreso = metaARS > 0 ? Math.min(100, (totalCuentasARS / metaARS) * 100) : 0;
            const faltante = Math.max(0, metaARS - totalCuentasARS);
            
            let html = '';
            
            // ============ SECCIÃ“N META DE AHORROS ============
            html += '<div class="section"><h3>ğŸ¯ Meta de Ahorros / JubilaciÃ³n</h3>';
            html += '<div class="alert alert-info">ConfigurÃ¡ tu meta en <b>Pesos Argentinos</b> o <b>DÃ³lares</b></div>';
            html += '<div class="grid-2">';
            html += '<div>';
            html += '<label>Meta:</label>';
            html += '<div style="display: flex; gap: 10px;">';
            html += `<input type="number" id="metaAhorros" value="${datos.ahorros.meta || 0}" placeholder="Monto" step="0.01" style="flex: 1;">`;
            html += `<select id="monedaMetaAhorro" style="flex: 0.4;"><option value="ARS" ${monedaMeta === 'ARS' ? 'selected' : ''}>ARS</option><option value="USD" ${monedaMeta === 'USD' ? 'selected' : ''}>USD</option></select>`;
            html += '</div>';
            html += '</div>';
            html += '<div>';
            html += '<label>Perfil de Riesgo:</label>';
            html += `<select id="perfilRiesgo" style="width: 100%;"><option value="conservador" ${(datos.ahorros.perfilRiesgo || 'moderado') === 'conservador' ? 'selected' : ''}>ğŸ‘´ Conservador</option><option value="moderado" ${(datos.ahorros.perfilRiesgo || 'moderado') === 'moderado' ? 'selected' : ''}>ğŸ¤ Moderado</option><option value="agresivo" ${(datos.ahorros.perfilRiesgo || 'moderado') === 'agresivo' ? 'selected' : ''}>ğŸš€ Agresivo</option></select>`;
            html += '</div>';
            html += '</div>';
            html += '<button class="btn btn-success" onclick="guardarMetaAhorros()" style="margin-top: 10px; width: 100%;">ğŸ’¾ Guardar Meta</button>';
            html += '</div>';
            
            // ============ SECCIÃ“N AGREGAR CUENTA ============
            html += '<div class="section"><h3>â• Agregar Nueva Cuenta/Billetera</h3>';
            html += '<div class="alert alert-info">PodÃ©s agregar cualquier cuenta, billetera o plataforma de inversiÃ³n</div>';
            html += '<div class="grid-4">';
            html += '<div><label>Icono:</label><select id="nuevaCuentaIcono" style="width: 100%;"><option value="ğŸ¦">ğŸ¦ Banco</option><option value="ğŸ’³">ğŸ’³ Tarjeta</option><option value="ğŸª™">ğŸª™ Crypto</option><option value="ğŸ“ˆ">ğŸ“ˆ InversiÃ³n</option><option value="ğŸ’µ">ğŸ’µ Efectivo</option><option value="ğŸ›ï¸">ğŸ›ï¸ InstituciÃ³n</option><option value="ğŸŸ ">ğŸŸ  Fintech</option><option value="âš–ï¸">âš–ï¸ Broker</option><option value="ğŸ’°">ğŸ’° Ahorro</option><option value="ğŸ·">ğŸ· AlcancÃ­a</option></select></div>';
            html += '<div><label>Nombre:</label><input type="text" id="nuevaCuentaNombre" placeholder="Ej: Brubank, IOL, etc"></div>';
            html += '<div><label>Monto:</label><input type="number" id="nuevaCuentaMonto" placeholder="0" step="0.01"></div>';
            html += '<div><label>Moneda:</label><select id="nuevaCuentaMoneda" style="width: 100%;"><option value="ARS">ğŸ‡¦ğŸ‡· ARS (Pesos)</option><option value="USD">ğŸ‡ºğŸ‡¸ USD (DÃ³lares)</option></select></div>';
            html += '</div>';
            html += '<button class="btn btn-success" onclick="agregarCuentaAhorro()" style="margin: 10px 0; width: 100%;">â• Agregar Cuenta</button>';
            html += '</div>';
            
            // ============ LISTA DE CUENTAS ============
            html += '<div class="section"><h3>ğŸ’³ Mis Cuentas y Billeteras</h3>';
            
            if (datos.ahorros.cuentas.length === 0) {
                html += '<div class="alert alert-info">ğŸ“‹ No hay cuentas registradas. Â¡AgregÃ¡ tu primera cuenta arriba!</div>';
            } else {
                html += '<table><tr><th>Cuenta</th><th>Monto</th><th>Moneda</th><th>Equiv. ARS</th><th>Acciones</th></tr>';
                datos.ahorros.cuentas.forEach((c, i) => {
                    const montoARS = c.moneda === 'USD' ? (c.monto || 0) * tipoCambio : (c.monto || 0);
                    html += `<tr>
                        <td><b>${c.icono} ${c.nombre}</b></td>
                        <td>$${(c.monto || 0).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td><span class="badge" style="background: ${c.moneda === 'USD' ? '#28a745' : '#667eea'}; color: white;">${c.moneda}</span></td>
                        <td>$${Math.round(montoARS).toLocaleString('es-AR')} ARS</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editarCuentaAhorro(${i})">âœï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCuentaAhorro(${i})">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
            }
            html += '</div>';
            
            // ============ RESUMEN VISUAL ============
            html += '<div class="section"><h3>ğŸ“Š Resumen de Inversiones</h3>';
            html += '<div class="grid-3">';
            datos.ahorros.cuentas.forEach(c => {
                const montoMostrar = c.moneda === 'USD' ? `$${(c.monto || 0).toLocaleString('es-AR', {minimumFractionDigits: 2})} USD` : `$${Math.round(c.monto || 0).toLocaleString('es-AR')} ARS`;
                html += `<div class="card" style="background: ${c.moneda === 'USD' ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #667eea, #764ba2)'};">
                    <div class="card-value">${montoMostrar}</div>
                    <div class="card-label">${c.icono} ${c.nombre}</div>
                </div>`;
            });
            html += '</div>';
            
            if (totalCuentasUSD > 0) {
                html += `<div class="alert alert-info" style="margin-top: 15px;">
                    <b>ğŸ’µ Total en USD:</b> $${totalCuentasUSD.toLocaleString('es-AR', {minimumFractionDigits: 2})} USD<br>
                    <b>ğŸ’° Total General (convertido a ARS):</b> $${Math.round(totalCuentasARS).toLocaleString('es-AR')} ARS
                </div>`;
            } else if (datos.ahorros.cuentas.length > 0) {
                html += `<div class="alert alert-success" style="margin-top: 15px;"><b>ğŸ’° Total en Cuentas:</b> $${Math.round(totalCuentasARS).toLocaleString('es-AR')} ARS</div>`;
            }
            html += '</div>';
            
            // ============ PROGRESO ============
            html += '<div class="section"><h3>ğŸ¯ Progreso Hacia la Meta</h3>';
            html += `<div class="grid-3">`;
            html += `<div class="card"><div class="card-value">$${Math.round(totalCuentasARS).toLocaleString('es-AR')} ARS</div><div class="card-label">ğŸ’° Total Ahorrado</div></div>`;
            html += `<div class="card"><div class="card-value">$${Math.round(metaARS).toLocaleString('es-AR')} ARS</div><div class="card-label">ğŸ¯ Meta</div></div>`;
            html += `<div class="card"><div class="card-value">${Math.round(progreso)}%</div><div class="card-label">ğŸ“ˆ Progreso</div></div>`;
            html += `</div>`;
            
            html += `<div class="progress-bar" style="margin: 15px 0;"><div class="progress-fill" style="width: ${progreso}%;"></div></div>`;
            
            if (metaARS > 0) {
                if (progreso < 100) {
                    html += `<div class="alert alert-warning"><b>âš ï¸ Te falta:</b> $${Math.round(faltante).toLocaleString('es-AR')} ARS para alcanzar tu meta</div>`;
                } else {
                    html += `<div class="alert alert-success"><b>âœ… Â¡Felicidades!</b> Has alcanzado tu meta ğŸ‰</div>`;
                }
            }
            html += '</div>';
            
            document.getElementById('panelAhorros').innerHTML = html;
        }

        function guardarMetaAhorros() {
            datos.ahorros.meta = parseFloat(document.getElementById('metaAhorros').value) || 0;
            datos.ahorros.monedaMeta = document.getElementById('monedaMetaAhorro').value;
            datos.ahorros.perfilRiesgo = document.getElementById('perfilRiesgo').value;
            guardarDatos();
            mostrarAhorros();
            notif('âœ… Meta actualizada', 'success');
        }

        function agregarCuentaAhorro() {
            const icono = document.getElementById('nuevaCuentaIcono').value;
            const nombre = document.getElementById('nuevaCuentaNombre').value.trim();
            const monto = parseFloat(document.getElementById('nuevaCuentaMonto').value) || 0;
            const moneda = document.getElementById('nuevaCuentaMoneda').value;
            
            if (!nombre) {
                notif('âš ï¸ IngresÃ¡ el nombre de la cuenta', 'warning');
                return;
            }
            
            if (!datos.ahorros.cuentas) {
                datos.ahorros.cuentas = [];
            }
            
            datos.ahorros.cuentas.push({
                nombre: nombre,
                icono: icono,
                monto: monto,
                moneda: moneda
            });
            
            guardarDatos();
            mostrarAhorros();
            
            document.getElementById('nuevaCuentaNombre').value = '';
            document.getElementById('nuevaCuentaMonto').value = '';
            
            notif('âœ… Cuenta "' + nombre + '" agregada correctamente', 'success');
        }

        function editarCuentaAhorro(i) {
            if (!datos.ahorros.cuentas[i]) return;
            
            const cuenta = datos.ahorros.cuentas[i];
            const nuevoMonto = prompt('Nuevo monto para ' + cuenta.nombre + ' (' + cuenta.moneda + '):', cuenta.monto);
            
            if (nuevoMonto !== null) {
                datos.ahorros.cuentas[i].monto = parseFloat(nuevoMonto) || 0;
                guardarDatos();
                mostrarAhorros();
                notif('âœ… Cuenta actualizada', 'success');
            }
        }

        function eliminarCuentaAhorro(i) {
            if (!datos.ahorros.cuentas[i]) return;
            
            const nombre = datos.ahorros.cuentas[i].nombre;
            
            if (confirm('Â¿Eliminar la cuenta "' + nombre + '"?')) {
                datos.ahorros.cuentas.splice(i, 1);
                guardarDatos();
                mostrarAhorros();
                notif('âœ… Cuenta "' + nombre + '" eliminada', 'success');
            }
        }

        function actualizarAhorros() {
            // FunciÃ³n legacy para compatibilidad
            guardarMetaAhorros();
        }

        // ============ INVERSIONES (Legacy - Redirige a Ahorros) ============
        function mostrarInversiones() {
            // Redirigir a ahorros
            cambiarTab('ahorros');
        }

        function agregarCuentaInversion() {
            agregarCuentaAhorro();
        }

        function editarCuentaInversion(i) {
            editarCuentaAhorro(i);
        }

        function eliminarCuentaInversion(i) {
            eliminarCuentaAhorro(i);
        }

        function guardarInversiones() {
            guardarMetaAhorros();
        }

        function guardarBilleteras() {
            // FunciÃ³n legacy para compatibilidad
            guardarDatos();
            mostrarInversiones();
            notif('âœ… Billeteras actualizadas', 'success');
        }

// ============ ESTADO DE RESULTADOS ECONÃ“MICO ============
        function mostrarEstadoResultados() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);

            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            const gastosFijos = gastosFiltrados.filter(g => !g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const gastosVariables = gastosFiltrados.filter(g => g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            
            const gananciaaBruta = totalIngresos - totalCompras;
            const totalGastosOperativos = gastosFijos + gastosVariables;
            const ebitda = gananciaaBruta - totalGastosOperativos;
            const impuestosEstimados = Math.max(0, ebitda * 0.17);
            const gananciaNeta = ebitda - impuestosEstimados;

            let html = `
                <div class="section">
                    <h3>ğŸ“Š ESTADO DE RESULTADOS ECONÃ“MICO</h3>
                    <div style="overflow-x: auto;">
                        <div class="estado-resultados-row header">
                            <div><b>Concepto</b></div>
                            <div style="text-align: right;"><b>Monto (ARS)</b></div>
                            <div style="text-align: right;"><b>% Ingresos</b></div>
                        </div>

                        <div class="estado-resultados-row">
                            <div><b>1. INGRESOS TOTALES</b></div>
                            <div style="text-align: right;"><b>${fmt(totalIngresos)}</b></div>
                            <div style="text-align: right;"><b>100.0%</b></div>
                        </div>

                        <div class="estado-resultados-row">
                            <div><b>2. (-) COSTO DE MERCADERÃA VENDIDA</b></div>
                            <div style="text-align: right;"><b>${fmt(totalCompras)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((totalCompras / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>

                        <div class="estado-resultados-row subtotal">
                            <div>=== GANANCIA BRUTA ===</div>
                            <div style="text-align: right;"><b>${fmt(gananciaaBruta)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((gananciaaBruta / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>

                        <div class="estado-resultados-row" style="margin-top: 10px;">
                            <div><b>3. (-) GASTOS OPERATIVOS</b></div>
                            <div style="text-align: right;"><b>${fmt(totalGastosOperativos)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((totalGastosOperativos / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>

                        <div class="estado-resultados-row subtotal" style="margin-top: 10px;">
                            <div>=== EBITDA (Ganancia Operativa) ===</div>
                            <div style="text-align: right;"><b>${fmt(ebitda)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((ebitda / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>

                        <div class="estado-resultados-row" style="margin-top: 10px;">
                            <div><b>4. (-) IMPUESTOS ESTIMADOS (IVA ~17%)</b></div>
                            <div style="text-align: right;"><b>${fmt(impuestosEstimados)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((impuestosEstimados / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>

                        <div class="estado-resultados-row total" style="margin-top: 10px; background: ${gananciaNeta >= 0 ? '#d4edda' : '#f8d7da'}; color: ${gananciaNeta >= 0 ? '#155724' : '#721c24'};">
                            <div><b>= GANANCIA NETA DEL PERÃODO</b></div>
                            <div style="text-align: right;"><b>${fmt(gananciaNeta)}</b></div>
                            <div style="text-align: right;"><b>${(totalIngresos > 0 ? ((gananciaNeta / totalIngresos) * 100).toFixed(1) : 0)}%</b></div>
                        </div>
                    </div>
                </div>

                <div class="grid-4">
                    <div class="card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="card-value">${((gananciaaBruta / totalIngresos) * 100).toFixed(1)}%</div>
                        <div class="card-label">ğŸ“Š Margen Bruto</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <div class="card-value">${((ebitda / totalIngresos) * 100).toFixed(1)}%</div>
                        <div class="card-label">ğŸ“ˆ Margen Operativo</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="card-value">${((gananciaNeta / totalIngresos) * 100).toFixed(1)}%</div>
                        <div class="card-label">ğŸ’° Margen Neto</div>
                    </div>
                    <div class="card" style="background: ${gananciaNeta >= 0 ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #dc3545, #c82333)'};">
                        <div class="card-value">${gananciaNeta >= 0 ? 'âœ…' : 'âŒ'}</div>
                        <div class="card-label">${gananciaNeta >= 0 ? 'Rentable' : 'En PÃ©rdida'}</div>
                    </div>
                </div>
            `;

            document.getElementById('panelEstadoResultados').innerHTML = html;
        }

        // ============ ESTADO FINANCIERO (CASH FLOW) ============
        function mostrarEstadoFinanciero() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);

            const totalIngresosCobrados = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalGastosPagados = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const totalComprasPagadas = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);

            const flujoOperativo = totalIngresosCobrados - totalGastosPagados - totalComprasPagadas;
            const cambioEnCuentasPorCobrar = datos.saldos.porCobrar * -1;
            const cambioEnCuentasPorPagar = datos.saldos.porPagar;
            const flujoLibre = flujoOperativo;
            const saldoInicial = datos.saldos.efectivo + datos.saldos.banco;
            const saldoFinal = saldoInicial + flujoLibre;

            let html = `
                <div class="section">
                    <h3>ğŸ’¹ ESTADO DE FLUJO DE CAJA (ESTADO FINANCIERO)</h3>
                    <div style="overflow-x: auto;">
                        <div class="estado-resultados-row header">
                            <div><b>Concepto</b></div>
                            <div style="text-align: right;"><b>Monto (ARS)</b></div>
                            <div style="text-align: right;"><b>Tipo</b></div>
                        </div>

                        <div class="estado-resultados-row" style="margin-top: 10px;">
                            <div><b>ğŸ”„ FLUJO OPERATIVO</b></div>
                            <div style="text-align: right;"><b>${fmt(flujoOperativo)}</b></div>
                            <div style="text-align: right;"><span class="badge badge-info">OperaciÃ³n</span></div>
                        </div>

                        <div class="estado-resultados-row indent">
                            <div>   Ingresos cobrados</div>
                            <div style="text-align: right; color: #28a745;"><b>+ ${fmt(totalIngresosCobrados)}</b></div>
                            <div style="text-align: right;">ğŸ“¥ Entrada</div>
                        </div>

                        <div class="estado-resultados-row indent">
                            <div>   Gastos pagados</div>
                            <div style="text-align: right; color: #dc3545;"><b>- ${fmt(totalGastosPagados)}</b></div>
                            <div style="text-align: right;">ğŸ“¤ Salida</div>
                        </div>

                        <div class="estado-resultados-row indent">
                            <div>   Compras pagadas</div>
                            <div style="text-align: right; color: #dc3545;"><b>- ${fmt(totalComprasPagadas)}</b></div>
                            <div style="text-align: right;">ğŸ“¤ Salida</div>
                        </div>

                        <div class="estado-resultados-row total" style="margin-top: 10px; background: ${flujoOperativo >= 0 ? '#d4edda' : '#f8d7da'}; color: ${flujoOperativo >= 0 ? '#155724' : '#721c24'};">
                            <div><b>= FLUJO DE CAJA NETO</b></div>
                            <div style="text-align: right;"><b>${fmt(flujoOperativo)}</b></div>
                            <div style="text-align: right;"><b>${flujoOperativo >= 0 ? 'âœ… Positivo' : 'âŒ Negativo'}</b></div>
                        </div>

                        <div class="estado-resultados-row header" style="margin-top: 15px;">
                            <div><b>POSICIÃ“N DE CAJA</b></div>
                            <div style="text-align: right;"><b>Monto (ARS)</b></div>
                            <div style="text-align: right;"><b>Estado</b></div>
                        </div>

                        <div class="estado-resultados-row">
                            <div>Saldo Inicial de Caja</div>
                            <div style="text-align: right;">${fmt(saldoInicial)}</div>
                            <div style="text-align: right;">ğŸ“ Inicio</div>
                        </div>

                        <div class="estado-resultados-row">
                            <div>+ Flujo Neto del PerÃ­odo</div>
                            <div style="text-align: right; color: ${flujoOperativo >= 0 ? '#28a745' : '#dc3545'};"><b>${fmt(flujoOperativo)}</b></div>
                            <div style="text-align: right;">${flujoOperativo >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}</div>
                        </div>

                        <div class="estado-resultados-row total">
                            <div><b>= SALDO FINAL DE CAJA</b></div>
                            <div style="text-align: right;"><b>${fmt(saldoFinal)}</b></div>
                            <div style="text-align: right;"><b>${saldoFinal >= 0 ? 'âœ…' : 'âŒ'}</b></div>
                        </div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <div class="card-value">${fmt(totalIngresosCobrados)}</div>
                        <div class="card-label">ğŸ’µ Ingresos Cobrados</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                        <div class="card-value">${fmt(totalGastosPagados + totalComprasPagadas)}</div>
                        <div class="card-label">ğŸ’¸ Egresos Pagados</div>
                    </div>
                    <div class="card" style="background: ${flujoOperativo >= 0 ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'linear-gradient(135deg, #ff9800, #ffc107)'};">
                        <div class="card-value">${fmt(flujoOperativo)}</div>
                        <div class="card-label">ğŸ“Š Flujo Neto</div>
                    </div>
                </div>
            `;

            document.getElementById('panelEstadoFinanciero').innerHTML = html;
        }

        // ============ PANEL DE RENTABILIDAD ============
        function mostrarRentabilidad() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);

            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const gananciaBruta = totalIngresos - totalCompras;
            const gananciaNeta = gananciaBruta - totalGastos;

            const capitalPropio = datos.saldos.banco + datos.saldos.efectivo;
            const capitalPromedio = capitalPropio > 0 ? capitalPropio : 1;
            const inversiÃ³nTotal = (datos.saldos.efectivo + datos.saldos.banco) || 1;

            const margenNeto = totalIngresos > 0 ? (gananciaNeta / totalIngresos) * 100 : 0;
            const margenBruto = totalIngresos > 0 ? (gananciaBruta / totalIngresos) * 100 : 0;
            const roe = (gananciaNeta / capitalPromedio) * 100;
            const roi = (gananciaNeta / inversiÃ³nTotal) * 100;
            const rotacionActivos = totalIngresos / inversiÃ³nTotal;

            let html = `
                <div class="section">
                    <h3>ğŸ“Š PANEL DE RENTABILIDAD - KPIs CLAVE</h3>
                </div>

                <div class="grid-3">
                    <div class="rentabilidad-kpi">
                        <div class="rentabilidad-valor">${margenNeto.toFixed(1)}%</div>
                        <div class="rentabilidad-label">ğŸ’° MARGEN NETO</div>
                        <div class="rentabilidad-desc">Ganancia real por cada $100 que vendÃ©s</div>
                    </div>

                    <div class="rentabilidad-kpi" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="rentabilidad-valor">${margenBruto.toFixed(1)}%</div>
                        <div class="rentabilidad-label">ğŸ“Š MARGEN BRUTO</div>
                        <div class="rentabilidad-desc">Ganancia despuÃ©s de compras</div>
                    </div>

                    <div class="rentabilidad-kpi" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <div class="rentabilidad-valor">${roe.toFixed(1)}%</div>
                        <div class="rentabilidad-label">ğŸ’¼ ROE</div>
                        <div class="rentabilidad-desc">Retorno sobre tu capital propio</div>
                    </div>

                    <div class="rentabilidad-kpi" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                        <div class="rentabilidad-valor">${roi.toFixed(1)}%</div>
                        <div class="rentabilidad-label">ğŸ“ˆ ROI</div>
                        <div class="rentabilidad-desc">Retorno sobre inversiÃ³n total</div>
                    </div>

                    <div class="rentabilidad-kpi" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <div class="rentabilidad-valor">${rotacionActivos.toFixed(2)}x</div>
                        <div class="rentabilidad-label">ğŸ”„ ROTACIÃ“N</div>
                        <div class="rentabilidad-desc">Veces que rotas tu capital</div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ“‹ AnÃ¡lisis Detallado</h3>
                    <table>
                        <tr>
                            <th>Indicador</th>
                            <th style="text-align: right;">Tu Valor</th>
                            <th style="text-align: right;">Ideal</th>
                            <th style="text-align: right;">EvaluaciÃ³n</th>
                        </tr>
                        <tr>
                            <td><b>Margen Neto</b></td>
                            <td style="text-align: right;">${margenNeto.toFixed(1)}%</td>
                            <td style="text-align: right;">15-20%</td>
                            <td style="text-align: right;">${margenNeto >= 15 ? 'âœ…' : margenNeto >= 10 ? 'âš ï¸' : 'âŒ'}</td>
                        </tr>
                        <tr>
                            <td><b>Margen Bruto</b></td>
                            <td style="text-align: right;">${margenBruto.toFixed(1)}%</td>
                            <td style="text-align: right;">>60%</td>
                            <td style="text-align: right;">${margenBruto >= 60 ? 'âœ…' : 'âš ï¸'}</td>
                        </tr>
                        <tr>
                            <td><b>ROE</b></td>
                            <td style="text-align: right;">${roe.toFixed(1)}%</td>
                            <td style="text-align: right;">>20%</td>
                            <td style="text-align: right;">${roe >= 20 ? 'âœ…' : 'âš ï¸'}</td>
                        </tr>
                        <tr>
                            <td><b>ROI</b></td>
                            <td style="text-align: right;">${roi.toFixed(1)}%</td>
                            <td style="text-align: right;">>15%</td>
                            <td style="text-align: right;">${roi >= 15 ? 'âœ…' : 'âš ï¸'}</td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('panelRentabilidad').innerHTML = html;
        }

        // ============ ANÃLISIS COMPARATIVO ============
        function mostrarAnalisisComparativo() {
            const aÃ±os = [2023, 2024, 2025];
            let analisisAÃ±os = {};

            aÃ±os.forEach(aÃ±o => {
                const ingresosDel = datos.ingresos.filter(i => new Date(i.fecha).getFullYear() === aÃ±o).reduce((s, i) => s + (parseFloat(i.monto || 0)), 0);
                const gastosDel = datos.gastos.filter(g => new Date(g.fecha).getFullYear() === aÃ±o).reduce((s, g) => s + (parseFloat(g.monto || 0)), 0);
                const comprasDel = datos.compras.filter(c => new Date(c.fecha).getFullYear() === aÃ±o).reduce((s, c) => s + (parseFloat(c.monto || 0)), 0);
                const balanceDel = ingresosDel - gastosDel - comprasDel;
                
                analisisAÃ±os[aÃ±o] = {
                    ingresos: ingresosDel,
                    gastos: gastosDel,
                    compras: comprasDel,
                    balance: balanceDel,
                    margen: ingresosDel > 0 ? ((balanceDel / ingresosDel) * 100).toFixed(1) : '0'
                };
            });

            let html = `
                <div class="section">
                    <h3>ğŸ“Š ANÃLISIS COMPARATIVO AÃ‘O A AÃ‘O</h3>
                    <table>
                        <tr>
                            <th>Concepto</th>
                            <th style="text-align: right;">2023</th>
                            <th style="text-align: right;">2024</th>
                            <th style="text-align: right;">2025</th>
                            <th style="text-align: right;">Var 24-25</th>
                            <th style="text-align: right;">Tendencia</th>
                        </tr>
                        <tr style="background: #667eea; color: white;">
                            <td><b>INGRESOS</b></td>
                            <td style="text-align: right;"><b>${fmt(analisisAÃ±os[2023].ingresos)}</b></td>
                            <td style="text-align: right;"><b>${fmt(analisisAÃ±os[2024].ingresos)}</b></td>
                            <td style="text-align: right;"><b>${fmt(analisisAÃ±os[2025].ingresos)}</b></td>
                            <td style="text-align: right;">
                                <b>${analisisAÃ±os[2024].ingresos > 0 ? ((((analisisAÃ±os[2025].ingresos - analisisAÃ±os[2024].ingresos) / analisisAÃ±os[2024].ingresos) * 100).toFixed(1) + '%') : 'N/A'}</b>
                            </td>
                            <td style="text-align: right;">
                                ${analisisAÃ±os[2025].ingresos > analisisAÃ±os[2024].ingresos ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                            </td>
                        </tr>
                        <tr>
                            <td>Gastos</td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2023].gastos)}</td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2024].gastos)}</td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2025].gastos)}</td>
                            <td style="text-align: right;">
                                ${analisisAÃ±os[2024].gastos > 0 ? (((analisisAÃ±os[2025].gastos - analisisAÃ±os[2024].gastos) / analisisAÃ±os[2024].gastos) * 100).toFixed(1) + '%' : 'N/A'}
                            </td>
                            <td style="text-align: right;">
                                ${analisisAÃ±os[2025].gastos < analisisAÃ±os[2024].gastos ? 'âœ…' : 'âš ï¸'}
                            </td>
                        </tr>
                        <tr style="background: #d4edda; font-weight: bold;">
                            <td><b>BALANCE NETO</b></td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2023].balance)}</td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2024].balance)}</td>
                            <td style="text-align: right;">${fmt(analisisAÃ±os[2025].balance)}</td>
                            <td style="text-align: right;">
                                ${analisisAÃ±os[2024].balance !== 0 ? (((analisisAÃ±os[2025].balance - analisisAÃ±os[2024].balance) / Math.abs(analisisAÃ±os[2024].balance)) * 100).toFixed(1) + '%' : 'N/A'}
                            </td>
                            <td style="text-align: right;">
                                ${analisisAÃ±os[2025].balance > 0 ? 'âœ…' : 'âŒ'}
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('panelComparativo').innerHTML = html;
        }

        // ============ MOVIMIENTOS ============
        function mostrarMovimientos() {
            const movimientosFiltrados = aplicarFiltros(datos.movimientos);
            
            // Asegurar que existan las cajas
            if (!datos.cajas) datos.cajas = [];
            
            // Generar opciones de cajas dinÃ¡micamente desde datos.cajas
            let cajasOpciones = '';
            if (datos.cajas.length === 0) {
                cajasOpciones = '<option value="">-- No hay cajas creadas --</option>';
            } else {
                datos.cajas.forEach((caja, idx) => {
                    cajasOpciones += `<option value="${idx}">${caja.nombre}</option>`;
                });
            }
            
            let html = '<div class="section"><h3>â• Registrar Movimiento</h3>';
            
            if (datos.cajas.length === 0) {
                html += '<div class="alert alert-warning">âš ï¸ Primero debes crear cajas en la pestaÃ±a <b>ğŸ¦ Cajas</b> para poder registrar movimientos.</div>';
                html += '</div>';
            } else {
                html += '<div class="alert alert-info">Ingresa los valores en <b>Pesos Argentinos (ARS)</b>. Selecciona el tipo de movimiento y las cajas involucradas.</div>';
                
                // Tipo de movimiento
                html += '<div class="grid-4" style="margin-bottom: 15px;">';
                html += `<div>
                    <label style="font-weight: 600; color: #555;">Tipo de Movimiento:</label>
                    <select id="tipoMovimiento" onchange="toggleCajaDestino()">
                        <option value="ingreso">ğŸ“¥ Ingreso (entrada de dinero)</option>
                        <option value="egreso">ğŸ“¤ Egreso (salida de dinero)</option>
                        <option value="transferencia">ğŸ’± Transferencia entre cajas</option>
                    </select>
                </div>`;
                
                // Caja Origen
                html += `<div>
                    <label style="font-weight: 600; color: #555;">Caja:</label>
                    <select id="cajaOrigen">${cajasOpciones}</select>
                </div>`;
                
                // Caja Destino (solo para transferencias)
                html += `<div id="cajaDestinoContainer" style="display: none;">
                    <label style="font-weight: 600; color: #555;">Caja Destino:</label>
                    <select id="cajaDestino">${cajasOpciones}</select>
                </div>`;
                
                // Monto
                html += `<div>
                    <label style="font-weight: 600; color: #555;">Monto (ARS):</label>
                    <input type="number" id="montoMovimiento" placeholder="Monto (ARS)" step="1000">
                </div>`;
                html += '</div>';
                
                // DescripciÃ³n opcional
                html += '<div class="grid-2" style="margin-bottom: 15px;">';
                html += `<div>
                    <label style="font-weight: 600; color: #555;">DescripciÃ³n (opcional):</label>
                    <input type="text" id="descripcionMovimiento" placeholder="Ej: Pago proveedor, Cobro cliente, etc.">
                </div>`;
                html += `<div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-success" onclick="agregarMovimientoFondos()" style="width: 100%;">âœ… Registrar Movimiento</button>
                </div>`;
                html += '</div></div>';
            }
            
            // Resumen de saldos por caja (dinÃ¡mico desde datos.cajas)
            html += '<div class="section"><h3>ğŸ’° Saldos Actuales por Caja</h3>';
            
            if (datos.cajas.length === 0) {
                html += '<div class="alert alert-info">No hay cajas creadas. Crea cajas en la pestaÃ±a ğŸ¦ Cajas.</div>';
            } else {
                const totalCajas = datos.cajas.reduce((sum, c) => sum + (c.monto || 0), 0);
                html += `<div class="card" style="margin-bottom: 15px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    <div class="card-value">${fmt(totalCajas)}</div>
                    <div class="card-label">ğŸ’¼ Total en Todas las Cajas</div>
                </div>`;
                
                // Determinar cuÃ¡ntas columnas segÃºn cantidad de cajas
                const gridCols = datos.cajas.length <= 3 ? 'grid-3' : datos.cajas.length <= 5 ? 'grid-5' : 'grid-4';
                html += `<div class="${gridCols}">`;
                
                const colores = [
                    'linear-gradient(135deg, #28a745, #20c997)',
                    'linear-gradient(135deg, #007bff, #0056b3)',
                    'linear-gradient(135deg, #00b4d8, #0096c7)',
                    'linear-gradient(135deg, #6f42c1, #5a32a3)',
                    'linear-gradient(135deg, #fd7e14, #e85d04)',
                    'linear-gradient(135deg, #e91e63, #c2185b)',
                    'linear-gradient(135deg, #009688, #00796b)',
                    'linear-gradient(135deg, #795548, #5d4037)'
                ];
                
                datos.cajas.forEach((caja, idx) => {
                    const color = colores[idx % colores.length];
                    const montoARS = Math.round((caja.monto || 0) * datos.config.tipoCambioBNA);
                    html += `<div class="card" style="background: ${color};">
                        <div class="card-value">$${montoARS.toLocaleString('es-AR')} ARS</div>
                        <div class="card-label">${caja.nombre}</div>
                    </div>`;
                });
                html += '</div>';
            }
            html += '</div>';
            
            // Tabla de movimientos
            html += '<div class="section"><h3>ğŸ“‹ Historial de Movimientos</h3>';
            
            if (movimientosFiltrados.length === 0) {
                html += '<div class="alert alert-info">Sin movimientos registrados</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>Tipo</th><th>Caja</th><th>DescripciÃ³n</th><th>Monto (ARS)</th><th></th></tr>';
                movimientosFiltrados.slice().reverse().forEach((m, idx) => {
                    const i = movimientosFiltrados.length - 1 - idx; // Ã­ndice real para eliminar
                    const montoARS = (m.monto || 0) * datos.config.tipoCambioBNA;
                    
                    // Determinar emoji y color segÃºn tipo
                    let tipoEmoji, tipoColor, tipoTexto;
                    if (m.tipo === 'ingreso') {
                        tipoEmoji = 'ğŸ“¥';
                        tipoColor = '#28a745';
                        tipoTexto = 'Ingreso';
                    } else if (m.tipo === 'egreso') {
                        tipoEmoji = 'ğŸ“¤';
                        tipoColor = '#dc3545';
                        tipoTexto = 'Egreso';
                    } else if (m.tipo === 'transferencia') {
                        tipoEmoji = 'ğŸ’±';
                        tipoColor = '#17a2b8';
                        tipoTexto = 'Transferencia';
                    } else {
                        // Compatibilidad con movimientos antiguos
                        tipoEmoji = m.tipo === 'deposito' ? 'ğŸ“¥' : 'ğŸ“¤';
                        tipoColor = m.tipo === 'deposito' ? '#28a745' : '#dc3545';
                        tipoTexto = m.tipo === 'deposito' ? 'DepÃ³sito' : 'ExtracciÃ³n';
                    }
                    
                    // Obtener nombre de caja desde el Ã­ndice guardado
                    let cajaInfo = '-';
                    if (m.cajaOrigenIdx !== undefined && datos.cajas[m.cajaOrigenIdx]) {
                        cajaInfo = datos.cajas[m.cajaOrigenIdx].nombre;
                        if (m.tipo === 'transferencia' && m.cajaDestinoIdx !== undefined && datos.cajas[m.cajaDestinoIdx]) {
                            cajaInfo += ' â†’ ' + datos.cajas[m.cajaDestinoIdx].nombre;
                        }
                    } else if (m.cajaOrigen) {
                        // Compatibilidad con formato anterior
                        cajaInfo = m.cajaOrigen;
                        if (m.tipo === 'transferencia' && m.cajaDestino) {
                            cajaInfo += ' â†’ ' + m.cajaDestino;
                        }
                    }
                    
                    const descripcion = m.descripcion || '-';
                    const montoFormateado = m.tipo === 'egreso' ? 
                        `<span style="color: #dc3545;">-$${Math.round(montoARS).toLocaleString('es-AR')}</span>` :
                        `<span style="color: #28a745;">+$${Math.round(montoARS).toLocaleString('es-AR')}</span>`;
                    
                    html += `<tr>
                        <td>${fmtFecha(m.fecha)}</td>
                        <td><span style="color: ${tipoColor}; font-weight: 600;">${tipoEmoji} ${tipoTexto}</span></td>
                        <td>${cajaInfo}</td>
                        <td>${descripcion}</td>
                        <td style="font-weight: 600;">${montoFormateado} ARS</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarMovimientoFondos(${i})">ğŸ—‘ï¸</button></td>
                    </tr>`;
                });
                html += '</table>';
            }
            
            html += '</div>';
            document.getElementById('listaMovimientos').innerHTML = html;
        }
        
        // Mostrar/ocultar caja destino segÃºn tipo de movimiento
        function toggleCajaDestino() {
            const tipo = document.getElementById('tipoMovimiento').value;
            const cajaDestinoContainer = document.getElementById('cajaDestinoContainer');
            if (tipo === 'transferencia') {
                cajaDestinoContainer.style.display = 'block';
            } else {
                cajaDestinoContainer.style.display = 'none';
            }
        }

        function agregarMovimientoFondos() {
            const tipo = document.getElementById('tipoMovimiento').value;
            const cajaOrigenIdx = parseInt(document.getElementById('cajaOrigen').value);
            const cajaDestinoIdx = document.getElementById('cajaDestino') ? parseInt(document.getElementById('cajaDestino').value) : null;
            const descripcion = document.getElementById('descripcionMovimiento').value.trim();
            const montoARS = parseFloat(document.getElementById('montoMovimiento').value) || 0;
            const montoUSD = montoARS / datos.config.tipoCambioBNA;
            
            if (montoARS <= 0) { notif('âš ï¸ Ingresa un monto vÃ¡lido', 'warning'); return; }
            
            if (isNaN(cajaOrigenIdx) || !datos.cajas[cajaOrigenIdx]) {
                notif('âš ï¸ Selecciona una caja vÃ¡lida', 'warning');
                return;
            }
            
            // Validar transferencia entre mismas cajas
            if (tipo === 'transferencia' && cajaOrigenIdx === cajaDestinoIdx) {
                notif('âš ï¸ La caja origen y destino deben ser diferentes', 'warning');
                return;
            }
            
            // Validar saldo suficiente para egreso o transferencia
            if ((tipo === 'egreso' || tipo === 'transferencia') && datos.cajas[cajaOrigenIdx].monto < montoUSD) {
                notif('âš ï¸ Saldo insuficiente en ' + datos.cajas[cajaOrigenIdx].nombre, 'warning');
                return;
            }
            
            // Crear el movimiento con ID Ãºnico
            const movimientoId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const fechaHoy = new Date().toISOString().split('T')[0];
            
            const movimiento = {
                id: movimientoId,
                fecha: fechaHoy,
                tipo: tipo,
                cajaOrigenIdx: cajaOrigenIdx,
                cajaOrigen: datos.cajas[cajaOrigenIdx].nombre,
                monto: montoUSD,
                descripcion: descripcion || null
            };
            
            // Si es transferencia, agregar caja destino
            if (tipo === 'transferencia') {
                movimiento.cajaDestinoIdx = cajaDestinoIdx;
                movimiento.cajaDestino = datos.cajas[cajaDestinoIdx].nombre;
            }
            
            // Actualizar saldos de las cajas segÃºn el tipo de movimiento
            // Y registrar en el historial de movimientos de cada caja
            if (!datos.cajas[cajaOrigenIdx].movimientos) datos.cajas[cajaOrigenIdx].movimientos = [];
            
            if (tipo === 'ingreso') {
                datos.cajas[cajaOrigenIdx].monto += montoUSD;
                datos.cajas[cajaOrigenIdx].movimientos.push({
                    fecha: fechaHoy,
                    tipo: 'entrada',
                    monto: montoUSD,
                    motivo: descripcion || 'Ingreso desde Movimientos'
                });
                
                // NUEVO: Registrar tambiÃ©n en Ingresos
                datos.ingresos.push({
                    movimientoId: movimientoId,
                    monto: montoUSD,
                    montoBruto: montoUSD,
                    retencion: 0,
                    fecha: fechaHoy,
                    desc: descripcion || 'Ingreso - ' + datos.cajas[cajaOrigenIdx].nombre,
                    metodo: datos.cajas[cajaOrigenIdx].nombre,
                    cat: 'Movimiento de Caja',
                    desdeMovimientos: true
                });
                
            } else if (tipo === 'egreso') {
                datos.cajas[cajaOrigenIdx].monto -= montoUSD;
                datos.cajas[cajaOrigenIdx].movimientos.push({
                    fecha: fechaHoy,
                    tipo: 'salida',
                    monto: montoUSD,
                    motivo: descripcion || 'Egreso desde Movimientos'
                });
                
                // NUEVO: Registrar tambiÃ©n en Gastos
                datos.gastos.push({
                    movimientoId: movimientoId,
                    monto: montoUSD,
                    fecha: fechaHoy,
                    desc: descripcion || 'Egreso - ' + datos.cajas[cajaOrigenIdx].nombre,
                    metodo: datos.cajas[cajaOrigenIdx].nombre,
                    cat: 'Movimiento de Caja',
                    esVariable: true,
                    desdeMovimientos: true
                });
                
            } else if (tipo === 'transferencia') {
                if (!datos.cajas[cajaDestinoIdx].movimientos) datos.cajas[cajaDestinoIdx].movimientos = [];
                
                datos.cajas[cajaOrigenIdx].monto -= montoUSD;
                datos.cajas[cajaOrigenIdx].movimientos.push({
                    fecha: fechaHoy,
                    tipo: 'salida',
                    monto: montoUSD,
                    motivo: 'ğŸ”„ Transferencia a ' + datos.cajas[cajaDestinoIdx].nombre + (descripcion ? ' - ' + descripcion : '')
                });
                
                datos.cajas[cajaDestinoIdx].monto += montoUSD;
                datos.cajas[cajaDestinoIdx].movimientos.push({
                    fecha: fechaHoy,
                    tipo: 'entrada',
                    monto: montoUSD,
                    motivo: 'ğŸ”„ Transferencia desde ' + datos.cajas[cajaOrigenIdx].nombre + (descripcion ? ' - ' + descripcion : '')
                });
                // Las transferencias NO se registran en gastos/ingresos (es movimiento interno)
            }
            
            datos.movimientos.push(movimiento);
            
            guardarDatos();
            mostrarMovimientos();
            
            // Mensaje segÃºn tipo
            let mensaje = '';
            if (tipo === 'ingreso') {
                mensaje = `âœ… Ingreso registrado: +$${Math.round(montoARS).toLocaleString('es-AR')} ARS en ${datos.cajas[cajaOrigenIdx].nombre}`;
            } else if (tipo === 'egreso') {
                mensaje = `âœ… Egreso registrado: -$${Math.round(montoARS).toLocaleString('es-AR')} ARS de ${datos.cajas[cajaOrigenIdx].nombre}`;
            } else {
                mensaje = `âœ… Transferencia: $${Math.round(montoARS).toLocaleString('es-AR')} ARS de ${datos.cajas[cajaOrigenIdx].nombre} a ${datos.cajas[cajaDestinoIdx].nombre}`;
            }
            
            notif(mensaje, 'success');
            
            // Limpiar campos
            document.getElementById('montoMovimiento').value = '';
            document.getElementById('descripcionMovimiento').value = '';
        }

        function eliminarMovimientoFondos(i) {
            if (confirm('Â¿Eliminar este movimiento? Esto revertirÃ¡ el cambio en los saldos, cajas, gastos e ingresos.')) {
                const mov = datos.movimientos[i];
                
                // Revertir el cambio en saldos de cajas y eliminar del historial
                if (mov.cajaOrigenIdx !== undefined && datos.cajas[mov.cajaOrigenIdx]) {
                    if (mov.tipo === 'ingreso') {
                        datos.cajas[mov.cajaOrigenIdx].monto -= mov.monto;
                        // Eliminar del historial de la caja
                        if (datos.cajas[mov.cajaOrigenIdx].movimientos) {
                            const idx = datos.cajas[mov.cajaOrigenIdx].movimientos.findIndex(m => 
                                m.fecha === mov.fecha && Math.abs(m.monto - mov.monto) < 0.01 && (m.tipo === 'entrada' || m.tipo === 'ingreso')
                            );
                            if (idx !== -1) datos.cajas[mov.cajaOrigenIdx].movimientos.splice(idx, 1);
                        }
                        // NUEVO: Eliminar de Ingresos
                        if (mov.id) {
                            const idxIngreso = datos.ingresos.findIndex(ing => ing.movimientoId === mov.id);
                            if (idxIngreso !== -1) datos.ingresos.splice(idxIngreso, 1);
                        }
                    } else if (mov.tipo === 'egreso') {
                        datos.cajas[mov.cajaOrigenIdx].monto += mov.monto;
                        // Eliminar del historial de la caja
                        if (datos.cajas[mov.cajaOrigenIdx].movimientos) {
                            const idx = datos.cajas[mov.cajaOrigenIdx].movimientos.findIndex(m => 
                                m.fecha === mov.fecha && Math.abs(m.monto - mov.monto) < 0.01 && (m.tipo === 'salida' || m.tipo === 'egreso')
                            );
                            if (idx !== -1) datos.cajas[mov.cajaOrigenIdx].movimientos.splice(idx, 1);
                        }
                        // NUEVO: Eliminar de Gastos
                        if (mov.id) {
                            const idxGasto = datos.gastos.findIndex(g => g.movimientoId === mov.id);
                            if (idxGasto !== -1) datos.gastos.splice(idxGasto, 1);
                        }
                    } else if (mov.tipo === 'transferencia' && mov.cajaDestinoIdx !== undefined && datos.cajas[mov.cajaDestinoIdx]) {
                        datos.cajas[mov.cajaOrigenIdx].monto += mov.monto;
                        datos.cajas[mov.cajaDestinoIdx].monto -= mov.monto;
                        // Eliminar del historial de ambas cajas
                        if (datos.cajas[mov.cajaOrigenIdx].movimientos) {
                            const idx = datos.cajas[mov.cajaOrigenIdx].movimientos.findIndex(m => 
                                m.fecha === mov.fecha && Math.abs(m.monto - mov.monto) < 0.01 && (m.tipo === 'salida' || m.tipo === 'egreso')
                            );
                            if (idx !== -1) datos.cajas[mov.cajaOrigenIdx].movimientos.splice(idx, 1);
                        }
                        if (datos.cajas[mov.cajaDestinoIdx].movimientos) {
                            const idx = datos.cajas[mov.cajaDestinoIdx].movimientos.findIndex(m => 
                                m.fecha === mov.fecha && Math.abs(m.monto - mov.monto) < 0.01 && (m.tipo === 'entrada' || m.tipo === 'ingreso')
                            );
                            if (idx !== -1) datos.cajas[mov.cajaDestinoIdx].movimientos.splice(idx, 1);
                        }
                    }
                }
                
                datos.movimientos.splice(i, 1);
                guardarDatos();
                mostrarMovimientos();
                actualizarDash();
                notif('âœ… Movimiento eliminado y saldos actualizados', 'success');
            }
        }

        // ============ ALERTAS ============
        function mostrarAlertas() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const balance = totalIngresos - totalGastos;
            
            let html = obtenerBadgePeriodo();
            html += '<div class="section"><h3>âš ï¸ Alertas del Sistema</h3>';
            
            let alertas = [];
            if (balance < 0) alertas.push('âŒ Balance negativo detectado');
            if (datos.saldos.efectivo === 0) alertas.push('âš ï¸ Sin efectivo disponible');
            if (totalGastos > totalIngresos) alertas.push('âš ï¸ Los gastos superan ingresos');
            if (datos.clientes.some(c => c.deuda > 0)) alertas.push(`âš ï¸ ${datos.clientes.filter(c => c.deuda > 0).length} cliente(s) con deuda`);
            if (datos.proveedores.some(p => p.deuda > 0)) alertas.push(`âš ï¸ ${datos.proveedores.filter(p => p.deuda > 0).length} proveedor(es) con deuda`);
            
            if (alertas.length === 0) {
                html += '<div class="alert alert-success">âœ… No hay alertas pendientes</div>';
            } else {
                alertas.forEach(a => {
                    html += `<div class="alert alert-warning">${a}</div>`;
                });
            }
            
            html += '</div>';
            document.getElementById('panelAlertas').innerHTML = html;
        }

        // ============ GRÃFICOS ============
        function mostrarGraficos() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            
            // Preparar datos por mes - FILTRAR POR AÃ‘O
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const ingresoPorMes = [];
            const gastoPorMes = [];
            const balancePorMes = [];
            
            // Determinar el aÃ±o a mostrar (del filtro o actual)
            const aÃ±oActual = new Date().getFullYear();
            let aÃ±oGrafico = aÃ±oActual;
            
            // Si hay filtro de perÃ­odo personalizado, usar ese aÃ±o
            const periodoActual = datos.config.periodoFiltro;
            if (periodoActual === 'personalizado' && datos.config.fechaDesde) {
                aÃ±oGrafico = new Date(datos.config.fechaDesde).getFullYear();
            }
            
            meses.forEach((mes, idx) => {
                // Filtrar por mes Y aÃ±o
                const ing = datos.ingresos.filter(i => {
                    const fecha = new Date(i.fecha);
                    return fecha.getMonth() === idx && fecha.getFullYear() === aÃ±oGrafico;
                }).reduce((s, i) => s + (parseFloat(i.monto || 0)), 0);
                
                const gast = datos.gastos.filter(g => {
                    const fecha = new Date(g.fecha);
                    return fecha.getMonth() === idx && fecha.getFullYear() === aÃ±oGrafico;
                }).reduce((s, g) => s + (parseFloat(g.monto || 0)), 0);
                
                const comp = datos.compras.filter(c => {
                    const fecha = new Date(c.fecha);
                    return fecha.getMonth() === idx && fecha.getFullYear() === aÃ±oGrafico;
                }).reduce((s, c) => s + (parseFloat(c.monto || 0)), 0);
                
                ingresoPorMes.push(Math.round(ing * datos.config.tipoCambioBNA));
                gastoPorMes.push(Math.round((gast + comp) * datos.config.tipoCambioBNA));
                balancePorMes.push(Math.round((ing - gast - comp) * datos.config.tipoCambioBNA));
            });
            
            let html = obtenerBadgePeriodo();
            html += '<div class="grid-2">';
            
            html += '<div class="section"><h3>ğŸ’¹ Ingresos vs Gastos</h3>';
            html += '<div class="chart-container"><canvas id="chartIngresoGasto"></canvas></div></div>';
            
            html += '<div class="section"><h3>ğŸ’° Saldos por Tipo</h3>';
            html += '<div class="chart-container"><canvas id="chartSaldos"></canvas></div></div>';
            
            html += '</div>';
            
            html += '<div class="section"><h3>ğŸ“ˆ ComparaciÃ³n Mensual (Ingresos, Gastos, Balance) - AÃ±o ' + aÃ±oGrafico + '</h3>';
            html += '<div class="chart-container" style="height: 400px;"><canvas id="chartMeses"></canvas></div></div>';
            
            document.getElementById('panelGraficos').innerHTML = html;
            
            setTimeout(() => {
                // GrÃ¡fico 1: Ingresos vs Gastos (Barras)
                const ctx1 = document.getElementById('chartIngresoGasto');
                if (ctx1) {
                    new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['Ingresos', 'Gastos'],
                            datasets: [{
                                label: 'Monto (ARS)',
                                data: [totalIngresos * datos.config.tipoCambioBNA, totalGastos * datos.config.tipoCambioBNA],
                                backgroundColor: ['#28a745', '#dc3545']
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true }
                            }
                        }
                    });
                }
                
                // GrÃ¡fico 2: Saldos por Tipo (Pastel)
                const ctx2 = document.getElementById('chartSaldos');
                if (ctx2) {
                    const saldosData = [
                        (datos.saldos.efectivo || 0) * datos.config.tipoCambioBNA,
                        (datos.saldos.banco || 0) * datos.config.tipoCambioBNA,
                        (datos.saldos.mp || 0) * datos.config.tipoCambioBNA,
                        (datos.saldos.cheques || 0) * datos.config.tipoCambioBNA,
                        (datos.saldos.echeq || 0) * datos.config.tipoCambioBNA
                    ];
                    const totalSaldos = saldosData.reduce((a, b) => a + b, 0);
                    
                    if (totalSaldos > 0) {
                        new Chart(ctx2, {
                            type: 'pie',
                            data: {
                                labels: ['Efectivo', 'Banco', 'Mercado Pago', 'Cheques', 'E-cheques'],
                                datasets: [{
                                    data: saldosData,
                                    backgroundColor: ['#667eea', '#764ba2', '#17a2b8', '#ffc107', '#28a745']
                                }]
                            },
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.label + ': $' + Math.round(context.raw).toLocaleString('es-AR') + ' ARS';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        ctx2.parentElement.innerHTML = '<div class="alert alert-info" style="text-align: center; padding: 50px;">ğŸ“Š No hay saldos cargados.<br><br>ConfigurÃ¡ tus saldos en la pestaÃ±a <b>Dashboard</b> o <b>ConfiguraciÃ³n</b>.</div>';
                    }
                }
                
                // GrÃ¡fico 3: ComparaciÃ³n Mensual (LÃ­neas)
                const ctx3 = document.getElementById('chartMeses');
                if (ctx3) {
                    new Chart(ctx3, {
                        type: 'line',
                        data: {
                            labels: meses,
                            datasets: [
                                {
                                    label: 'ğŸ’° Ingresos (ARS)',
                                    data: ingresoPorMes,
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#28a745'
                                },
                                {
                                    label: 'ğŸ“¤ Gastos + Compras (ARS)',
                                    data: gastoPorMes,
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#dc3545'
                                },
                                {
                                    label: 'ğŸ“Š Balance (ARS)',
                                    data: balancePorMes,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#667eea'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'EvoluciÃ³n Mensual del Negocio - ' + aÃ±oGrafico
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString('es-AR');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // ============ PROYECCIONES ============
        function mostrarProyecciones() {
            const tasaMensual = 0.05; // 5% mensual como ejemplo
            const mesesProyeccion = 12;
            const balanceActual = (datos.ingresos.reduce((s, i) => s + i.monto, 0) - datos.gastos.reduce((s, g) => s + g.monto, 0));
            
            let proyecciones = [];
            let balance = balanceActual;
            
            for (let i = 1; i <= mesesProyeccion; i++) {
                balance = balance * (1 + tasaMensual / 100);
                proyecciones.push({ mes: 'Mes ' + i, balance: balance });
            }
            
            let html = obtenerBadgePeriodo();
            html += '<div class="section"><h3>ğŸ”® ProyecciÃ³n 12 Meses</h3>';
            html += '<table><tr><th>PerÃ­odo</th><th>Balance Proyectado (ARS)</th></tr>';
            
            proyecciones.forEach(p => {
                html += `<tr><td>${p.mes}</td><td>${fmt(p.balance)}</td></tr>`;
            });
            
            html += '</table></div>';
            document.getElementById('panelProyecciones').innerHTML = html;
        }

        // ============ CASH FLOW ============
        function mostrarCashFlow() {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            let html = obtenerBadgePeriodo();
            html += '<table><tr><th>Mes</th><th>Ingresos</th><th>Gastos</th><th>Compras</th><th>Balance</th></tr>';
            
            meses.forEach((mes, idx) => {
                const mesNum = idx + 1;
                const ing = datos.ingresos.filter(i => new Date(i.fecha).getMonth() === idx).reduce((s, i) => s + i.monto, 0);
                const gast = datos.gastos.filter(g => new Date(g.fecha).getMonth() === idx).reduce((s, g) => s + g.monto, 0);
                const comp = datos.compras.filter(c => new Date(c.fecha).getMonth() === idx).reduce((s, c) => s + c.monto, 0);
                const balance = ing - gast - comp;
                
                html += `<tr><td><b>${mes}</b></td><td style="color: #28a745;">${fmt(ing)}</td><td style="color: #dc3545;">${fmt(gast)}</td><td>${fmt(comp)}</td><td style="font-weight: bold; color: ${balance >= 0 ? '#28a745' : '#dc3545'};"><b>${fmt(balance)}</b></td></tr>`;
            });
            
            html += '</table>';
            document.getElementById('tablaCashFlow').innerHTML = html;
        }

        // ============ RECORDATORIOS ============
        function mostrarRecordatorios() {
            let html = '<div class="section"><h3>â• Agregar Recordatorio</h3>';
            html += '<div class="grid-3"><input type="text" id="recTitulo" placeholder="TÃ­tulo"><input type="date" id="recFecha"><button class="btn btn-success" onclick="agregarRecordatorio()">âœ… Agregar</button></div></div>';
            
            html += '<div class="section"><h3>ğŸ“… Mis Recordatorios</h3>';
            
            if (datos.recordatorios.length === 0) {
                html += '<div class="alert alert-info">Sin recordatorios</div>';
            } else {
                html += '<table><tr><th>Fecha</th><th>TÃ­tulo</th><th></th></tr>';
                datos.recordatorios.forEach((r, i) => {
                    html += `<tr><td>${fmtFecha(r.fecha)}</td><td>${r.titulo}</td><td><button class="btn btn-danger btn-sm" onclick="eliminarRecordatorio(${i})">ğŸ—‘ï¸</button></td></tr>`;
                });
                html += '</table>';
            }
            
            html += '</div>';
            document.getElementById('listaRecordatorios').innerHTML = html;
        }

        function agregarRecordatorio() {
            const titulo = document.getElementById('recTitulo').value;
            const fecha = document.getElementById('recFecha').value;
            
            if (!titulo || !fecha) { notif('âš ï¸ Completa todos los campos', 'warning'); return; }
            
            datos.recordatorios.push({ titulo, fecha });
            guardarDatos();
            mostrarRecordatorios();
            notif('âœ… Recordatorio agregado', 'success');
            document.getElementById('recTitulo').value = '';
            document.getElementById('recFecha').value = '';
        }

        function eliminarRecordatorio(i) {
            if (confirm('Â¿Eliminar?')) {
                datos.recordatorios.splice(i, 1);
                guardarDatos();
                mostrarRecordatorios();
            }
        }

        // ============ ASISTENTE IA ============
        function mostrarAsistente() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);
            
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const gastosFijos = gastosFiltrados.filter(g => !g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const gastosVariables = gastosFiltrados.filter(g => g.esVariable).reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            
            const balance = totalIngresos - totalGastos - totalCompras;
            const gananciaBruta = totalIngresos - totalCompras;
            const margenNeto = totalIngresos > 0 ? (balance / totalIngresos) * 100 : 0;
            const margenBruto = totalIngresos > 0 ? (gananciaBruta / totalIngresos) * 100 : 0;
            const porcentajeGastosFijos = totalIngresos > 0 ? (gastosFijos / totalIngresos) * 100 : 0;
            const porcentajeGastosVariables = totalIngresos > 0 ? (gastosVariables / totalIngresos) * 100 : 0;
            const porcentajeCompras = totalIngresos > 0 ? (totalCompras / totalIngresos) * 100 : 0;
            
            const totalSaldos = datos.saldos.efectivo + datos.saldos.banco + datos.saldos.mp + datos.saldos.cheques + datos.saldos.echeq;
            const gastosDiarios = totalGastos > 0 ? totalGastos / 30 : 0;
            const diasDeSolvencia = gastosDiarios > 0 ? totalSaldos / gastosDiarios : 0;
            
            // AnÃ¡lisis FODA
            let fortalezas = [];
            let debilidades = [];
            let oportunidades = [];
            let amenazas = [];
            
            // FORTALEZAS
            if (margenNeto > 20) fortalezas.push('ğŸŸ¢ Margen neto excepcional (>' + margenNeto.toFixed(1) + '%)');
            if (margenBruto > 60) fortalezas.push('ğŸŸ¢ Margen bruto excelente (>' + margenBruto.toFixed(1) + '%)');
            if (balance > totalIngresos * 0.25) fortalezas.push('ğŸŸ¢ Flujo de caja positivo y sÃ³lido');
            if (porcentajeGastosFijos < 40) fortalezas.push('ğŸŸ¢ Gastos fijos bajo control (<40%)');
            if (totalSaldos > gastosFijos * 3) fortalezas.push('ğŸŸ¢ ColchÃ³n de emergencia completo');
            if (porcentajeCompras < 40) fortalezas.push('ğŸŸ¢ COGS eficiente (<40%)');
            
            // DEBILIDADES
            if (margenNeto < 10) debilidades.push('ğŸ”´ Margen neto muy bajo (<' + margenNeto.toFixed(1) + '%)');
            if (margenBruto < 40) debilidades.push('ğŸ”´ Margen bruto bajo (<' + margenBruto.toFixed(1) + '%)');
            if (balance < 0) debilidades.push('ğŸ”´ Balance negativo - PÃ©rdidas');
            if (porcentajeGastosFijos > 50) debilidades.push('ğŸ”´ Gastos fijos muy altos (>' + porcentajeGastosFijos.toFixed(1) + '%)');
            if (totalSaldos < gastosFijos) debilidades.push('ğŸ”´ Caja insuficiente para 1 mes de gastos');
            if (porcentajeCompras > 50) debilidades.push('ğŸ”´ COGS muy alto (>' + porcentajeCompras.toFixed(1) + '%)');
            if (diasDeSolvencia < 30) debilidades.push('ğŸ”´ Solvencia crÃ­tica (solo ' + Math.round(diasDeSolvencia) + ' dÃ­as)');
            
            // OPORTUNIDADES
            if (porcentajeGastosVariables > 15) oportunidades.push('ğŸ’¡ Reduce gastos variables en 20% = +' + fmt(gastosVariables * 0.2) + ' ganancia');
            if (porcentajeGastosFijos > 35) oportunidades.push('ğŸ’¡ Renegocia gastos fijos = impacto directo en rentabilidad');
            if (porcentajeCompras > 35) oportunidades.push('ğŸ’¡ Busca nuevos proveedores o volÃºmenes = reduce COGS');
            if (totalIngresos > 0 && totalIngresos < datos.ingresos.length * 5000) oportunidades.push('ğŸ’¡ Sube precios 10-15% sin perder clientes');
            if (margenBruto > 50 && margenNeto < 15) oportunidades.push('ğŸ’¡ Tu ganancia bruta es buena pero gastos te la comen');
            if (balance > 0) oportunidades.push('ğŸ’¡ Invierte tus ganancias en marketing/crecimiento');
            
            // AMENAZAS
            if (balance <= 0) amenazas.push('ğŸš¨ SituaciÃ³n crÃ­tica: No generÃ¡s ganancias');
            if (totalSaldos < gastosFijos * 2) amenazas.push('ğŸš¨ Riesgo de insolvencia en prÃ³ximos 60 dÃ­as');
            if (margenBruto < 30) amenazas.push('ğŸš¨ Competencia de precio estÃ¡ afectando mÃ¡rgenes');
            if (porcentajeGastosFijos > 60) amenazas.push('ğŸš¨ Estructura de costos no escala con crecimiento');
            
            let html = obtenerBadgePeriodo();
            html += `
                <div class="alert" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: white; border: none; font-size: 2rem;">ğŸ¤– ASISTENTE IA - ANÃLISIS FINANCIERO PROFESIONAL</h2>
                    <p style="margin: 10px 0 0 0; font-size: 0.95rem; opacity: 0.9;">DiagnÃ³stico completo y recomendaciones estratÃ©gicas para tu empresa</p>
                </div>

                <div class="section" style="border-left: 4px solid #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));">
                    <h3>ğŸ“‹ DIAGNÃ“STICO FINANCIERO ACTUAL</h3>
                    <div class="grid-4">
                        <div class="card">
                            <div class="card-value">${fmt(totalIngresos)}</div>
                            <div class="card-label">ğŸ’° Ingresos Totales</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <div class="card-value">${fmt(totalGastos + totalCompras)}</div>
                            <div class="card-label">ğŸ“¤ Costos Totales</div>
                        </div>
                        <div class="card" style="background: ${balance >= 0 ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #dc3545, #c82333)'};">
                            <div class="card-value">${fmt(balance)}</div>
                            <div class="card-label">${balance >= 0 ? 'âœ… Ganancia Neta' : 'âŒ PÃ©rdida Neta'}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <div class="card-value">${margenNeto.toFixed(1)}%</div>
                            <div class="card-label">ğŸ“Š Margen Neto</div>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="section" style="border-left: 4px solid #28a745; background: #d4edda;">
                        <h3>âœ… FORTALEZAS</h3>
                        ${fortalezas.length > 0 ? fortalezas.map(f => '<p style="margin: 8px 0; font-weight: 500;">' + f + '</p>').join('') : '<p style="color: #666;">Sin fortalezas detectadas - Necesitas mejorar</p>'}
                    </div>
                    
                    <div class="section" style="border-left: 4px solid #dc3545; background: #f8d7da;">
                        <h3>âŒ DEBILIDADES</h3>
                        ${debilidades.length > 0 ? debilidades.map(d => '<p style="margin: 8px 0; font-weight: 500;">' + d + '</p>').join('') : '<p style="color: #666; font-weight: 600;">âœ… No hay debilidades crÃ­ticas detectadas</p>'}
                    </div>

                    <div class="section" style="border-left: 4px solid #17a2b8; background: #d1ecf1;">
                        <h3>ğŸ’¡ OPORTUNIDADES DE CRECIMIENTO</h3>
                        ${oportunidades.length > 0 ? oportunidades.map(o => '<p style="margin: 8px 0; font-weight: 500;">' + o + '</p>').join('') : '<p style="color: #666;">Sin oportunidades detectadas</p>'}
                    </div>

                    <div class="section" style="border-left: 4px solid #ffc107; background: #fff9e6;">
                        <h3>ğŸš¨ AMENAZAS Y RIESGOS</h3>
                        ${amenazas.length > 0 ? amenazas.map(a => '<p style="margin: 8px 0; font-weight: 500;">' + a + '</p>').join('') : '<p style="color: #666; font-weight: 600;">âœ… Sin amenazas crÃ­ticas detectadas</p>'}
                    </div>
                </div>

                <div class="section" style="border-left: 4px solid #667eea;">
                    <h3>ğŸ¯ PLAN DE ACCIÃ“N ESTRATÃ‰GICO (Prioridades)</h3>
                    <table>
                        <tr style="background: #667eea; color: white;">
                            <th><b>Prioridad</b></th>
                            <th><b>AcciÃ³n Recomendada</b></th>
                            <th><b>Impacto Potencial</b></th>
                            <th><b>Plazo</b></th>
                        </tr>
            `;

            // Prioridades dinÃ¡micas
            let prioridades = [];
            
            if (balance < 0) {
                prioridades.push({
                    p: 'ğŸ”´ CRÃTICA',
                    a: 'Detener pÃ©rdidas: Reduce gastos variables en 30% INMEDIATAMENTE',
                    i: 'Transformar pÃ©rdidas en ganancias',
                    t: '7 dÃ­as'
                });
            }
            
            if (porcentajeGastosVariables > 20) {
                prioridades.push({
                    p: 'ğŸ”´ ALTA',
                    a: 'Reduce gastos variables: Negocia con proveedores, automatiza procesos',
                    i: '+' + fmt(gastosVariables * 0.25),
                    t: '15-30 dÃ­as'
                });
            }
            
            if (porcentajeGastosFijos > 45) {
                prioridades.push({
                    p: 'ğŸ”´ ALTA',
                    a: 'Renegocia gastos fijos: Alquiler, servicios, seguros, etc.',
                    i: '+' + fmt(gastosFijos * 0.20),
                    t: '30-60 dÃ­as'
                });
            }
            
            if (porcentajeCompras > 40) {
                prioridades.push({
                    p: 'ğŸŸ¡ MEDIA',
                    a: 'Mejora COGS: Busca nuevos proveedores, negocia volÃºmenes',
                    i: '+' + fmt(totalCompras * 0.15),
                    t: '30-45 dÃ­as'
                });
            }
            
            if (totalIngresos > 0 && porcentajeCompras + porcentajeGastosFijos < 70) {
                prioridades.push({
                    p: 'ğŸŸ¢ MEDIA',
                    a: 'Aumenta ingresos: Sube precios 10-15% o captura mÃ¡s clientes',
                    i: '+' + fmt(totalIngresos * 0.15),
                    t: '60-90 dÃ­as'
                });
            }
            
            if (balance > 0 && balance > totalIngresos * 0.15) {
                prioridades.push({
                    p: 'ğŸŸ¢ MEDIA',
                    a: 'Invierte en crecimiento: Marketing, nuevos productos, capacitaciÃ³n',
                    i: 'Crecimiento exponencial',
                    t: 'Permanente'
                });
            }

            prioridades.forEach(pr => {
                html += '<tr><td><b>' + pr.p + '</b></td><td>' + pr.a + '</td><td><b>' + pr.i + '</b></td><td>' + pr.t + '</td></tr>';
            });

            html += `
                    </table>
                </div>

                <div class="section" style="border-left: 4px solid #28a745; background: linear-gradient(135deg, rgba(40,167,69,0.1), rgba(32,201,151,0.1));">
                    <h3>ğŸ“ˆ PROYECCIÃ“N DE CRECIMIENTO (Si ejecutas acciones)</h3>
                    <p style="color: #666; margin-bottom: 15px;">Estimaciones basadas en mejoras conservadoras de 20-30%</p>
                    
                    <table>
                        <tr>
                            <th>Escenario</th>
                            <th style="text-align: right;">Ingresos Proyectados</th>
                            <th style="text-align: right;">Costos Proyectados</th>
                            <th style="text-align: right;">Ganancia Proyectada</th>
                            <th style="text-align: right;">Margen Proyectado</th>
                        </tr>
                        <tr>
                            <td><b>Conservador (Sin cambios)</b></td>
                            <td style="text-align: right;">${fmt(totalIngresos)}</td>
                            <td style="text-align: right;">${fmt(totalGastos + totalCompras)}</td>
                            <td style="text-align: right;">${fmt(balance)}</td>
                            <td style="text-align: right;">${margenNeto.toFixed(1)}%</td>
                        </tr>
                        <tr style="background: #fff9e6;">
                            <td><b>Moderado (Reduce costos 20%)</b></td>
                            <td style="text-align: right;">${fmt(totalIngresos)}</td>
                            <td style="text-align: right;">${fmt((totalGastos + totalCompras) * 0.8)}</td>
                            <td style="text-align: right;"><b>${fmt(totalIngresos - (totalGastos + totalCompras) * 0.8)}</b></td>
                            <td style="text-align: right;"><b>${((totalIngresos - (totalGastos + totalCompras) * 0.8) / totalIngresos * 100).toFixed(1)}%</b></td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td><b>Agresivo (Crece 30% + Reduce costos 25%)</b></td>
                            <td style="text-align: right;">${fmt(totalIngresos * 1.3)}</td>
                            <td style="text-align: right;">${fmt((totalGastos + totalCompras) * 0.75)}</td>
                            <td style="text-align: right;"><b style="font-size: 1.2rem; color: #28a745;">${fmt((totalIngresos * 1.3) - (totalGastos + totalCompras) * 0.75)}</b></td>
                            <td style="text-align: right;"><b style="color: #28a745;">${(((totalIngresos * 1.3) - (totalGastos + totalCompras) * 0.75) / (totalIngresos * 1.3) * 100).toFixed(1)}%</b></td>
                        </tr>
                    </table>
                </div>

                <div class="section" style="border-left: 4px solid #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));">
                    <h3>ğŸ’¼ RECOMENDACIONES ESPECÃFICAS PARA TU NEGOCIO</h3>
                    
                    <h4>ğŸ“Š Estructura de Costos - Tu DistribuciÃ³n Actual:</h4>
                    <ul style="padding-left: 20px; line-height: 2;">
                        <li><b>Gastos Fijos: ${porcentajeGastosFijos.toFixed(1)}%</b> (${porcentajeGastosFijos < 50 ? 'âœ… BIEN' : 'âš ï¸ ALTO'})</li>
                        <li><b>Gastos Variables: ${porcentajeGastosVariables.toFixed(1)}%</b> (${porcentajeGastosVariables < 30 ? 'âœ… BIEN' : 'âš ï¸ ALTO'})</li>
                        <li><b>COGS (Compras): ${porcentajeCompras.toFixed(1)}%</b> (${porcentajeCompras < 40 ? 'âœ… BIEN' : 'âš ï¸ ALTO'})</li>
                        <li><b>Ganancia Neta: ${margenNeto.toFixed(1)}%</b> (${margenNeto > 15 ? 'âœ… MUY BUENA' : 'âš ï¸ MEJORABLE'})</li>
                    </ul>

                    <h4 style="margin-top: 20px;">ğŸ¯ 3 Acciones de MÃXIMO IMPACTO (Empieza ya):</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 10px 0;"><b>1ï¸âƒ£ REDUCIR COSTOS (Impacto: ${fmt(totalGastos * 0.25)}+ ganancia potencial)</b></p>
                        <p style="color: #666; margin-left: 20px; margin-bottom: 10px;">
                            â€¢ Revisa todos los gastos fijos mensuales<br>
                            â€¢ Llama a 3 proveedores alternativos para gastos variables<br>
                            â€¢ Cancela suscripciones/servicios no esenciales<br>
                            â€¢ Negocia reducciÃ³n de 15-20% con actuales proveedores
                        </p>
                        <p style="margin: 10px 0;"><b>2ï¸âƒ£ AUMENTAR INGRESOS (Impacto: ${fmt(totalIngresos * 0.2)}+ ganancia potencial)</b></p>
                        <p style="color: #666; margin-left: 20px; margin-bottom: 10px;">
                            â€¢ Sube precios 10-15% a clientes nuevos<br>
                            â€¢ Crea paquetes/bundles para vender mÃ¡s por cliente<br>
                            â€¢ Implementa membresÃ­a o modelo recurrente<br>
                            â€¢ Abre nuevo canal de venta (online, redes, etc)
                        </p>
                        <p style="margin: 10px 0;"><b>3ï¸âƒ£ MEJORAR MÃRGENES (Impacto: ${fmt(balance * 0.4)}+ ganancia potencial)</b></p>
                        <p style="color: #666; margin-left: 20px;">
                            â€¢ Busca proveedores con mejores precios<br>
                            â€¢ Aumenta volÃºmenes para negociar descuentos<br>
                            â€¢ Optimiza procesos para reducir desperdicios<br>
                            â€¢ Vende productos de mayor margen
                        </p>
                    </div>

                    <h4 style="margin-top: 20px;">ğŸ“Š KPIs que DEBES MONITOREAR Mensualmente:</h4>
                    <ul style="padding-left: 20px; line-height: 1.8;">
                        <li><b>Margen Neto:</b> Meta: >20% (Tuyo: ${margenNeto.toFixed(1)}%)</li>
                        <li><b>Gastos Fijos %:</b> Meta: <40% (Tuyo: ${porcentajeGastosFijos.toFixed(1)}%)</li>
                        <li><b>COGS %:</b> Meta: <35% (Tuyo: ${porcentajeCompras.toFixed(1)}%)</li>
                        <li><b>Cash Runway:</b> DÃ­as de solvencia: ${Math.round(diasDeSolvencia)} dÃ­as (Meta: >90 dÃ­as)</li>
                        <li><b>ROI:</b> Retorno sobre inversiÃ³n (Mencionado en rentabilidad)</li>
                    </ul>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <h3 style="margin: 0 0 10px 0;">ğŸ’¡ MENSAJE FINAL</h3>
                    <p style="margin: 0; line-height: 1.8;">
                        ${balance >= totalIngresos * 0.2 ? 
                            'âœ… <b>Â¡EXCELENTE POSICIÃ“N!</b> Tu empresa tiene un excelente balance. Ahora enfÃ³cate en CRECER: invierte en marketing, nuevos productos y equipo. Tu margen lo permite.' 
                            : balance >= 0 ? 
                            'ğŸŸ¡ <b>BUENA BASE.</b> Tu empresa es rentable. Antes de crecer, optimiza costos para llegar a 20%+ margen neto. DespuÃ©s sÃ­, crece agresivamente.' 
                            : 
                            'ğŸš¨ <b>URGENTE.</b> EstÃ¡s en pÃ©rdidas. Ejecuta YA las 3 acciones de mÃ¡ximo impacto. Tienes ' + Math.round(diasDeSolvencia) + ' dÃ­as de solvencia. Necesitas cambios inmediatos.'
                        }
                    </p>
                </div>

                <div class="section" style="border-left: 4px solid #667eea; margin-top: 20px;">
                    <h3>ğŸ’¬ CHAT CON IA - ConsultÃ¡ tus dudas</h3>
                    <div class="alert alert-info">
                        <p style="margin: 0;">Preguntale a la IA sobre tÃ©rminos financieros, estrategias de mejora, o cualquier duda sobre tu negocio.</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px;"><b>Ejemplos:</b> "Â¿QuÃ© es el margen bruto?", "Â¿CÃ³mo puedo reducir costos?", "Â¿QuÃ© significa COGS?"</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label><b>Seleccionar IA:</b></label>
                        <select id="iaSeleccionada" style="width: 100%; margin-top: 5px;">
                            <option value="gemini" selected>âœ¨ Gemini (Google) - GRATIS</option>
                            <option value="openai">ğŸ¤– ChatGPT (OpenAI) - Pago</option>
                            <option value="claude">ğŸ§  Claude (Anthropic) - Pago</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label><b>Tu API Key:</b></label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="password" id="iaApiKey" placeholder="PegÃ¡ tu API Key aquÃ­..." style="flex: 1;">
                            <button class="btn btn-info btn-sm" onclick="toggleApiKeyVisibility()">ğŸ‘ï¸</button>
                            <button class="btn btn-success btn-sm" onclick="guardarApiKey()">ğŸ’¾</button>
                        </div>
                        <p style="font-size: 11px; color: #666; margin-top: 5px;">
                            ğŸ”’ Tu API Key se guarda solo en tu navegador (localStorage).<br>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank">ğŸ†“ Obtener API Key Gemini (GRATIS)</a> | 
                            <a href="https://platform.openai.com/api-keys" target="_blank">Obtener API Key OpenAI</a> | 
                            <a href="https://console.anthropic.com/" target="_blank">Obtener API Key Claude</a>
                        </p>
                    </div>
                    
                    <div id="chatContainer" style="background: #f8f9fa; border-radius: 12px; padding: 15px; max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                        <div id="chatMessages">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                <p>ğŸ‘‹ Â¡Hola! Soy tu asistente financiero.</p>
                                <p>Preguntame lo que necesites sobre finanzas, contabilidad o tu negocio.</p>
                                <p style="font-size: 12px; margin-top: 10px;">ğŸ’¡ <b>Tip:</b> UsÃ¡ Gemini de Google, es GRATIS.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" placeholder="EscribÃ­ tu pregunta aquÃ­..." style="flex: 1;" onkeypress="if(event.key==='Enter') enviarMensajeIA()">
                        <button class="btn btn-success" onclick="enviarMensajeIA()">ğŸ“¤ Enviar</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><b>Preguntas rÃ¡pidas:</b></p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿QuÃ© es el margen bruto y cÃ³mo mejorarlo?')">ğŸ“Š Margen Bruto</button>
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿QuÃ© significa COGS y cÃ³mo reducirlo?')">ğŸ“¦ COGS</button>
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿CÃ³mo calcular el punto de equilibrio?')">âš–ï¸ Punto Equilibrio</button>
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿QuÃ© es el flujo de caja y por quÃ© es importante?')">ğŸ’¹ Flujo de Caja</button>
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿CÃ³mo puedo reducir mis gastos fijos?')">ğŸ“‰ Reducir Gastos</button>
                            <button class="btn btn-sm" onclick="preguntaRapida('Â¿QuÃ© estrategias puedo usar para aumentar mis ventas?')">ğŸ“ˆ Aumentar Ventas</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('recPanel').innerHTML = html;
            cargarApiKeyGuardada();
        }

        // ============ FUNCIONES DEL CHAT IA ============
        let chatHistorial = [];

        function cargarApiKeyGuardada() {
            const savedKey = localStorage.getItem('iaApiKey');
            const savedProvider = localStorage.getItem('iaProvider');
            if (savedKey) {
                document.getElementById('iaApiKey').value = savedKey;
            }
            if (savedProvider) {
                document.getElementById('iaSeleccionada').value = savedProvider;
            }
        }

        function guardarApiKey() {
            const apiKey = document.getElementById('iaApiKey').value.trim();
            const provider = document.getElementById('iaSeleccionada').value;
            if (apiKey) {
                localStorage.setItem('iaApiKey', apiKey);
                localStorage.setItem('iaProvider', provider);
                notif('âœ… API Key guardada correctamente', 'success');
            } else {
                notif('âš ï¸ IngresÃ¡ una API Key vÃ¡lida', 'warning');
            }
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('iaApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function preguntaRapida(pregunta) {
            document.getElementById('chatInput').value = pregunta;
            enviarMensajeIA();
        }

        function agregarMensajeChat(mensaje, esUsuario) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                background: ${esUsuario ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'white'};
                color: ${esUsuario ? 'white' : '#333'};
                padding: 12px 16px;
                border-radius: ${esUsuario ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
                margin: 8px 0;
                max-width: 85%;
                ${esUsuario ? 'margin-left: auto;' : 'margin-right: auto;'}
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                word-wrap: break-word;
            `;
            msgDiv.innerHTML = `<b>${esUsuario ? 'ğŸ‘¤ Vos' : 'ğŸ¤– IA'}:</b><br>${mensaje}`;
            chatMessages.appendChild(msgDiv);
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function agregarMensajeCargando() {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.id = 'mensajeCargando';
            msgDiv.style.cssText = `
                background: white;
                color: #666;
                padding: 12px 16px;
                border-radius: 18px 18px 18px 4px;
                margin: 8px 0;
                max-width: 85%;
                margin-right: auto;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;
            msgDiv.innerHTML = 'ğŸ¤– <b>IA estÃ¡ pensando...</b> â³';
            chatMessages.appendChild(msgDiv);
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function eliminarMensajeCargando() {
            const msgCargando = document.getElementById('mensajeCargando');
            if (msgCargando) msgCargando.remove();
        }

        async function enviarMensajeIA() {
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            const apiKey = document.getElementById('iaApiKey').value.trim();
            const provider = document.getElementById('iaSeleccionada').value;
            
            if (!mensaje) {
                notif('âš ï¸ EscribÃ­ una pregunta', 'warning');
                return;
            }
            
            if (!apiKey) {
                notif('âš ï¸ NecesitÃ¡s ingresar tu API Key para usar el chat. Gemini es GRATIS!', 'warning');
                return;
            }
            
            // Agregar mensaje del usuario
            agregarMensajeChat(mensaje, true);
            input.value = '';
            
            // Mostrar cargando
            agregarMensajeCargando();
            
            // Contexto financiero del negocio
            const contexto = obtenerContextoFinanciero();
            
            try {
                let respuesta;
                if (provider === 'gemini') {
                    respuesta = await llamarGemini(mensaje, contexto, apiKey);
                } else if (provider === 'openai') {
                    respuesta = await llamarOpenAI(mensaje, contexto, apiKey);
                } else {
                    respuesta = await llamarClaude(mensaje, contexto, apiKey);
                }
                
                eliminarMensajeCargando();
                agregarMensajeChat(respuesta, false);
                
                // Guardar en historial
                chatHistorial.push({ usuario: mensaje, ia: respuesta, fecha: new Date().toISOString() });
                
            } catch (error) {
                eliminarMensajeCargando();
                agregarMensajeChat('âŒ Error: ' + error.message, false);
                notif('âŒ Error al conectar con la IA: ' + error.message, 'danger');
            }
        }

        function obtenerContextoFinanciero() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);
            
            const totalIngresos = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalCompras = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);
            const totalGastos = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const balance = totalIngresos - totalGastos - totalCompras;
            const margenNeto = totalIngresos > 0 ? (balance / totalIngresos) * 100 : 0;
            
            return `
CONTEXTO DEL NEGOCIO (Distribuidora de FerreterÃ­a en Argentina):
- Ingresos totales: $${Math.round(totalIngresos).toLocaleString('es-AR')} ARS
- Gastos totales: $${Math.round(totalGastos).toLocaleString('es-AR')} ARS  
- Compras/COGS: $${Math.round(totalCompras).toLocaleString('es-AR')} ARS
- Balance/Ganancia: $${Math.round(balance).toLocaleString('es-AR')} ARS
- Margen neto: ${margenNeto.toFixed(1)}%
- Tipo de cambio USD/ARS: $${datos.config.tipoCambioBNA}

Responde de forma clara, prÃ¡ctica y en espaÃ±ol argentino. Si te preguntan tÃ©rminos financieros, explicalos de forma simple con ejemplos.`;
        }

        async function llamarOpenAI(mensaje, contexto, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        { 
                            role: 'system', 
                            content: 'Sos un asesor financiero experto para PyMEs en Argentina. RespondÃ©s en espaÃ±ol argentino de forma clara y prÃ¡ctica. ' + contexto 
                        },
                        { role: 'user', content: mensaje }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Error en la API de OpenAI');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function llamarClaude(mensaje, contexto, apiKey) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-3-haiku-20240307',
                    max_tokens: 1000,
                    system: 'Sos un asesor financiero experto para PyMEs en Argentina. RespondÃ©s en espaÃ±ol argentino de forma clara y prÃ¡ctica. ' + contexto,
                    messages: [
                        { role: 'user', content: mensaje }
                    ]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Error en la API de Claude');
            }
            
            const data = await response.json();
            return data.content[0].text;
        }

        async function llamarGemini(mensaje, contexto, apiKey) {
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: 'Sos un asesor financiero experto para PyMEs en Argentina. RespondÃ©s en espaÃ±ol argentino de forma clara y prÃ¡ctica.\n\n' + contexto + '\n\nPregunta del usuario: ' + mensaje
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1000
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Error en la API de Gemini. VerificÃ¡ tu API Key.');
            }
            
            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Respuesta inesperada de Gemini');
            }
        }

        // ============ BACKUP Y RESTAURACIÃ“N ============
        function mostrarBackup() {
            let html = '<div class="section"><h3>ğŸ’¾ GestiÃ³n de Datos</h3>';
            html += '<button class="btn btn-success" onclick="descargarBackup()">â¬‡ï¸ Descargar Backup JSON</button> ';
            html += '<button class="btn btn-info" onclick="document.getElementById(\'archivoBackup\').click()">â¬†ï¸ Restaurar desde Backup</button>';
            html += '<input type="file" id="archivoBackup" style="display:none;" onchange="restaurarBackup()">';
            html += '</div>';
            
            html += '<div class="section"><h3>ğŸ“Š Estado de Datos</h3>';
            html += '<p>ğŸ“ Ingresos: ' + datos.ingresos.length + ' registros</p>';
            html += '<p>ğŸ“ Gastos: ' + datos.gastos.length + ' registros</p>';
            html += '<p>ğŸ“ Compras: ' + datos.compras.length + ' registros</p>';
            html += '<p>ğŸ‘¥ Clientes: ' + datos.clientes.length + '</p>';
            html += '<p>ğŸ­ Proveedores: ' + datos.proveedores.length + '</p>';
            html += '<p>ğŸ‘” Empleados: ' + datos.empleados.length + '</p>';
            html += '</div>';
            
            document.getElementById('panelBackup').innerHTML = html;
        }

        function descargarBackup() {
            const backup = JSON.stringify(datos, null, 2);
            const blob = new Blob([backup], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup-sistema-financiero-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            notif('âœ… Backup descargado', 'success');
        }

        function restaurarBackup() {
            const archivo = document.getElementById('archivoBackup').files[0];
            if (!archivo) return;
            
            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const datosRestaur = JSON.parse(e.target.result);
                    // Reemplazar completamente los datos
                    datos = { ...datos, ...datosRestaur };
                    
                    // Guardar en localStorage primero
                    localStorage.setItem('datosFinancieros', JSON.stringify(datos));
                    
                    // Guardar en Firebase dividido en documentos
                    if (firebaseActivo && db) {
                        ignorarSnapshot = true;
                        
                        const batch = db.batch();
                        batch.set(db.collection('sistema').doc('ingresos'), { items: datos.ingresos || [] });
                        batch.set(db.collection('sistema').doc('gastos'), { items: datos.gastos || [] });
                        batch.set(db.collection('sistema').doc('compras'), { items: datos.compras || [] });
                        batch.set(db.collection('sistema').doc('config'), { 
                            config: datos.config || {},
                            filtros: datos.filtros || {},
                            saldos: datos.saldos || {},
                            ahorros: datos.ahorros || {},
                            inversiones: datos.inversiones || {}
                        });
                        batch.set(db.collection('sistema').doc('otros'), { 
                            empleados: datos.empleados || [],
                            adelantos: datos.adelantos || [],
                            movimientos: datos.movimientos || [],
                            recordatorios: datos.recordatorios || [],
                            clientes: datos.clientes || [],
                            proveedores: datos.proveedores || [],
                            cuentas: datos.cuentas || [],
                            alertasConfig: datos.alertasConfig || [],
                            cajas: datos.cajas || []
                        });
                        
                        batch.commit()
                            .then(function() {
                                ignorarSnapshot = false;
                                notif('âœ… Backup restaurado y sincronizado con Firebase', 'success');
                                mostrarBackup();
                                actualizarDash();
                            })
                            .catch(function(error) {
                                ignorarSnapshot = false;
                                notif('âš ï¸ Error en Firebase: ' + error.message, 'warning');
                                mostrarBackup();
                                actualizarDash();
                            });
                    } else {
                        notif('âœ… Datos restaurados correctamente', 'success');
                        mostrarBackup();
                        actualizarDash();
                    }
                } catch (err) {
                    notif('âŒ Error al restaurar: ' + err.message, 'danger');
                }
            };
            lector.readAsText(archivo);
        }

        // ============ CONFIGURACIÃ“N ============
        function mostrarConfiguracion() {
            let html = '<div class="section"><h3>âš™ï¸ ConfiguraciÃ³n del Sistema</h3>';
            html += '<div class="grid-2">';
            html += `<div><label>Tipo de Cambio BNA (USD â†’ ARS):</label><input type="number" id="configTipoCambio" value="${datos.config.tipoCambioBNA}" step="0.01"></div>`;
            html += `<div style="display: flex; align-items: flex-end;"><button class="btn btn-success" onclick="guardarConfiguracion()" style="width: 100%;">âœ… Guardar ConfiguraciÃ³n</button></div>`;
            html += '</div></div>';
            
            html += '<div class="section"><h3>ğŸŒ“ Tema</h3>';
            html += '<button class="btn btn-info" onclick="toggleDark()">ğŸŒ™ Alternar Modo Oscuro</button>';
            html += '</div>';
            
            html += '<div class="section"><h3>ğŸ—‘ï¸ Peligro</h3>';
            html += '<button class="btn btn-danger" onclick="limpiarTodosDatos()">âš ï¸ Eliminar Todos los Datos</button>';
            html += '</div>';
            
            document.getElementById('panelConfiguracion').innerHTML = html;
        }

        function guardarConfiguracion() {
            datos.config.tipoCambioBNA = parseFloat(document.getElementById('configTipoCambio').value) || 1400;
            guardarDatos();
            document.getElementById('tipoCambio').textContent = datos.config.tipoCambioBNA.toLocaleString('es-AR');
            actualizarDash();
            notif('âœ… ConfiguraciÃ³n guardada', 'success');
        }

        function limpiarTodosDatos() {
            if (confirm('âš ï¸ Â¿EstÃ¡s SEGURO? Esta acciÃ³n NO se puede deshacer y eliminarÃ¡ TODOS los datos.')) {
                if (confirm('Escribe "CONFIRMAR" para proceder: (confirmaciÃ³n final)')) {
                    datos = {
                        ingresos: [], gastos: [], compras: [], empleados: [], adelantos: [], movimientos: [], recordatorios: [],
                        clientes: [], proveedores: [], cuentas: [], alertasConfig: [], cajas: [],
                        saldos: { efectivo: 0, banco: 0, mp: 0, cheques: 0, echeq: 0, porCobrar: 0, porPagar: 0 },
                        ahorros: { meta: 0, actual: 0, historial: [] },
                        inversiones: { cartola: [], metaJubilacion: 0, totalInvertido: 0, alertasInversion: [], perfilRiesgo: 'moderado', billeteras: { brubank: 0, prex: 0, binance: 0, galeriaGalicia: 0, naranjaX: 0, balanz: 0 } },
                        config: { dark: false, notificaciones: true, tipoCambioBNA: 1400 },
                        filtros: { activo: false, tipoFiltro: 'todo', aÃ±o: new Date().getFullYear(), mes: new Date().getMonth() + 1, trimestre: Math.ceil((new Date().getMonth() + 1) / 3), fechaDesde: '', fechaHasta: '' }
                    };
                    guardarDatos();
                    actualizarDash();
                    notif('âœ… Datos eliminados', 'success');
                }
            }
        }

        function actualizarDash() {
            const ingresosFiltrados = aplicarFiltros(datos.ingresos);
            const gastosFiltrados = aplicarFiltros(datos.gastos);
            const comprasFiltradas = aplicarFiltros(datos.compras);

            const ingMes = ingresosFiltrados.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const gastMes = gastosFiltrados.reduce((s, g) => s + parseFloat(g.monto || 0), 0);
            const compMes = comprasFiltradas.reduce((s, c) => s + parseFloat(c.monto || 0), 0);

            const totalSaldos = datos.saldos.efectivo + datos.saldos.banco + datos.saldos.mp + 
                               datos.saldos.cheques + datos.saldos.echeq;
            
            // Calcular total en cajas
            const totalCajas = (datos.cajas || []).reduce((sum, caja) => sum + (caja.monto || 0), 0);
            
            const balanceMes = ingMes - gastMes - compMes;
            const totalEgresos = gastMes + compMes;

            let filtroInfo = '';
            if (datos.filtros.activo) {
                let textoFiltro = '';
                if (datos.filtros.tipoFiltro === 'mes') {
                    textoFiltro = `${datos.filtros.mes}/${datos.filtros.aÃ±o}`;
                } else if (datos.filtros.tipoFiltro === 'trimestre') {
                    textoFiltro = `Q${datos.filtros.trimestre} ${datos.filtros.aÃ±o}`;
                } else if (datos.filtros.tipoFiltro === 'aÃ±o') {
                    textoFiltro = `AÃ±o ${datos.filtros.aÃ±o}`;
                } else if (datos.filtros.tipoFiltro === 'personalizado') {
                    textoFiltro = `${fmtFecha(datos.filtros.fechaDesde)} - ${fmtFecha(datos.filtros.fechaHasta)}`;
                }
                filtroInfo = `
                    <div class="alert alert-info">
                        <b>ğŸ” Filtro activo:</b> ${textoFiltro}  
                        <button class="btn btn-sm btn-warning" onclick="limpiarFiltros()" style="margin-left: 10px;">âœ– Limpiar Filtro</button>
                    </div>
                `;
            }

            const panel = `
                <div class="section">
                    <h3>ğŸ” Filtros por PerÃ­odo</h3>
                    ${filtroInfo}
                    <div class="grid-4" style="margin-bottom: 15px;">
                        <div>
                            <label>AÃ±o:</label>
                            <select id="filtroAÃ±o">
                                <option value="">Seleccionar</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div>
                            <label>Mes:</label>
                            <select id="filtroMes">
                                <option value="">Todos</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div>
                            <label>Trimestre:</label>
                            <select id="filtroTrimestre">
                                <option value="">Todos</option>
                                <option value="1">Q1 (Ene-Mar)</option>
                                <option value="2">Q2 (Abr-Jun)</option>
                                <option value="3">Q3 (Jul-Sep)</option>
                                <option value="4">Q4 (Oct-Dic)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-info" onclick="aplicarFiltroRapido()" style="width: 100%;">ğŸ” Aplicar</button>
                        </div>
                    </div>
                </div>

                <div class="grid-4">
                    <div class="card"><div class="card-value">${fmt(ingMes)}</div><div class="card-label">ğŸ’° Ingresos${datos.filtros.activo ? ' (Filtrados)' : ' del Mes'}</div></div>
                    <div class="card"><div class="card-value">${fmt(gastMes)}</div><div class="card-label">ğŸ“¤ Gastos${datos.filtros.activo ? ' (Filtrados)' : ' del Mes'}</div></div>
                    <div class="card"><div class="card-value">${fmt(compMes)}</div><div class="card-label">ğŸ›’ Compras${datos.filtros.activo ? ' (Filtradas)' : ' del Mes'}</div></div>
                    <div class="card" style="background: ${balanceMes >= 0 ? 'linear-gradient(135deg, #28a745, #20c997)' : 'linear-gradient(135deg, #dc3545, #c82333)'};"><div class="card-value">${fmt(balanceMes)}</div><div class="card-label">ğŸ“Š Balance${datos.filtros.activo ? ' (Filtrado)' : ' del Mes'}</div></div>
                    <div class="card" style="background: linear-gradient(135deg, #17a2b8, #138496);"><div class="card-value">${fmt(totalCajas)}</div><div class="card-label">ğŸ¦ Total en Cajas</div></div>
                    <div class="card"><div class="card-value">${fmt(totalEgresos)}</div><div class="card-label">ğŸ’¸ Egresos Totales</div></div>
                    <div class="card"><div class="card-value">${fmt(datos.saldos.porCobrar)}</div><div class="card-label">ğŸ“¥ Por Cobrar</div></div>
                    <div class="card"><div class="card-value">${fmt(datos.saldos.porPagar)}</div><div class="card-label">ğŸ“¤ Por Pagar</div></div>
                </div>
            `;

            document.getElementById('panelDash').innerHTML = panel;
        }

        function aplicarFiltroRapido() {
            const aÃ±o = parseInt(document.getElementById('filtroAÃ±o').value);
            const mes = parseInt(document.getElementById('filtroMes').value);
            const trimestre = parseInt(document.getElementById('filtroTrimestre').value);
            
            if (!aÃ±o) {
                notif('âš ï¸ Selecciona al menos un aÃ±o', 'warning');
                return;
            }
            
            if (mes) {
                activarFiltroMes(aÃ±o, mes);
            } else if (trimestre) {
                activarFiltroTrimestre(aÃ±o, trimestre);
            } else {
                activarFiltroAÃ±o(aÃ±o);
            }
        }

        // ============ RENDERIZADO PRINCIPAL ============
        function renderContent() {
            document.getElementById('content').innerHTML = `
                <div id="carga" class="tab-content active">
                    <h2>ğŸ“ Carga de Datos</h2>
                    
                    <div class="section" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">
                        <h3 style="color: white; border-bottom: 3px solid white;">ğŸ“Š Estado Actual de Datos Cargados</h3>
                        <div id="estadoDatos" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ’° Registrar Ingreso Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="ingMonto" placeholder="Monto Bruto (USD)" step="0.01">
                            <input type="number" id="ingRetencion" placeholder="Retenciones (USD)" step="0.01" value="0">
                            <input type="date" id="ingFecha">
                            <input type="text" id="ingDesc" placeholder="DescripciÃ³n">
                            <select id="ingMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                            <select id="ingCategoria">
                                <option value="Ventas">Ventas</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Cobros">Cobros</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <button class="btn btn-success" onclick="registrarIngreso()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Ingresos desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con INGRESOS (montos en ARS)</b></p>
                        <div class="alert alert-info" style="margin-bottom:10px;">
                            <b>Columnas necesarias (en orden):</b><br>
                            â€¢ Columna A: <b>Fecha</b><br>
                            â€¢ Columna B: <b>Razon Social</b><br>
                            â€¢ Columna C: <b>Nombre Concepto</b><br>
                            â€¢ Columna D: <b>Total</b> (monto en ARS - se convertirÃ¡ a USD automÃ¡ticamente)
                        </div>
                        <input type="file" id="archivoIngresos" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-success" onclick="procesarArchivoIngresos()">ğŸ“¥ Cargar Ingresos</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploIngresos()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¤ Registrar Gasto Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="gastMonto" placeholder="Monto (USD)" step="0.01">
                            <input type="date" id="gastFecha">
                            <input type="text" id="gastDesc" placeholder="DescripciÃ³n">
                            <select id="gastMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                            <select id="gastCategoria">
                                <option value="Alquiler">Alquiler</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Sueldos">Sueldos</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <select id="gastTipo">
                                <option value="false">Gasto Fijo</option>
                                <option value="true">Gasto Variable</option>
                            </select>
                            <button class="btn btn-warning" onclick="registrarGasto()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Gastos desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con GASTOS (montos en ARS)</b></p>
                        <input type="file" id="archivoGastos" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-warning" onclick="procesarArchivoGastos()">ğŸ“¥ Cargar Gastos</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploGastos()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>

                    <div class="section">
                        <h3>ğŸ›’ Registrar Compra Individual</h3>
                        <div class="grid-5">
                            <input type="number" id="compMonto" placeholder="Monto (USD)" step="0.01">
                            <input type="date" id="compFecha">
                            <input type="text" id="compDesc" placeholder="DescripciÃ³n">
                            <input type="text" id="compProv" placeholder="Proveedor">
                            <select id="compMetodo">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Banco">Banco</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Cuenta Corriente">Cuenta Corriente</option>
                            </select>
                            <select id="compCategoria">
                                <option value="MercaderÃ­a">MercaderÃ­a</option>
                                <option value="Insumos">Insumos</option>
                                <option value="Materias Primas">Materias Primas</option>
                                <option value="Equipamiento">Equipamiento</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <button class="btn btn-info" onclick="registrarCompra()">âœ… Registrar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“¥ Cargar Compras desde Archivo</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo Excel/CSV <b>solo con COMPRAS (montos en ARS)</b></p>
                        <input type="file" id="archivoCompras" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-info" onclick="procesarArchivoCompras()">ğŸ“¥ Cargar Compras</button>
                        <button class="btn btn-info btn-sm" onclick="descargarEjemploCompras()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo</button>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ“¤ Importar desde Excel/CSV (Carga Masiva Mixta)</h3>
                        <p style="font-size:13px;color:#666;margin-bottom:10px;">Sube un archivo con <b>INGRESOS, GASTOS y COMPRAS mezclados (montos en ARS)</b></p>
                        <input type="file" id="archivo" accept=".xlsx,.xls,.csv" style="margin-bottom:10px;">
                        <button class="btn btn-success" onclick="procesarArchivo()">ğŸ“¥ Procesar Archivo Mixto</button>
                        <button class="btn btn-info" onclick="descargarEjemplo()" style="margin-left:10px;">ğŸ“„ Descargar Ejemplo Excel</button>
                    </div>
                </div>

                <div id="dash" class="tab-content">
                    <h2>ğŸ“Š Dashboard Principal</h2>
                    <div id="panelDash"></div>
                </div>

                <div id="ingresos" class="tab-content">
                    <h2>ğŸ’° GestiÃ³n de Ingresos</h2>
                    <div id="listaIngresos"></div>
                </div>

                <div id="gastosFijos" class="tab-content">
                    <h2>ğŸ“ˆ Gastos Fijos y Variables</h2>
                    <div id="listaGastos"></div>
                </div>

                <div id="gastosDetalle" class="tab-content">
                    <h2>ğŸ“‹ Detalle de Gastos por Concepto</h2>
                    <div id="gastosDetalle"></div>
                </div>

                <div id="comprasView" class="tab-content">
                    <h2>ğŸ›’ GestiÃ³n de Compras</h2>
                    <div id="listaCompras"></div>
                </div>

                <div id="clientes" class="tab-content">
                    <h2>ğŸ‘¥ GestiÃ³n de Clientes</h2>
                    
                    <div class="section">
                        <h3>â• Agregar Cliente</h3>
                        <div class="alert alert-info">Ingresa la deuda inicial (si existe) en <b>Pesos Argentinos (ARS)</b></div>
                        <div class="grid-4">
                            <input type="text" id="cliNombre" placeholder="Nombre">
                            <input type="text" id="cliContacto" placeholder="TelÃ©fono">
                            <input type="text" id="cliEmail" placeholder="Email">
                            <input type="number" id="cliDeuda" placeholder="Deuda Inicial (ARS)" step="1000">
                            <button class="btn btn-success" onclick="agregarCliente()">âœ… Agregar</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ‘¥ Lista de Clientes</h3>
                        <div id="listaClientes"></div>
                    </div>
                </div>

                <div id="proveedores" class="tab-content">
                    <h2>ğŸ­ GestiÃ³n de Proveedores</h2>
                    
                    <div class="section">
                        <h3>â• Agregar Proveedor</h3>
                        <div class="alert alert-info">Ingresa la deuda inicial (si existe) en <b>Pesos Argentinos (ARS)</b></div>
                        <div class="grid-4">
                            <input type="text" id="provNombre" placeholder="Nombre">
                            <input type="text" id="provContacto" placeholder="TelÃ©fono">
                            <input type="text" id="provEmail" placeholder="Email">
                            <input type="number" id="provDeuda" placeholder="Deuda Inicial (ARS)" step="1000">
                            <button class="btn btn-success" onclick="agregarProveedor()">âœ… Agregar</button>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>ğŸ­ Lista de Proveedores</h3>
                        <div id="listaProveedores"></div>
                    </div>
                </div>

                <div id="inversiones" class="tab-content">
                    <h2>ğŸ’¼ Inversiones IOL - Mi JubilaciÃ³n</h2>
                    <div id="panelInversiones"></div>
                </div>

                <div id="puntoEquilibrio" class="tab-content">
                    <h2>âš–ï¸ Punto de Equilibrio</h2>
                    <div id="panelPuntoEquilibrio"></div>
                </div>

                <div id="movimientos" class="tab-content">
                    <h2>ğŸ’± Movimientos de Fondos</h2>
                    <div id="listaMovimientos"></div>
                </div>

                <div id="alertas" class="tab-content">
                    <h2>ğŸ”” Sistema de Alertas</h2>
                    <div id="panelAlertas"></div>
                </div>

                <div id="graficos" class="tab-content">
                    <h2>ğŸ“‰ GrÃ¡ficos y AnÃ¡lisis</h2>
                    <div id="panelGraficos"></div>
                </div>

                <div id="proyecciones" class="tab-content">
                    <h2>ğŸ”® Proyecciones Financieras</h2>
                    <div id="panelProyecciones"></div>
                </div>

                <div id="cashflow" class="tab-content">
                    <h2>ğŸ’¹ Cash Flow Anual</h2>
                    <div id="tablaCashFlow"></div>
                </div>

                <div id="ahorros" class="tab-content">
                    <h2>ğŸ· Plan de Ahorros</h2>
                    <div id="panelAhorros"></div>
                </div>

                <div id="cajas" class="tab-content">
                    <h2>ğŸ¦ GestiÃ³n de Cajas - ColchÃ³n de Emergencia</h2>
                    <div id="panelCajas"></div>
                </div>

                <div id="asistente" class="tab-content">
                    <h2>ğŸ¤– Asistente IA</h2>
                    <div id="recPanel"></div>
                </div>

                <div id="empleados" class="tab-content">
                    <h2>ğŸ‘” Personal</h2>
                    <div id="listaEmp"></div>
                </div>

                <div id="recordatorios" class="tab-content">
                    <h2>ğŸ“… Recordatorios</h2>
                    <div id="listaRecordatorios"></div>
                </div>

		<div id="estadoResultados" class="tab-content">
                    <h2>ğŸ“Š Estado de Resultados EconÃ³mico</h2>
                    <div id="panelEstadoResultados"></div>
                </div>

                <div id="estadoFinanciero" class="tab-content">
                    <h2>ğŸ’¹ Estado de Flujo de Caja</h2>
                    <div id="panelEstadoFinanciero"></div>
                </div>

                <div id="rentabilidad" class="tab-content">
                    <h2>ğŸ“ˆ Panel de Rentabilidad</h2>
                    <div id="panelRentabilidad"></div>
                </div>

                <div id="comparativo" class="tab-content">
                    <h2>ğŸ“Š AnÃ¡lisis Comparativo</h2>
                    <div id="panelComparativo"></div>
                </div>

                <div id="backup" class="tab-content">
                    <h2>ğŸ’¾ Backup y RestauraciÃ³n</h2>
                    <div id="panelBackup"></div>
                </div>

                <div id="usuarios" class="tab-content">
                    <h2>ğŸ‘¥ AdministraciÃ³n de Usuarios</h2>
                    <div id="panelUsuarios"></div>
                </div>

                <div id="configuracion" class="tab-content">
                    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
                    <div id="panelConfiguracion"></div>
                </div>
            `;
        }

        // ============ SISTEMA DE USUARIOS Y PERMISOS ============
        let usuarioActual = null;
        let usuarios = [];
        
        // Lista de todas las ventanas/tabs disponibles
        const todasLasVentanas = [
            { id: 'carga', nombre: 'ğŸ“ Carga de Datos' },
            { id: 'dash', nombre: 'ğŸ“Š Dashboard' },
            { id: 'ingresos', nombre: 'ğŸ’° Ingresos' },
            { id: 'gastosFijos', nombre: 'ğŸ“ˆ Gastos' },
            { id: 'gastosDetalle', nombre: 'ğŸ“‹ Detalle Gastos' },
            { id: 'comprasView', nombre: 'ğŸ›’ Compras' },
            { id: 'clientes', nombre: 'ğŸ‘¥ Clientes' },
            { id: 'proveedores', nombre: 'ğŸ­ Proveedores' },
            { id: 'puntoEquilibrio', nombre: 'âš–ï¸ Punto Equilibrio' },
            { id: 'cajas', nombre: 'ğŸ¦ Cajas' },
            { id: 'movimientos', nombre: 'ğŸ’± Movimientos' },
            { id: 'alertas', nombre: 'ğŸ”” Alertas' },
            { id: 'graficos', nombre: 'ğŸ“‰ GrÃ¡ficos' },
            { id: 'proyecciones', nombre: 'ğŸ”® Proyecciones' },
            { id: 'cashflow', nombre: 'ğŸ’¹ Cash Flow' },
            { id: 'ahorros', nombre: 'ğŸ· Ahorros/IOL' },
            { id: 'asistente', nombre: 'ğŸ¤– Asistente IA' },
            { id: 'empleados', nombre: 'ğŸ‘” Personal' },
            { id: 'recordatorios', nombre: 'ğŸ“… Recordatorios' },
            { id: 'estadoResultados', nombre: 'ğŸ“Š Estado Resultados' },
            { id: 'estadoFinanciero', nombre: 'ğŸ’¹ Estado Financiero' },
            { id: 'rentabilidad', nombre: 'ğŸ“ˆ Rentabilidad' },
            { id: 'comparativo', nombre: 'ğŸ“Š Comparativo' },
            { id: 'backup', nombre: 'ğŸ’¾ Backup' },
            { id: 'configuracion', nombre: 'âš™ï¸ ConfiguraciÃ³n' },
            { id: 'usuarios', nombre: 'ğŸ‘¥ Usuarios (Admin)' }
        ];
        
        function cargarUsuarios() {
            const guardados = localStorage.getItem('sistemaFinanciero_usuarios');
            if (guardados) {
                usuarios = JSON.parse(guardados);
            } else {
                // Usuario admin por defecto
                usuarios = [{
                    id: 1,
                    usuario: 'admin',
                    password: 'admin123',
                    nombre: 'Administrador',
                    rol: 'admin',
                    permisos: todasLasVentanas.map(v => v.id), // Todos los permisos
                    activo: true,
                    fechaCreacion: new Date().toISOString()
                }];
                guardarUsuarios();
            }
        }
        
        function guardarUsuarios() {
            localStorage.setItem('sistemaFinanciero_usuarios', JSON.stringify(usuarios));
        }
        
        function intentarLogin() {
            const usuario = document.getElementById('loginUsuario').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            if (!usuario || !password) {
                errorEl.textContent = 'Completa usuario y contraseÃ±a';
                errorEl.style.display = 'block';
                return;
            }
            
            cargarUsuarios();
            
            const user = usuarios.find(u => u.usuario.toLowerCase() === usuario.toLowerCase() && u.password === password && u.activo);
            
            if (user) {
                usuarioActual = user;
                sessionStorage.setItem('sistemaFinanciero_sesion', JSON.stringify(user));
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('nombreUsuarioActual').textContent = user.nombre;
                errorEl.style.display = 'none';
                init();
                notif('âœ… Bienvenido ' + user.nombre, 'success');
            } else {
                errorEl.textContent = 'Usuario o contraseÃ±a incorrectos';
                errorEl.style.display = 'block';
            }
        }
        
        function verificarSesion() {
            cargarUsuarios();
            const sesion = sessionStorage.getItem('sistemaFinanciero_sesion');
            if (sesion) {
                const user = JSON.parse(sesion);
                // Verificar que el usuario aÃºn existe y estÃ¡ activo
                const userActual = usuarios.find(u => u.id === user.id && u.activo);
                if (userActual) {
                    usuarioActual = userActual;
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    document.getElementById('nombreUsuarioActual').textContent = userActual.nombre;
                    init();
                    return true;
                }
            }
            return false;
        }
        
        function cerrarSesion() {
            if (confirm('Â¿Cerrar sesiÃ³n?')) {
                sessionStorage.removeItem('sistemaFinanciero_sesion');
                usuarioActual = null;
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('loginUsuario').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
            }
        }
        
        function mostrarMenuUsuario() {
            const opciones = usuarioActual.rol === 'admin' 
                ? '1. Ver mi perfil\n2. Administrar usuarios\n3. Cerrar sesiÃ³n'
                : '1. Ver mi perfil\n2. Cerrar sesiÃ³n';
            
            const opcion = prompt('ğŸ‘¤ ' + usuarioActual.nombre + ' (' + usuarioActual.rol + ')\n\n' + opciones + '\n\nIngresa el nÃºmero:');
            
            if (opcion === '1') {
                alert('ğŸ‘¤ PERFIL DE USUARIO\n\nNombre: ' + usuarioActual.nombre + '\nUsuario: ' + usuarioActual.usuario + '\nRol: ' + usuarioActual.rol + '\nPermisos: ' + usuarioActual.permisos.length + ' ventanas');
            } else if (opcion === '2' && usuarioActual.rol === 'admin') {
                cambiarTab('usuarios');
            } else if ((opcion === '2' && usuarioActual.rol !== 'admin') || opcion === '3') {
                cerrarSesion();
            }
        }
        
        function tienePermiso(ventanaId) {
            if (!usuarioActual) return false;
            if (usuarioActual.rol === 'admin') return true;
            return usuarioActual.permisos.includes(ventanaId);
        }
        
        function mostrarPanelUsuarios() {
            if (usuarioActual.rol !== 'admin') {
                document.getElementById('panelUsuarios').innerHTML = '<div class="alert alert-danger">â›” No tienes permisos para acceder a esta secciÃ³n</div>';
                return;
            }
            
            let html = `
                <div class="section">
                    <h3>â• Crear Nuevo Usuario</h3>
                    <div class="grid-4">
                        <div>
                            <label>Nombre completo:</label>
                            <input type="text" id="nuevoNombre" placeholder="Ej: Juan PÃ©rez">
                        </div>
                        <div>
                            <label>Usuario:</label>
                            <input type="text" id="nuevoUsuario" placeholder="Ej: jperez">
                        </div>
                        <div>
                            <label>ContraseÃ±a:</label>
                            <input type="password" id="nuevoPassword" placeholder="MÃ­nimo 4 caracteres">
                        </div>
                        <div>
                            <label>Rol:</label>
                            <select id="nuevoRol">
                                <option value="usuario">ğŸ‘¤ Usuario</option>
                                <option value="admin">ğŸ‘‘ Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 15px;">ğŸ” Permisos de Ventanas:</h4>
                    <div class="grid-2" style="margin-top: 10px;">
                        <button class="btn btn-info btn-sm" onclick="seleccionarTodosPermisos(true)">âœ… Seleccionar Todos</button>
                        <button class="btn btn-warning btn-sm" onclick="seleccionarTodosPermisos(false)">âŒ Deseleccionar Todos</button>
                    </div>
                    <div class="permisos-grid" id="permisosNuevoUsuario">
            `;
            
            todasLasVentanas.forEach(v => {
                if (v.id !== 'usuarios') { // El panel de usuarios solo para admins
                    html += `
                        <div class="permiso-item">
                            <input type="checkbox" id="perm_nuevo_${v.id}" checked>
                            <label for="perm_nuevo_${v.id}">${v.nombre}</label>
                        </div>
                    `;
                }
            });
            
            html += `
                    </div>
                    <button class="btn btn-success" onclick="crearUsuario()" style="margin-top: 15px;">âœ… Crear Usuario</button>
                </div>
                
                <div class="section">
                    <h3>ğŸ‘¥ Usuarios Registrados (${usuarios.length})</h3>
            `;
            
            usuarios.forEach((u, idx) => {
                const esAdmin = u.rol === 'admin';
                const permisosTexto = esAdmin ? 'Todos (Admin)' : u.permisos.length + ' ventanas';
                
                html += `
                    <div class="usuario-card ${esAdmin ? 'admin' : ''}">
                        <h4>
                            ${esAdmin ? 'ğŸ‘‘' : 'ğŸ‘¤'} ${u.nombre}
                            <span class="rol-badge ${esAdmin ? 'admin' : ''}">${u.rol}</span>
                            ${u.activo ? '<span style="color: #28a745; font-size: 12px;">â— Activo</span>' : '<span style="color: #dc3545; font-size: 12px;">â— Inactivo</span>'}
                        </h4>
                        <p style="color: #666; font-size: 13px;">Usuario: <b>${u.usuario}</b> | Permisos: ${permisosTexto}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-info btn-sm" onclick="editarUsuario(${u.id})">âœï¸ Editar</button>
                            <button class="btn btn-warning btn-sm" onclick="cambiarPasswordUsuario(${u.id})">ğŸ”‘ Cambiar ContraseÃ±a</button>
                            ${u.id !== 1 ? `<button class="btn btn-${u.activo ? 'danger' : 'success'} btn-sm" onclick="toggleActivoUsuario(${u.id})">${u.activo ? 'ğŸš« Desactivar' : 'âœ… Activar'}</button>` : ''}
                            ${u.id !== 1 ? `<button class="btn btn-danger btn-sm" onclick="eliminarUsuario(${u.id})">ğŸ—‘ï¸ Eliminar</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('panelUsuarios').innerHTML = html;
        }
        
        function seleccionarTodosPermisos(seleccionar) {
            todasLasVentanas.forEach(v => {
                const checkbox = document.getElementById('perm_nuevo_' + v.id);
                if (checkbox) checkbox.checked = seleccionar;
            });
        }
        
        function crearUsuario() {
            const nombre = document.getElementById('nuevoNombre').value.trim();
            const usuario = document.getElementById('nuevoUsuario').value.trim().toLowerCase();
            const password = document.getElementById('nuevoPassword').value;
            const rol = document.getElementById('nuevoRol').value;
            
            if (!nombre || !usuario || !password) {
                notif('âš ï¸ Completa todos los campos', 'warning');
                return;
            }
            
            if (password.length < 4) {
                notif('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres', 'warning');
                return;
            }
            
            if (usuarios.find(u => u.usuario.toLowerCase() === usuario)) {
                notif('âš ï¸ El usuario ya existe', 'warning');
                return;
            }
            
            // Obtener permisos seleccionados
            const permisos = [];
            todasLasVentanas.forEach(v => {
                const checkbox = document.getElementById('perm_nuevo_' + v.id);
                if (checkbox && checkbox.checked) {
                    permisos.push(v.id);
                }
            });
            
            if (rol === 'admin') {
                // Admin tiene todos los permisos
                permisos.length = 0;
                todasLasVentanas.forEach(v => permisos.push(v.id));
            }
            
            const nuevoId = Math.max(...usuarios.map(u => u.id)) + 1;
            
            usuarios.push({
                id: nuevoId,
                usuario: usuario,
                password: password,
                nombre: nombre,
                rol: rol,
                permisos: permisos,
                activo: true,
                fechaCreacion: new Date().toISOString()
            });
            
            guardarUsuarios();
            mostrarPanelUsuarios();
            notif('âœ… Usuario "' + nombre + '" creado correctamente', 'success');
            
            // Limpiar campos
            document.getElementById('nuevoNombre').value = '';
            document.getElementById('nuevoUsuario').value = '';
            document.getElementById('nuevoPassword').value = '';
        }
        
        function editarUsuario(id) {
            const user = usuarios.find(u => u.id === id);
            if (!user) return;
            
            let permisosHTML = '';
            todasLasVentanas.forEach(v => {
                if (v.id !== 'usuarios') {
                    const checked = user.permisos.includes(v.id) ? 'checked' : '';
                    permisosHTML += `<div style="display: inline-block; margin: 3px;"><input type="checkbox" id="edit_perm_${v.id}" ${checked}> ${v.nombre}</div><br>`;
                }
            });
            
            const nuevoNombre = prompt('Nombre:', user.nombre);
            if (nuevoNombre === null) return;
            
            const nuevoRol = prompt('Rol (admin/usuario):', user.rol);
            if (nuevoRol === null) return;
            
            // Para los permisos usamos un enfoque diferente
            const editarPermisos = confirm('Â¿Deseas editar los permisos de ventanas?\n\nSi presionas "Aceptar" te mostrarÃ© las ventanas una por una.\nSi presionas "Cancelar" se mantienen los permisos actuales.');
            
            let nuevosPermisos = [...user.permisos];
            
            if (editarPermisos && nuevoRol !== 'admin') {
                nuevosPermisos = [];
                for (const v of todasLasVentanas) {
                    if (v.id !== 'usuarios') {
                        const tieneActual = user.permisos.includes(v.id);
                        const dar = confirm(`Â¿Dar acceso a "${v.nombre}"?\n\n(Actualmente: ${tieneActual ? 'SÃ tiene acceso' : 'NO tiene acceso'})`);
                        if (dar) nuevosPermisos.push(v.id);
                    }
                }
            } else if (nuevoRol === 'admin') {
                nuevosPermisos = todasLasVentanas.map(v => v.id);
            }
            
            user.nombre = nuevoNombre || user.nombre;
            user.rol = (nuevoRol === 'admin' || nuevoRol === 'usuario') ? nuevoRol : user.rol;
            user.permisos = nuevosPermisos;
            
            guardarUsuarios();
            mostrarPanelUsuarios();
            notif('âœ… Usuario actualizado', 'success');
        }
        
        function cambiarPasswordUsuario(id) {
            const user = usuarios.find(u => u.id === id);
            if (!user) return;
            
            const nueva = prompt('Nueva contraseÃ±a para ' + user.nombre + ':');
            if (nueva && nueva.length >= 4) {
                user.password = nueva;
                guardarUsuarios();
                notif('âœ… ContraseÃ±a actualizada', 'success');
            } else if (nueva) {
                notif('âš ï¸ La contraseÃ±a debe tener al menos 4 caracteres', 'warning');
            }
        }
        
        function toggleActivoUsuario(id) {
            const user = usuarios.find(u => u.id === id);
            if (!user || user.id === 1) return;
            
            user.activo = !user.activo;
            guardarUsuarios();
            mostrarPanelUsuarios();
            notif(user.activo ? 'âœ… Usuario activado' : 'ğŸš« Usuario desactivado', 'success');
        }
        
        function eliminarUsuario(id) {
            if (id === 1) {
                notif('âš ï¸ No puedes eliminar al administrador principal', 'warning');
                return;
            }
            
            const user = usuarios.find(u => u.id === id);
            if (!user) return;
            
            if (confirm('Â¿Eliminar al usuario "' + user.nombre + '"?\n\nEsta acciÃ³n no se puede deshacer.')) {
                usuarios = usuarios.filter(u => u.id !== id);
                guardarUsuarios();
                mostrarPanelUsuarios();
                notif('âœ… Usuario eliminado', 'success');
            }
        }

        function init() {
            // Definir todas las tabs
            const todasLasTabs = [
                { id: 'carga', n: 'ğŸ“ Carga' },
                { id: 'dash', n: 'ğŸ“Š Dashboard' },
                { id: 'ingresos', n: 'ğŸ’° Ingresos' },
                { id: 'gastosFijos', n: 'ğŸ“ˆ Gastos' },
                { id: 'gastosDetalle', n: 'ğŸ“‹ Detalle' },
                { id: 'comprasView', n: 'ğŸ›’ Compras' },
                { id: 'clientes', n: 'ğŸ‘¥ Clientes' },
                { id: 'proveedores', n: 'ğŸ­ Proveed' },
                { id: 'puntoEquilibrio', n: 'âš–ï¸ P.Equilib' },
                { id: 'cajas', n: 'ğŸ¦ Cajas' },
                { id: 'movimientos', n: 'ğŸ’± Movim' },
                { id: 'alertas', n: 'ğŸ”” Alertas' },
                { id: 'graficos', n: 'ğŸ“‰ GrÃ¡ficos' },
                { id: 'proyecciones', n: 'ğŸ”® Proyecc' },
                { id: 'cashflow', n: 'ğŸ’¹ Cash Flow' },
                { id: 'ahorros', n: 'ğŸ· Ahorros/IOL' },
                { id: 'asistente', n: 'ğŸ¤– IA' },
                { id: 'empleados', n: 'ğŸ‘” Personal' },
                { id: 'recordatorios', n: 'ğŸ“… Record' },
                { id: 'estadoResultados', n: 'ğŸ“Š Est.Result' },
                { id: 'estadoFinanciero', n: 'ğŸ’¹ Cash Flow' },
                { id: 'rentabilidad', n: 'ğŸ“ˆ Rentabilidad' },
                { id: 'comparativo', n: 'ğŸ“Š Comparativo' },
                { id: 'backup', n: 'ğŸ’¾ Backup' },
                { id: 'usuarios', n: 'ğŸ‘¥ Usuarios' },
                { id: 'configuracion', n: 'âš™ï¸ Config' }
            ];
            
            // Filtrar tabs segÃºn permisos del usuario
            const tabs = todasLasTabs.filter(t => tienePermiso(t.id));
            
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            
            tabs.forEach(function(t, i) {
                const btn = document.createElement('button');
                btn.className = 'tab' + (t.id === 'dash' ? ' active' : '');
                btn.textContent = t.n;
                btn.addEventListener('click', function() {
                    cambiarTab(t.id);
                });
                tabsContainer.appendChild(btn);
            });
            
            renderContent();
            cargarDatos();
            
            // Ir al dashboard por defecto (o primera tab disponible)
            const primeraTab = tabs.find(t => t.id === 'dash') || tabs[0];
            if (primeraTab) cambiarTab(primeraTab.id);
        }

        // Al cargar la pÃ¡gina, verificar sesiÃ³n
        window.onload = function() {
            if (!verificarSesion()) {
                // No hay sesiÃ³n activa, mostrar login
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        };
    </script>



</body></html>
